---
highlight: a11y-dark
---



<div align=center><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d9a42b143ac45868bf3f2813dcb99f3~tplv-k3u1fbpfcp-zoom-1.image" width="100%" referrerpolicy="no-referrer"></div>



> æºæ‰‹åˆ›ä½œï¼Œå…±åŒæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 8 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬12å¤©ï¼Œ[ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…](https://juejin.cn/post/7123120819437322247)


> - ğŸ’¡ ä½œè€…ï¼š[éŸ©ä¿¡å­](https://github.com/HanXinzi-AI)@[ShowMeAI](https://www.showmeai.tech/)
> - ğŸ“˜ [æ•°æ®åˆ†æâ—‰æŠ€èƒ½æå‡ç³»åˆ—](https://www.showmeai.tech/tutorials/33)ï¼š[https://www.showmeai.tech/tutorials/33](https://www.showmeai.tech/tutorials/33)
> - ğŸ“˜ [AI é¢è¯•é¢˜åº“ç³»åˆ—](https://www.showmeai.tech/tutorials/48)ï¼š[https://www.showmeai.tech/tutorials/48](https://www.showmeai.tech/tutorials/48)
> - ğŸ“˜ [æœ¬æ–‡åœ°å€](https://www.showmeai.tech/article-detail/297)ï¼š[https://www.showmeai.tech/article-detail/297](https://www.showmeai.tech/article-detail/297)
> - ğŸ“¢ å£°æ˜ï¼šç‰ˆæƒæ‰€æœ‰ï¼Œè½¬è½½è¯·è”ç³»å¹³å°ä¸ä½œè€…å¹¶æ³¨æ˜å‡ºå¤„
> - ğŸ“¢ æ”¶è—[ShowMeAI](https://www.showmeai.tech/)æŸ¥çœ‹æ›´å¤šç²¾å½©å†…å®¹
 

ä¸‹é¢æ˜¯æœ€æ–°çš„ 3 é“ Google SQL é¢è¯•é¢˜å’Œå‚è€ƒç­”æ¡ˆã€‚è¿™äº›é¢˜ç›®é¢å‘çš„ Google èŒä½åŒ…æ‹¬ï¼š**æ•°æ®ç§‘å­¦** **å®¶**ã€**æ•°æ®åˆ†æå¸ˆ**ã€**å•†ä¸šæ™ºèƒ½** **å·¥ç¨‹å¸ˆ**ã€**æ•°æ®å·¥ç¨‹å¸ˆ**å’Œ**å•†ä¸šåˆ†æå¸ˆ**ã€‚


<div align=center><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ecaea49dcd264479ab3c47389110ba3c~tplv-k3u1fbpfcp-zoom-1.image" width="100%" referrerpolicy="no-referrer"></div>



> [ShowMeAI](https://www.showmeai.tech/) åˆ¶ä½œäº†å¿«æ·å³æŸ¥å³ç”¨çš„ SQL é€ŸæŸ¥è¡¨æ‰‹å†Œï¼Œå¤§å®¶å¯ä»¥åœ¨ä¸‹è¿°ä½ç½®è·å¾—ï¼š
> - [**ç¼–ç¨‹è¯­è¨€é€ŸæŸ¥è¡¨ | SQL é€ŸæŸ¥è¡¨**](https://www.showmeai.tech/article-detail/99)

# ğŸ’¡ é¢è¯•é¢˜ 1ï¼šå¢¨è¥¿å“¥å’Œç¾å›½ç¬¬ä¸‰é«˜å³°

<div align=center><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b41c1af6e90f4140991c058a8cf1c815~tplv-k3u1fbpfcp-zoom-1.image" width="100%" referrerpolicy="no-referrer"></div>



é—®é¢˜ï¼š è¯·å®Œæˆ1ä¸ª SQL æ¥æ‰¾å‡ºæ¯ä¸ªå›½å®¶ç¬¬ä¸‰é«˜çš„å±±åï¼Œå¹¶æŒ‰ ASC é¡ºåºå¯¹å›½å®¶/åœ°åŒºæ’åºã€‚

```sql
Table: mountains
+---------------------+------+-------------+
|name                 |height|country      |
+---------------------+------+-------------+
|Denalli              |20310 |United States|
|Saint Elias          |18008 |United States|
|Foraker              |17402 |United States|
|Pico de Orizab       |18491 |Mexico       |
|PopocatÃ©petl         |17820 |Mexico       |
|Iztaccihuatl         |17160 |Mexico       |
+---------------------+------+-------------+
```

å‚è€ƒç­”æ¡ˆï¼š

```sql
SELECT "country",
       "name"
FROM   (SELECT "country",
               "name",
               Rank()
                 OVER (
                   partition BY "country"
                   ORDER BY "height" DESC) AS "rank"
        FROM   mountains) AS m
WHERE  "rank" = 3
ORDER  BY country ASC 
```

# ğŸ’¡ é¢è¯•é¢˜ 2ï¼šç”¨ latest_event æŸ¥æ‰¾å½“å‰æ‰“å¼€çš„é¡µæ•°

<div align=center><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78959118a3624620806092cbb721b354~tplv-k3u1fbpfcp-zoom-1.image" width="100%" referrerpolicy="no-referrer"></div>



é—®é¢˜ï¼š ç»™å®šä¸‹è¡¨ï¼Œè¡¨ä¸­åŒ…å«æœ‰å…³é¡µé¢çŠ¶æ€æ›´æ”¹æ—¶é—´çš„ä¿¡æ¯ã€‚å®Œæˆ SQL æŸ¥æ‰¾å½“å‰ä½¿ç”¨ `latest_event` çš„é¡µé¢æ•°ã€‚ æ³¨æ„ï¼Œè¡¨ä¸­ `page_flag` åˆ—å°†ç”¨äºè¯†åˆ«é¡µé¢æ˜¯ã€OFFã€è¿˜æ˜¯ã€ONã€ã€‚

```sql
Table: pages_info
+-------+--------------------------------------+----------+
|page_id|event_time                            |page_flag |
+-------+--------------------------------------+----------+
|1      |current_timestamp - interval '6 hours'|ON        |
|1      |current_timestamp - interval '3 hours'|OFF       |
|1      |current_timestamp - interval '1 hours'|ON        |
|2      |current_timestamp - interval '3 hours'|ON        |
|2      |current_timestamp - interval '1 hours'|OFF       |
|3      |current_timestamp                     |ON        |
+-------+--------------------------------------+----------+
```

å‚è€ƒç­”æ¡ˆï¼š

```sql
-- é¦–å…ˆï¼Œå¯¹äºæ¯ä¸ªé¡µé¢IDï¼Œè®©æˆ‘ä»¬é€‰æ‹©æœ€æ–°çš„è®°å½•ï¼ˆåŸºäºäº‹ä»¶æ—¶é—´åˆ—ï¼‰ã€‚
SELECT page_id,
       Max(event_time) AS latest_event
FROM   pages_info
GROUP  BY page_id 

-- æ¥ç€ï¼Œæˆ‘ä»¬å°†å‰é¢çš„æŸ¥è¯¢ä¸åŸè¡¨è¿æ¥èµ·æ¥ï¼Œå¹¶æ£€æŸ¥å…¶ä¸­æœ‰å¤šå°‘äººçš„æ ‡è®°é¡µç­‰äºONã€‚
WITH latest_event
     AS (SELECT page_id,
                Max(event_time) AS latest_event
         FROM   pages_info
         GROUP  BY page_id)
SELECT Sum(CASE
             WHEN page_flag = 'ON' THEN 1
             ELSE 0
           END) AS result
FROM   pages_info pi
       JOIN latest_event le
         ON pi.page_id = le.page_id
            AND pi.event_time = le.latest_event; 
```

# ğŸ’¡ é¢è¯•é¢˜ 3ï¼šå›è®¿ç”¨æˆ·

<div align=center><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e66852eaa8fd4767a2449283546c0b80~tplv-k3u1fbpfcp-zoom-1.image" width="100%" referrerpolicy="no-referrer"></div>


é—®é¢˜ï¼š åœ¨å¦‚ä¸‹çš„æ•°æ®åº“è¡¨ä¸­ï¼ŒåŒ…å«æœ‰å…³ç”¨æˆ·è®¿é—®ç½‘é¡µçš„ä¿¡æ¯ã€‚ å®Œæˆ SQL è¿”å›è¿ç»­è®¿é—®è¯¥é¡µé¢æœ€é•¿çš„ 3 ä¸ªç”¨æˆ·ï¼ŒæŒ‰é•¿çŸ­çš„å€’åºæ’åˆ— 3 ä¸ªç”¨æˆ·ã€‚

```sql
Table: visits
+--------+----------------------------+
|user_id |date                        | 
+--------+----------------------------+
|1       |current_timestamp::DATE - 0 |
|1       |current_timestamp::DATE - 1 |
|1       |current_timestamp::DATE - 2 |
|1       |current_timestamp::DATE - 3 |
|1       |current_timestamp::DATE - 4 |
|2       |current_timestamp::DATE - 1 |
|4       |current_timestamp::DATE - 0 |
|4       |current_timestamp::DATE - 1 |
|4       |current_timestamp::DATE - 3 |
|4       |current_timestamp::DATE - 4 |
|4       |current_timestamp::DATE - 62|   
+--------+----------------------------+
```

å‚è€ƒç­”æ¡ˆï¼š

```sql
--é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°çš„åˆ—ï¼Œå…¶å€¼æ˜¯æ¯ä¸ªç”¨æˆ·çš„ä¸‹ä¸€æ¬¡è®¿é—®ï¼ˆä¸å½“å‰æ—¥æœŸä¸åŒï¼‰ã€‚æˆ‘ä»¬å°†ä½¿ç”¨leadå‡½æ•°æ¥å®Œæˆ:
SELECT DISTINCT user_id,
                date,
                Lead(date)
                  OVER (
                    partition BY user_id
                    ORDER BY date) AS next_date
FROM   (SELECT DISTINCT *
        FROM   visits) AS t; 
--æ¥ç€ï¼Œè®©æˆ‘ä»¬åˆ›å»ºå¦ä¸€ä¸ªåˆ—ï¼Œå…¶ç›®çš„æ˜¯è®©æˆ‘ä»¬çŸ¥é“è®¿é—®çš„åœæ­¢ã€‚è¿™åŒ…æ‹¬æ£€æŸ¥ä¸‹ä¸€ä¸ªæ—¥æœŸæ˜¯å¦ä¸å½“å‰æ—¥æœŸ+1æ˜¯å¦ä¸åŒã€‚
WITH next_dates
     AS (SELECT DISTINCT user_id,
                         date,
                         Lead(date)
                           OVER (
                             partition BY user_id
                             ORDER BY date) AS next_date
         FROM   (SELECT DISTINCT *
                 FROM   visits) AS t) --å»é‡
SELECT user_id,
       date,
       next_date,
       CASE
         WHEN next_date IS NULL
               OR next_date = date + 1 THEN 1
         ELSE NULL
       END AS streak
FROM   next_dates; 
--æ¥ç€ï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºä»£è¡¨ä¸€ä¸ªè¿ç»­çš„è®¿é—®ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯ï¼Œå¯¹äºæ¯ä¸ªç”¨æˆ·ï¼Œå–æœ€è¿‘çš„è®°å½•ï¼ˆåŸºäºæ—¥æœŸï¼‰å¹¶èµ‹å€¼ä¸º0ï¼Œç„¶åå¯»æ‰¾ä¸‹é¢çš„è®°å½•ï¼Œå¦‚æœè®¿é—®æ²¡æœ‰åœæ­¢å°±èµ‹å€¼ä¸º0ï¼Œå¦‚æœè®¿é—®åœæ­¢å°±èµ‹å€¼ä¸º1ï¼ˆå¦‚æœè¿èƒœåˆ—ä¸ºç©ºï¼‰ï¼Œç„¶åç»§ç»­è¿™æ ·åšï¼Œç›´åˆ°æ¯ä¸ªè¿ç»­è®¿é—®è¢«ä¸€ä¸ªä¸åŒçš„åˆ†åŒºæ‰€ä»£è¡¨ã€‚æ‰§è¡Œè¿™ä¸€é€»è¾‘çš„ä»£ç å¦‚ä¸‹ã€‚
WITH next_dates
     AS (SELECT DISTINCT user_id,
                         date,
                         Lead(date)
                           OVER (
                             partition BY user_id
                             ORDER BY date) AS next_date
         FROM   (SELECT DISTINCT *
                 FROM   visits)),
     streaks
     AS (SELECT user_id,
                date,
                next_date,
                CASE
                  WHEN next_date IS NULL
                        OR next_date = date + 1 THEN 1
                  ELSE NULL
                END AS streak
         FROM   next_dates)
SELECT *,
       Sum(CASE
             WHEN streak IS NULL THEN 1
             ELSE 0
           END)
         OVER (
           partition BY user_id
           ORDER BY date) AS partition
FROM   streaks; 
--ä¸€æ—¦æˆ‘ä»¬æœ‰äº†è¿™ä¸ªåˆ†åŒºï¼Œé—®é¢˜å°±å®¹æ˜“äº†ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦è®¡ç®—æ¯ä¸ªç”¨æˆ·å’Œåˆ†åŒºçš„è®°å½•æ•°ï¼Œå¹¶æ‰¾åˆ°è®¡æ•°æœ€å¤šçš„ç”¨æˆ·ã€‚å®Œæ•´çš„æŸ¥è¯¢å¦‚ä¸‹
WITH next_dates AS
(
                SELECT DISTINCT user_id,
                                date,
                                Lead(date) OVER (partition BY user_id ORDER BY date) AS next_date
                FROM            visits ), streaks AS
(
       SELECT user_id,
              date,
              next_date,
              CASE
                     WHEN next_date IS NULL
                     OR     next_date = date + 1 THEN 1
                     ELSE NULL
              END AS streak
       FROM   next_dates ), partitions AS
(
         SELECT   *,
                  Sum(
                  CASE
                           WHEN streak IS NULL THEN 1
                           ELSE 0
                  END ) OVER (partition BY user_id ORDER BY date) AS partition
         FROM     streaks ), count_partitions AS
(
         SELECT   user_id,
                  partition,
                  Count(1) AS streak_days
         FROM     partitions
         GROUP BY user_id,
                  partition )
SELECT   user_id,
         Max(streak_days) AS longest_streak
FROM     count_partitions
GROUP BY user_id
ORDER BY 2 DESC limit 3;
```

# å‚è€ƒèµ„æ–™

- ğŸ“˜ **ç¼–ç¨‹è¯­è¨€é€ŸæŸ¥è¡¨ | SQL é€ŸæŸ¥è¡¨**ï¼š[https://www.showmeai.tech/article-detail/99](https://www.showmeai.tech/article-detail/99)
