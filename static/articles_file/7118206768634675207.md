从零开始搭建一个项目骨架，最好选择合适熟悉的技术，并且在未来易拓展，适合微服务化体系等。所以一般以Springboot作为我们的框架基础，这是离不开的了。

然后数据层，我们常用的是Mybatis，易上手，方便维护。但是单表操作比较困难，特别是添加字段或减少字段的时候，比较繁琐，所以这里我推荐使用Mybatis Plus( <https://mp.baomidou.com/> )，为简化开发而生，只需简单配置，即可快速进行CRUD操作，从而节省大量时间。

SpringSecurity，使用security作为我们的权限控制和会话控制的框架。

-   SpringBoot
-   mybatis plus
-   spring security
-   lombok
-   redis
-   hibernate validatior
-   jwt

## 二、新建SpringBoot 项目，注意版本

### 1、新建SpringBoot工程

这里，我们使用IDEA来开发我们项目

开发工具与环境:

idea

mysql

jdk 8

maven3.3.9

新建SpringBoot

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/108d9e51ad1f4ee3b068fe512a913677~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/507702cf09a3406bb259f169489ecb50~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b60418494f84c8890bbd737e7b66323~tplv-k3u1fbpfcp-zoom-1.image)

删除部分内容

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f670f00a044a475ebfc6326f1aa6d186~tplv-k3u1fbpfcp-zoom-1.image)

### 2、整合MyBatis plus，生成代码

#### （1）引入依赖

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e5f9bc0b0e14e4293289f3f1d43ebe4~tplv-k3u1fbpfcp-zoom-1.image)

```
<!--整合mybatis plus https://baomidou.com/-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.4.1</version>
        </dependency>
        <!--mp代码生成器-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-generator</artifactId>
            <version>3.4.1</version>
        </dependency>
        <dependency>
            <groupId>org.freemarker</groupId>
            <artifactId>freemarker</artifactId>
            <version>2.3.30</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>
```

#### （2）设置配置文件

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a199acb7e7b34db2ab04c895b590ecaa~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f836fa3936704f2bb8789c1ae7ccf7ac~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0577063a884489e8c80882a812ded8e~tplv-k3u1fbpfcp-zoom-1.image)

```
server:
  port: 8081
# DataSource Config
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/zhengadminvue?useUnicode=true&useSSL=false&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: root
mybatis-plus:
  mapper-locations: classpath*:/mapper/**Mapper.xml
```

新建一个包：通过@mapperScan注解指定要变成实现类的接口所在的包，然后包下面的所有接口在编译之后都会生成相应的实现类。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bda88effa07f41b08d3d27de8df4b7f9~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ffb0179ff0a4640a4527711845fe5a1~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18a5d1b1a9b046d5a52299b15fa5ecf0~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0cba1d39d0944b30b09d391b06b746f2~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7793232d7437492f9ae07560c7f53b70~tplv-k3u1fbpfcp-zoom-1.image)

```
@Configuration
@ManagedBean("cn.itbluebox.springbootadminvue.mapper")
public class MybatisPlusConfig {
 
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor(){
 
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        //分页插件
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor());
        //防止全表更新插件
        interceptor.addInnerInterceptor(new BlockAttackInnerInterceptor());
        return interceptor;
    }

    @Bean
    public ConfigurationCustomizer configurationCustomizer() {
 
        return configuration -> configuration.setUseDeprecatedExecutor(false);
    }

}
```

创建对应的mapper文件

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec388a360b1248e2bdad790daf365d7a~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/180f243090264712a78f47f71a6438ca~tplv-k3u1fbpfcp-zoom-1.image)

#### （3）创建数据库和表

SQL语句

```
DROP TABLE IF EXISTS `sys_menu`;
CREATE TABLE `sys_menu` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `parent_id` bigint(20) DEFAULT NULL COMMENT '父菜单ID，一级菜单为0',
  `name` varchar(64) NOT NULL,
  `path` varchar(255) DEFAULT NULL COMMENT '菜单URL',
  `perms` varchar(255) DEFAULT NULL COMMENT '授权(多个用逗号分隔，如：user:list,user:create)',
  `component` varchar(255) DEFAULT NULL,
  `type` int(5) NOT NULL COMMENT '类型     0：目录   1：菜单   2：按钮',
  `icon` varchar(32) DEFAULT NULL COMMENT '菜单图标',
  `orderNum` int(11) DEFAULT NULL COMMENT '排序',
  `created` datetime NOT NULL,
  `updated` datetime DEFAULT NULL,
  `statu` int(5) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=21 DEFAULT CHARSET=utf8;
-- ----------------------------
-- Table structure for sys_role
-- ----------------------------
DROP TABLE IF EXISTS `sys_role`;
CREATE TABLE `sys_role` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(64) NOT NULL,
  `code` varchar(64) NOT NULL,
  `remark` varchar(64) DEFAULT NULL COMMENT '备注',
  `created` datetime DEFAULT NULL,
  `updated` datetime DEFAULT NULL,
  `statu` int(5) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`) USING BTREE,
  UNIQUE KEY `code` (`code`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8;
-- ----------------------------
-- Table structure for sys_role_menu
-- ----------------------------
DROP TABLE IF EXISTS `sys_role_menu`;
CREATE TABLE `sys_role_menu` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `role_id` bigint(20) NOT NULL,
  `menu_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=102 DEFAULT CHARSET=utf8mb4;
-- ----------------------------
-- Table structure for sys_user
-- ----------------------------
DROP TABLE IF EXISTS `sys_user`;
CREATE TABLE `sys_user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `username` varchar(64) DEFAULT NULL,
  `password` varchar(64) DEFAULT NULL,
  `avatar` varchar(255) DEFAULT NULL,
  `email` varchar(64) DEFAULT NULL,
  `city` varchar(64) DEFAULT NULL,
  `created` datetime DEFAULT NULL,
  `updated` datetime DEFAULT NULL,
  `last_login` datetime DEFAULT NULL,
  `statu` int(5) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `UK_USERNAME` (`username`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;
-- ----------------------------
-- Table structure for sys_user_role
-- ----------------------------
DROP TABLE IF EXISTS `sys_user_role`;
CREATE TABLE `sys_user_role` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) NOT NULL,
  `role_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4;
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ec9a5a2ba0e491dbecbe9bab7756285~tplv-k3u1fbpfcp-zoom-1.image)

#### （4）代码生成

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63aefc811fd94215ac15af6596c0f662~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/147e9fc903ac442db5e2d15eb9509ad3~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd3c56cd85144e558e97aee3323c5783~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue;
import com.baomidou.mybatisplus.core.exceptions.MybatisPlusException;
import com.baomidou.mybatisplus.core.toolkit.StringPool;
import com.baomidou.mybatisplus.core.toolkit.StringUtils;
import com.baomidou.mybatisplus.generator.AutoGenerator;
import com.baomidou.mybatisplus.generator.InjectionConfig;
import com.baomidou.mybatisplus.generator.config.*;
import com.baomidou.mybatisplus.generator.config.po.TableInfo;
import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;
import com.baomidou.mybatisplus.generator.engine.FreemarkerTemplateEngine;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

// 演示例子，执行 main 方法控制台输入模块表名回车自动生成对应项目目录中
public class CodeGenerator {
 
    /**
     * <p>
     * 读取控制台内容
     * </p>
     */
    public static String scanner(String tip) {
 
        Scanner scanner = new Scanner(System.in);
        StringBuilder help = new StringBuilder();
        help.append("请输入" + tip + "：");
        System.out.println(help.toString());
        if (scanner.hasNext()) {
 
            String ipt = scanner.next();
            if (StringUtils.isNotBlank(ipt)) {
 
                return ipt;
            }
        }
        throw new MybatisPlusException("请输入正确的" + tip + "！");
    }

    public static void main(String[] args) {
 
        // 代码生成器
        AutoGenerator mpg = new AutoGenerator();

        // 全局配置
        GlobalConfig gc = new GlobalConfig();
        String projectPath = System.getProperty("user.dir");
        gc.setOutputDir(projectPath + "/src/main/java");
        gc.setAuthor("itbluebox");
        gc.setOpen(false);
        // gc.setSwagger2(true); 实体属性 Swagger2 注解
        gc.setServiceName("%sService");
        mpg.setGlobalConfig(gc);

        // 数据源配置
        DataSourceConfig dsc = new DataSourceConfig();
        dsc.setUrl("jdbc:mysql://localhost:3306/itzheng-vue-admin?useUnicode=true&useSSL=false&characterEncoding=utf8&serverTimezone=Asia/Shanghai");
        // dsc.setSchemaName("public");
        dsc.setDriverName("com.mysql.cj.jdbc.Driver");
        dsc.setUsername("root");
        dsc.setPassword("root");
        mpg.setDataSource(dsc);

        // 包配置
        PackageConfig pc = new PackageConfig();
//        pc.setModuleName(scanner("模块名"));
        pc.setParent("cn.itbluebox.springbootadminvue");
        mpg.setPackageInfo(pc);

        // 自定义配置
        InjectionConfig cfg = new InjectionConfig() {
 
            @Override
            public void initMap() {
 
                // to do nothing
            }
        };

        // 如果模板引擎是 freemarker
        String templatePath = "/templates/mapper.xml.ftl";
        // 如果模板引擎是 velocity
//         String templatePath = "/templates/mapper.xml.vm";

        // 自定义输出配置
        List<FileOutConfig> focList = new ArrayList<>();
        // 自定义配置会被优先输出
        focList.add(new FileOutConfig(templatePath) {
 
            @Override
            public String outputFile(TableInfo tableInfo) {
 
                // 自定义输出文件名 ， 如果你 Entity 设置了前后缀、此处注意 xml 的名称会跟着发生变化！！
                return projectPath + "/src/main/resources/mapper/" + pc.getModuleName()
                        + "/" + tableInfo.getEntityName() + "Mapper" + StringPool.DOT_XML;
            }
        });
        /*
        cfg.setFileCreate(new IFileCreate() {
            @Override
            public boolean isCreate(ConfigBuilder configBuilder, FileType fileType, String filePath) {
                // 判断自定义文件夹是否需要创建
                checkDir("调用默认方法创建的目录，自定义目录用");
                if (fileType == FileType.MAPPER) {
                    // 已经生成 mapper 文件判断存在，不想重新生成返回 false
                    return !new File(filePath).exists();
                }
                // 允许生成模板文件
                return true;
            }
        });
        */
        cfg.setFileOutConfigList(focList);
        mpg.setCfg(cfg);

        // 配置模板
        TemplateConfig templateConfig = new TemplateConfig();

        // 配置自定义输出模板
        //指定自定义模板路径，注意不要带上.ftl/.vm, 会根据使用的模板引擎自动识别
        // templateConfig.setEntity("templates/entity2.java");
        // templateConfig.setService();
        // templateConfig.setController();

        templateConfig.setXml(null);
        mpg.setTemplate(templateConfig);

        // 策略配置
        StrategyConfig strategy = new StrategyConfig();
        strategy.setNaming(NamingStrategy.underline_to_camel);
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
        strategy.setSuperEntityClass("BaseEntity");
        strategy.setEntityLombokModel(true);
        strategy.setRestControllerStyle(true);
        // 公共父类
        strategy.setSuperControllerClass("BaseController");
        // 写于父类中的公共字段
        strategy.setSuperEntityColumns("id", "created", "updated", "statu");
        strategy.setInclude(scanner("表名，多个英文逗号分割").split(","));
        strategy.setControllerMappingHyphenStyle(true);
//        strategy.setTablePrefix("sys_");//动态调整
        mpg.setStrategy(strategy);
        mpg.setTemplateEngine(new FreemarkerTemplateEngine());
        mpg.execute();
    }
}
```

1、获取对应项目所有的表和字段的信息

2、新建一个freemarker的页面模板

3、提供相关需要进行渲染的动态数据

```
# 获取表
SELECT
    *
FROM
    information_schema. TABLES
WHERE
    TABLE_SCHEMA = (SELECT DATABASE());
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d00aa2432a64385ad1a23b516f7fdef~tplv-k3u1fbpfcp-zoom-1.image)

```
# 获取字段
SELECT
    *
FROM
    information_schema. COLUMNS
WHERE
    TABLE_SCHEMA = (SELECT DATABASE())
AND TABLE_NAME = "sys_user";
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18f5813b60d346b7833a5de6e5271095~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c62e2438e3a845a89ac82d0045d4cfeb~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/35f91510387a4aca80046d325c73a7f0~tplv-k3u1fbpfcp-zoom-1.image)

```
sys_user_role,sys_user,sys_role_menu,sys_role,sys_menu
```

自动生成代码

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c74488ed8c54f7ab7dbec4e9063b2d8~tplv-k3u1fbpfcp-zoom-1.image)

我们发现实体类和controller报错缺少对应的Bese

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74fbcb8517f94e2fb56ab31dda1d7bf9~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07237a0c33df4982893e4a1fe402cc23~tplv-k3u1fbpfcp-zoom-1.image)

创建BaseEntity

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25c7a1635fa0446094744d24d60ca62c~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f86c7be11aa486481e66f8fb688ad1b~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76ed08d8d2a54a2cb466b8bee650a08c~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Data
public class BaseEntity implements Serializable {
 
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;
    private LocalDateTime created;
    private LocalDateTime updated;
    private Integer statu;
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85ab5f395acd44b6ab33713dbc5df01e~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56e5aa446c864db7948712b6a6217408~tplv-k3u1fbpfcp-zoom-1.image)

注意每一个Controller的引入

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dae941b4495644bda0ec4a3516b21844~tplv-k3u1fbpfcp-zoom-1.image)

#### （5）编写测试方法

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b53d6b8bb6b7463dafbc7f126a512ce1~tplv-k3u1fbpfcp-zoom-1.image)

```
/**
 * <p>
 *  前端控制器
 * </p>
 *
 * @author itbluebox
 * @since 2022-05-26
 */
@RestController
@RequestMapping("/sys-user")
public class SysUserController extends BaseController {
 

    @Autowired
    private SysUserService sysUserService;

    @GetMapping("list")
    public List<SysUser> getUserList(){
 
        List<SysUser> list = sysUserService.list(new QueryWrapper<>(null));
        return  list;
    }

}
```

在启动类上设置对应的mapper扫描

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da9a50f141b441bc94b8e175580647df~tplv-k3u1fbpfcp-zoom-1.image)

```
@SpringBootApplication
@MapperScan("cn.itbluebox.springbootadminvue.mapper")
public class SpringbootAdminvueApplication {
 
    public static void main(String[] args) {
 
        SpringApplication.run(SpringbootAdminvueApplication.class, args);
    }
}
```

启动项目

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e46c78bbdaa647218b2acd741a1b02e0~tplv-k3u1fbpfcp-zoom-1.image)

访问接口

<http://localhost:8081/sys-user/list>

访问成功

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1793f77960ac4e6c96b73bb39ee36184~tplv-k3u1fbpfcp-zoom-1.image)

在数据库当中添加一些数据

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b4889b4999d4d59b791db675ce817b9~tplv-k3u1fbpfcp-zoom-1.image)

刷新页面

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba037e293370435ea5559879cf669e4d~tplv-k3u1fbpfcp-zoom-1.image)

## 三、结果封装

因为是前后端分离的项目，所以我们有必要统一一个结果返回封装类，这样前后端交互的时候有个统一的标准，约定结果返回的数据是正常的或者遇到异常了。

这里我们用到了一个Result的类，这个用于我们的异步统一返回的结果封装。一般来说，结果里面有几个要素必要的

-   是否成功，可用code表示(如200表示成功，400表示异常)
-   结果消息
-   结果数据

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63fcd3319b5e40aa96f1498dadc0db9d~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a9a42ff0c0a4ad4a4287e9f96dd11b8~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/603a84abe8d7406988a35a786de3f49c~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.common.lang;

import lombok.Data;

import java.io.Serializable;

@Data
public class Result implements Serializable {
 

    private int code;
    private String msg;
    private Object data;

    public static Result success(Object data){
 
        return success(200,"操作成功",data);
    }

    public static Result success(int code,String msg,Object data){
 
        Result r = new Result();
        r.setData(data);
        r.setMsg(msg);
        r.setCode(code);
        return r;
    }
    public static Result fail(String msg){
 
        return fail(400,msg, null);
    }

    public static Result fail(int code,String msg,Object data){
 
        Result r = new Result();
        r.setData(data);
        r.setMsg(msg);
        r.setCode(code);
        return r;
    }
}
```

修改SysUserController

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c92fd22e896d4343a03180fa0c9ef848~tplv-k3u1fbpfcp-zoom-1.image)

```
/**
 * <p>
 *  前端控制器
 * </p>
 * @author itbluebox
 * @since 2022-05-26
 */
@RestController
@RequestMapping("/sys-user")
public class SysUserController extends BaseController {
 

    @Autowired
    private SysUserService sysUserService;

    @GetMapping("list")
    public Result getUserList(){
 
        List<SysUser> list = sysUserService.list(new QueryWrapper<>(null));
        return  Result.success(list);
    }
}
```

<http://localhost:8081/sys-user/list>

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/895e4ae168bd4fc49b57aaea853b6711~tplv-k3u1fbpfcp-zoom-1.image)

## 四、全局异常处理

有时候不可避免服务器报错的情况，如果不配置异常处理机制，就会默认返回tomcat或者nginx的5XX页面，对普通用户来说，不太友好，用户也不懂什么情况。这时候需要我们程序员设计返回一个友好简单的格式给前端。

处理办法如下:通过使用@ControllerAdvice来进行统一异常处理，

```
@ExceptionHandler(value = RuntimeException.class)
```

来指定捕获的Exception各个类型异常，这个异常的处理，是全局的，所有类似的异常，都会跑到这个地方处理。

步骤二、定义全局异常处理，

```
@ControllerAdvice
```

表示定义全局控制器异常处理，

```
@ExceptionHandler
```

表示针对性异常处理，可对每种异常针对性处理。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46b3efe29a4e4d6f824514e66c060716~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c9c3a46f3ea4cb4a5e155dc92a6a1a6~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ff99dd540f34545b30b5ec044dd8e27~tplv-k3u1fbpfcp-zoom-1.image)

```
/**
 * 全局异常处理
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {
 
    @ResponseStatus(HttpStatus.FORBIDDEN)
    @ExceptionHandler(value = AccessDeniedException.class)
    public Result handler(AccessDeniedException e) {
 
        log.info("security权限不足：----------------{}", e.getMessage());
        return Result.fail("权限不足");
    }

    @ResponseStatus(HttpStatus.BAD_REQUEST)
    @ExceptionHandler(value = MethodArgumentNotValidException.class)
    public Result handler(MethodArgumentNotValidException e) {
 
        log.info("实体校验异常：----------------{}", e.getMessage());
        BindingResult bindingResult = e.getBindingResult();
        ObjectError objectError = bindingResult.getAllErrors().stream().findFirst().get();
        return Result.fail(objectError.getDefaultMessage());
    }

    @ResponseStatus(HttpStatus.BAD_REQUEST)
    @ExceptionHandler(value = IllegalArgumentException.class)
    public Result handler(IllegalArgumentException e) {
 
        log.error("Assert异常：----------------{}", e.getMessage());
        return Result.fail(e.getMessage());
    }

    @ResponseStatus(HttpStatus.BAD_REQUEST)
    @ExceptionHandler(value = RuntimeException.class)
    public Result handler(RuntimeException e) {
 
        log.error("运行时异常：----------------{}", e);
        return Result.fail(e.getMessage());
    }
}
```

## 五、整合Spring Security

### 1、Spring Security介绍

Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。

它提供了一组可以在Spring应用上下文中配置的Bean，

充分利用了Spring IoC，DI（控制反转Inversion of Control ,DI:Dependency Injection 依赖注入）和AOP（面向切面编程）功能，

为应用系统提供声明式的安全访问控制功能，减少了为企业系统安全控制编写大量重复代码的工作。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18cae26c59114db7b57fca1e14a0ecfe~tplv-k3u1fbpfcp-zoom-1.image)

流程说明：

客户端发起一个请求，进入 Security 过滤器链。

当到 LogoutFilter 的时候判断是否是登出路径，如果是登出路径则到 logoutHandler ，如果登出成功则到 logoutSuccessHandler 登出成功处理。如果不是登出路径则直接进入下一个过滤器。

当到 UsernamePasswordAuthenticationFilter 的时候判断是否为登录路径，如果是，则进入该过滤器进行登录操作，如果登录失败则到 AuthenticationFailureHandler ，登录失败处理器处理，如果登录成功则到 AuthenticationSuccessHandler 登录成功处理器处理，如果不是登录请求则不进入该过滤器。

进入认证BasicAuthenticationFilter进行用户认证，成功的话会把认证了的结果写入到SecurityContextHolder中SecurityContext的属性authentication上面。

如果认证失败就会交给AuthenticationEntryPoint认证失败处理类，或者抛出异常被后续ExceptionTranslationFilter过滤器处理异常，如果是AuthenticationException就交给AuthenticationEntryPoint处理，如果是AccessDeniedException异常则交给AccessDeniedHandler处理。

当到 FilterSecurityInterceptor 的时候会拿到 uri ，根据 uri 去找对应的鉴权管理器，鉴权管理器做鉴权工作，鉴权成功则到 Controller 层，否则到 AccessDeniedHandler 鉴权失败处理器处理。

### 2、引入Security与jwt

首先我们导入security包，因为我们前后端交互用户凭证用的是JWT，所以我们也导入jwt的相关包，然后因为验证码的存储需要用到redis，所以引入redis。最后为了一些工具类，我们引入hutool。

-   pom.xml

    ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1e95a429db24ed08289001e07c20761~tplv-k3u1fbpfcp-zoom-1.image)

```
<!-- springboot security -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<!-- jwt -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>
<dependency>
    <groupId>com.github.axet</groupId>
    <artifactId>kaptcha</artifactId>
    <version>0.0.9</version>
</dependency>
<!-- hutool工具类-->
<dependency>
    <groupId>cn.hutool</groupId>
    <artifactId>hutool-all</artifactId>
    <version>5.3.3</version>
</dependency>
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
    <version>3.11</version>
</dependency>
```

重新启动项目

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e6897ed83684297bcb7e869edd2c703~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/058b8587b22d4e5c8068e529ebbfd351~tplv-k3u1fbpfcp-zoom-1.image)

访问： [http://localhost:8081](http://localhost:8081/)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef72efb8ae2a443f852dcbd868c89cdc~tplv-k3u1fbpfcp-zoom-1.image)

用户名：user

密码：控制台已经输出

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f78821b6e11449ab95710ab03b88b81~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e204d5fc09f413980c05bd4e982231b~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a2b62951c09468e9ea9058a74eeebd0~tplv-k3u1fbpfcp-zoom-1.image)

<http://localhost:8081/sys-user/list>

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91261b4f151241919a7c88e7267823eb~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/893aaf9632d94da38f643879121e340a~tplv-k3u1fbpfcp-zoom-1.image)

因为每次启动密码都会改变，所以我们通过配置文件来配置一下默认的用户名和密码：

application.yml

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9f043c74d664aae87e434eab163fc97~tplv-k3u1fbpfcp-zoom-1.image)

```
spring:
  security:
    user:
      name: user
      password: 111111
```

### 3、设置Redis的工具类

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d68f176296884857a05c9aa3edb929d2~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8c9f24e8a1f46dc9704e75c390ed381~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfab39d9222b4dfaa3c236c1bde5d6b0~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1837654179444dab2a2f8770c00663f~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.utils;


import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.ZSetOperations;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.TimeUnit;

@Component
public class RedisUtil {
 

    @Autowired
    private RedisTemplate redisTemplate;

    /**
     * 指定缓存失效时间
     *
     * @param key  键
     * @param time 时间(秒)
     * @return
     */
    public boolean expire(String key, long time) {
 
        try {
 
            if (time > 0) {
 
                redisTemplate.expire(key, time, TimeUnit.SECONDS);
            }
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 根据key 获取过期时间
     *
     * @param key 键 不能为null
     * @return 时间(秒) 返回0代表为永久有效
     */
    public long getExpire(String key) {
 
        return redisTemplate.getExpire(key, TimeUnit.SECONDS);
    }

    /**
     * 判断key是否存在
     *
     * @param key 键
     * @return true 存在 false不存在
     */
    public boolean hasKey(String key) {
 
        try {
 
            return redisTemplate.hasKey(key);
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 删除缓存
     *
     * @param key 可以传一个值 或多个
     */
    @SuppressWarnings("unchecked")
    public void del(String... key) {
 
        if (key != null && key.length > 0) {
 
            if (key.length == 1) {
 
                redisTemplate.delete(key[0]);
            } else {
 
                redisTemplate.delete(CollectionUtils.arrayToList(key));
            }
        }
    }

    //============================String=============================

    /**
     * 普通缓存获取
     *
     * @param key 键
     * @return 值
     */
    public Object get(String key) {
 
        return key == null ? null : redisTemplate.opsForValue().get(key);
    }

    /**
     * 普通缓存放入
     *
     * @param key   键
     * @param value 值
     * @return true成功 false失败
     */
    public boolean set(String key, Object value) {
 
        try {
 
            redisTemplate.opsForValue().set(key, value);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }

    }

    /**
     * 普通缓存放入并设置时间
     *
     * @param key   键
     * @param value 值
     * @param time  时间(秒) time要大于0 如果time小于等于0 将设置无限期
     * @return true成功 false 失败
     */
    public boolean set(String key, Object value, long time) {
 
        try {
 
            if (time > 0) {
 
                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);
            } else {
 
                set(key, value);
            }
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 递增
     *
     * @param key 键
     * @param delta  要增加几(大于0)
     * @return
     */
    public long incr(String key, long delta) {
 
        if (delta < 0) {
 
            throw new RuntimeException("递增因子必须大于0");
        }
        return redisTemplate.opsForValue().increment(key, delta);
    }

    /**
     * 递减
     *
     * @param key 键
     * @param delta  要减少几(小于0)
     * @return
     */
    public long decr(String key, long delta) {
 
        if (delta < 0) {
 
            throw new RuntimeException("递减因子必须大于0");
        }
        return redisTemplate.opsForValue().increment(key, -delta);
    }

    //================================Map=================================

    /**
     * HashGet
     *
     * @param key  键 不能为null
     * @param item 项 不能为null
     * @return 值
     */
    public Object hget(String key, String item) {
 
        return redisTemplate.opsForHash().get(key, item);
    }

    /**
     * 获取hashKey对应的所有键值
     *
     * @param key 键
     * @return 对应的多个键值
     */
    public Map<Object, Object> hmget(String key) {
 
        return redisTemplate.opsForHash().entries(key);
    }

    /**
     * HashSet
     *
     * @param key 键
     * @param map 对应多个键值
     * @return true 成功 false 失败
     */
    public boolean hmset(String key, Map<String, Object> map) {
 
        try {
 
            redisTemplate.opsForHash().putAll(key, map);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * HashSet 并设置时间
     *
     * @param key  键
     * @param map  对应多个键值
     * @param time 时间(秒)
     * @return true成功 false失败
     */
    public boolean hmset(String key, Map<String, Object> map, long time) {
 
        try {
 
            redisTemplate.opsForHash().putAll(key, map);
            if (time > 0) {
 
                expire(key, time);
            }
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 向一张hash表中放入数据,如果不存在将创建
     *
     * @param key   键
     * @param item  项
     * @param value 值
     * @return true 成功 false失败
     */
    public boolean hset(String key, String item, Object value) {
 
        try {
 
            redisTemplate.opsForHash().put(key, item, value);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 向一张hash表中放入数据,如果不存在将创建
     *
     * @param key   键
     * @param item  项
     * @param value 值
     * @param time  时间(秒)  注意:如果已存在的hash表有时间,这里将会替换原有的时间
     * @return true 成功 false失败
     */
    public boolean hset(String key, String item, Object value, long time) {
 
        try {
 
            redisTemplate.opsForHash().put(key, item, value);
            if (time > 0) {
 
                expire(key, time);
            }
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 删除hash表中的值
     *
     * @param key  键 不能为null
     * @param item 项 可以使多个 不能为null
     */
    public void hdel(String key, Object... item) {
 
        redisTemplate.opsForHash().delete(key, item);
    }

    /**
     * 判断hash表中是否有该项的值
     *
     * @param key  键 不能为null
     * @param item 项 不能为null
     * @return true 存在 false不存在
     */
    public boolean hHasKey(String key, String item) {
 
        return redisTemplate.opsForHash().hasKey(key, item);
    }

    /**
     * hash递增 如果不存在,就会创建一个 并把新增后的值返回
     *
     * @param key  键
     * @param item 项
     * @param by   要增加几(大于0)
     * @return
     */
    public double hincr(String key, String item, double by) {
 
        return redisTemplate.opsForHash().increment(key, item, by);
    }

    /**
     * hash递减
     *
     * @param key  键
     * @param item 项
     * @param by   要减少记(小于0)
     * @return
     */
    public double hdecr(String key, String item, double by) {
 
        return redisTemplate.opsForHash().increment(key, item, -by);
    }

    //============================set=============================

    /**
     * 根据key获取Set中的所有值
     *
     * @param key 键
     * @return
     */
    public Set<Object> sGet(String key) {
 
        try {
 
            return redisTemplate.opsForSet().members(key);
        } catch (Exception e) {
 
            e.printStackTrace();
            return null;
        }
    }

    /**
     * 根据value从一个set中查询,是否存在
     *
     * @param key   键
     * @param value 值
     * @return true 存在 false不存在
     */
    public boolean sHasKey(String key, Object value) {
 
        try {
 
            return redisTemplate.opsForSet().isMember(key, value);
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 将数据放入set缓存
     *
     * @param key    键
     * @param values 值 可以是多个
     * @return 成功个数
     */
    public long sSet(String key, Object... values) {
 
        try {
 
            return redisTemplate.opsForSet().add(key, values);
        } catch (Exception e) {
 
            e.printStackTrace();
            return 0;
        }
    }

    /**
     * 将set数据放入缓存
     *
     * @param key    键
     * @param time   时间(秒)
     * @param values 值 可以是多个
     * @return 成功个数
     */
    public long sSetAndTime(String key, long time, Object... values) {
 
        try {
 
            Long count = redisTemplate.opsForSet().add(key, values);
            if (time > 0) expire(key, time);
            return count;
        } catch (Exception e) {
 
            e.printStackTrace();
            return 0;
        }
    }

    /**
     * 获取set缓存的长度
     *
     * @param key 键
     * @return
     */
    public long sGetSetSize(String key) {
 
        try {
 
            return redisTemplate.opsForSet().size(key);
        } catch (Exception e) {
 
            e.printStackTrace();
            return 0;
        }
    }

    /**
     * 移除值为value的
     *
     * @param key    键
     * @param values 值 可以是多个
     * @return 移除的个数
     */
    public long setRemove(String key, Object... values) {
 
        try {
 
            Long count = redisTemplate.opsForSet().remove(key, values);
            return count;
        } catch (Exception e) {
 
            e.printStackTrace();
            return 0;
        }
    }
    //===============================list=================================

    /**
     * 获取list缓存的内容
     *
     * @param key   键
     * @param start 开始
     * @param end   结束  0 到 -1代表所有值
     * @return
     */
    public List<Object> lGet(String key, long start, long end) {
 
        try {
 
            return redisTemplate.opsForList().range(key, start, end);
        } catch (Exception e) {
 
            e.printStackTrace();
            return null;
        }
    }

    /**
     * 获取list缓存的长度
     *
     * @param key 键
     * @return
     */
    public long lGetListSize(String key) {
 
        try {
 
            return redisTemplate.opsForList().size(key);
        } catch (Exception e) {
 
            e.printStackTrace();
            return 0;
        }
    }

    /**
     * 通过索引 获取list中的值
     *
     * @param key   键
     * @param index 索引  index>=0时， 0 表头，1 第二个元素，依次类推；index<0时，-1，表尾，-2倒数第二个元素，依次类推
     * @return
     */
    public Object lGetIndex(String key, long index) {
 
        try {
 
            return redisTemplate.opsForList().index(key, index);
        } catch (Exception e) {
 
            e.printStackTrace();
            return null;
        }
    }

    /**
     * 将list放入缓存
     *
     * @param key   键
     * @param value 值
     * @return
     */
    public boolean lSet(String key, Object value) {
 
        try {
 
            redisTemplate.opsForList().rightPush(key, value);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 将list放入缓存
     *
     * @param key   键
     * @param value 值
     * @param time  时间(秒)
     * @return
     */
    public boolean lSet(String key, Object value, long time) {
 
        try {
 
            redisTemplate.opsForList().rightPush(key, value);
            if (time > 0) expire(key, time);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 将list放入缓存
     *
     * @param key   键
     * @param value 值
     * @return
     */
    public boolean lSet(String key, List<Object> value) {
 
        try {
 
            redisTemplate.opsForList().rightPushAll(key, value);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 将list放入缓存
     *
     * @param key   键
     * @param value 值
     * @param time  时间(秒)
     * @return
     */
    public boolean lSet(String key, List<Object> value, long time) {
 
        try {
 
            redisTemplate.opsForList().rightPushAll(key, value);
            if (time > 0) expire(key, time);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 根据索引修改list中的某条数据
     *
     * @param key   键
     * @param index 索引
     * @param value 值
     * @return
     */
    public boolean lUpdateIndex(String key, long index, Object value) {
 
        try {
 
            redisTemplate.opsForList().set(key, index, value);
            return true;
        } catch (Exception e) {
 
            e.printStackTrace();
            return false;
        }
    }

    /**
     * 移除N个值为value
     *
     * @param key   键
     * @param count 移除多少个
     * @param value 值
     * @return 移除的个数
     */
    public long lRemove(String key, long count, Object value) {
 
        try {
 
            Long remove = redisTemplate.opsForList().remove(key, count, value);
            return remove;
        } catch (Exception e) {
 
            e.printStackTrace();
            return 0;
        }
    }

    //================有序集合 sort set===================
    /**
     * 有序set添加元素
     *
     * @param key
     * @param value
     * @param score
     * @return
     */
    public boolean zSet(String key, Object value, double score) {
 
        return redisTemplate.opsForZSet().add(key, value, score);
    }

    public long batchZSet(String key, Set<ZSetOperations.TypedTuple> typles) {
 
        return redisTemplate.opsForZSet().add(key, typles);
    }

    public void zIncrementScore(String key, Object value, long delta) {
 
        redisTemplate.opsForZSet().incrementScore(key, value, delta);
    }

    public void zUnionAndStore(String key, Collection otherKeys, String destKey) {
 
        redisTemplate.opsForZSet().unionAndStore(key, otherKeys, destKey);
    }

    /**
     * 获取zset数量
     * @param key
     * @param value
     * @return
     */
    public long getZsetScore(String key, Object value) {
 
        Double score = redisTemplate.opsForZSet().score(key, value);
        if(score==null){
 
            return 0;
        }else{
 
            return score.longValue();
        }
    }

    /**
     * 获取有序集 key 中成员 member 的排名 。
     * 其中有序集成员按 score 值递减 (从大到小) 排序。
     * @param key
     * @param start
     * @param end
     * @return
     */
    public Set<ZSetOperations.TypedTuple> getZSetRank(String key, long start, long end) {
 
        return redisTemplate.opsForZSet().reverseRangeWithScores(key, start, end);
    }

}
```

### 4、设置RedisConfig

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96c5b6f124e640eab456c35fff8f38c3~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f422cc3888eb4c4db63c77ceb980d75b~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

@Configuration
public class RedisConfig {
 

    @Bean
    RedisTemplate redisTemplate(RedisConnectionFactory redisConnectionFactory) {
 

        RedisTemplate redisTemplate = new RedisTemplate();
        redisTemplate.setConnectionFactory(redisConnectionFactory);

        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
        jackson2JsonRedisSerializer.setObjectMapper(new ObjectMapper());

        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);

        redisTemplate.setHashKeySerializer(new StringRedisSerializer());
        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);

        return redisTemplate;
    }
}
```

## 六、用户认证

首先我们来解决用户认证问题，分为首次登陆，和二次认证。

首次登录认证：用户名、密码和验证码完成登录

二次token认证：请求头携带Jwt进行身份认证

使用用户名密码来登录的，然后我们还想添加图片验证码，那么security给我们提供的UsernamePasswordAuthenticationFilter能使用吗？

首先security的所有过滤器都是没有图片验证码这回事的，看起来不适用了。其实这里我们可以灵活点，如果你依然想沿用自带的UsernamePasswordAuthenticationFilter，那么我们就在这过滤器之前添加一个图片验证码过滤器。当然了我们也可以通过自定义过滤器继承UsernamePasswordAuthenticationFilter，然后自己把验证码验证逻辑和认证逻辑写在一起，这也是一种解决方式。

我们这次解决方式是在UsernamePasswordAuthenticationFilter之前自定义一个图片过滤器CaptchaFilter，提前校验验证码是否正确，这样我们就可以使用UsernamePasswordAuthenticationFilter了，然后登录正常或失败我们都可以通过对应的Handler来返回我们特定格式的封装结果数据。

#### 1、生成验证码

首先我们先生成验证码，之前我们已经引用了google的验证码生成器，我们先来配置一下图片验证码的生成规则：

KaptchaConfig

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5ce3cd047cf47b4a2c39421b013ceae~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a6144332edb410dbf1e0262c0104136~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.config;


import com.google.code.kaptcha.impl.DefaultKaptcha;
import com.google.code.kaptcha.util.Config;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.Properties;

@Configuration
public class KaptchaConfig {
 
    @Bean
    public DefaultKaptcha producer() {
 
        Properties properties = new Properties();
        properties.put("kaptcha.border", "no");
        properties.put("kaptcha.textproducer.font.color", "black");
        properties.put("kaptcha.textproducer.char.space", "4");
        properties.put("kaptcha.image.height", "40");
        properties.put("kaptcha.image.width", "120");
        properties.put("kaptcha.textproducer.font.size", "30");
        Config config = new Config(properties);
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        defaultKaptcha.setConfig(config);
        return defaultKaptcha;
    }
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d578678bfc7343d98026eb7748d0d1d4~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a44d6a20f18c4be1b291c22420bd0fb9~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.common.lang;

public class Const {
 

    public final static String CAPTCHA_KEY = "captcha";

}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8711b93b4dee42eaaba2f0167bac974a~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9511ca75959a4246a43b89fe0bfe5e7b~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.controller;

import cn.hutool.core.map.MapUtil;
import cn.itbluebox.springbootadminvue.common.lang.Const;
import cn.itbluebox.springbootadminvue.common.lang.Result;
import com.google.code.kaptcha.Producer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import sun.misc.BASE64Encoder;

import javax.imageio.ImageIO;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.UUID;

@RestController
public class AuthController extends BaseController {
 

    @Autowired
    Producer producer;

    @GetMapping("/captcha")
    public Result captcha() throws IOException {
 
        String key = UUID.randomUUID().toString();
        String code = producer.createText();
        BufferedImage image = producer.createImage(code);
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        ImageIO.write(image,"jpg",outputStream);
        BASE64Encoder encoder = new BASE64Encoder();
        String str = "data:image/jpeg;base64,";
        String base64Img = str + encoder.encode(outputStream.toByteArray());
        redisUtil.hset(Const.CAPTCHA_KEY,key,code,120);
        return Result.success(
                MapUtil.builder()
                        .put("token",key)
                        .put("captchaImg",base64Img)
                        .build()
        );
    }
}
```

注意在上面的BaseController 当中添加一些新内容

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9a2d3ef6e7949bba56277a386dc5931~tplv-k3u1fbpfcp-zoom-1.image)

```
public class BaseController {
 
    @Autowired
    HttpServletRequest req;
    @Autowired
    RedisUtil redisUtil;
}
```

启动

先启动Redis

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32702b0d02b04bf68accf0b77eca8804~tplv-k3u1fbpfcp-zoom-1.image)

启动项目

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/418c31879c1a4bc28dc5654584c0c713~tplv-k3u1fbpfcp-zoom-1.image)

#### 2、前端实现验证码显示

启动前端项目

去除moke

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd7ff017d0094c5e8146ea06b52d48e1~tplv-k3u1fbpfcp-zoom-1.image)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/679f5b93f99e4b7292b6dc4211f85ed8~tplv-k3u1fbpfcp-zoom-1.image)

#### 3、解决跨域问题

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d04d95ee5c394089a2a57098f58d1bd4~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bbbb08b1d56b4d36ba0feacac463cb22~tplv-k3u1fbpfcp-zoom-1.image)

```
@Configuration
public class CorsConfig implements WebMvcConfigurer {
 
    private CorsConfiguration buildConfig() {
 
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.addAllowedOrigin("*");
        corsConfiguration.addAllowedHeader("*");
        corsConfiguration.addAllowedMethod("*");
        corsConfiguration.addExposedHeader("Authorization");
        return corsConfiguration;
    }

    @Bean
    public CorsFilter corsFilter() {
 
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", buildConfig());
        return new CorsFilter(source);
    }

    @Override
    public void addCorsMappings(CorsRegistry registry) {
 
        registry.addMapping("/**")
                .allowedOrigins("*")
//          .allowCredentials(true)
                .allowedMethods("GET", "POST", "DELETE", "PUT")
                .maxAge(3600);
    }
}
```

#### 4、设置过滤器

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11f2dfa9182344acb196802bb2c0cb3e~tplv-k3u1fbpfcp-zoom-1.image)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/837c3f3939484bb5a94c93164b900d63~tplv-k3u1fbpfcp-zoom-1.image)

```
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {
 

    private static final String[] URL_WHITELIST = {
 
        "/login",
        "/logout",
        "/captcha",
        "/favicon.ico",
    };
    protected void configure(HttpSecurity http) throws Exception {
 
        http.cors().and().csrf().disable()
        //登录配置
        .formLogin()
/*      .successHandler()
        .failureHandler()
*/
        //禁用session
        .and()
                .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        //配置拦截规则
        .and()
                .authorizeRequests()
                .antMatchers(URL_WHITELIST).permitAll()
                .anyRequest().authenticated()
        //异常处理器
        //配置自定义的过滤器
    ;
    }
}
```

重新启动项目

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d497e951624947ee985a5c8b3ac741be~tplv-k3u1fbpfcp-zoom-1.image)

刷新页面

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78cc7353a1eb48e6b8d304dd2113619e~tplv-k3u1fbpfcp-zoom-1.image)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a36cb6df7fdb4f86b1d39ad255fcdf82~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec5f54d0bdba43fe90e6944efb30df7c~tplv-k3u1fbpfcp-zoom-1.image)

```
@Component
public class LoginFailureHandler implements AuthenticationFailureHandler {
 

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
 

        response.setContentType("application/json;charset=UTF-8");
        ServletOutputStream outputStream = response.getOutputStream();

        Result result = Result.fail("用户名或密码错误");

        outputStream.write(JSONUtil.toJsonStr(result).getBytes("UTF-8"));

        outputStream.flush();
        outputStream.close();
    }
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7012aca132df4c4f942d019f9b49cf85~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb7cbd590dc549a2bcfd8a6e62212d02~tplv-k3u1fbpfcp-zoom-1.image)

```
@Component
public class LoginSuccessHandler implements AuthenticationSuccessHandler {
 
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
 
        response.setContentType("application/json;charset=UTF-8");
        ServletOutputStream outputStream = response.getOutputStream();
        //生成jwt 。 并放置到请求头中
        Result result = Result.success("成功");
        outputStream.write(JSONUtil.toJsonStr(result).getBytes("UTF-8"));
        outputStream.flush();
        outputStream.close();
    }
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df8537495ff945b19ee55b342c931790~tplv-k3u1fbpfcp-zoom-1.image)

```
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {
 
    @Autowired
    private LoginFailureHandler loginFailureHandler;
    @Autowired
    private LoginSuccessHandler loginSuccessHandler;

    private static final String[] URL_WHITELIST = {
 
        "/login",
        "/logout",
        "/captcha",
        "/favicon.ico",
    };
    protected void configure(HttpSecurity http) throws Exception {
 
        http.cors().and().csrf().disable()
        //登录配置
        .formLogin()
        .successHandler(loginSuccessHandler)
        .failureHandler(loginFailureHandler)
        //禁用session
        .and()
                .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        //配置拦截规则
        .and()
                .authorizeRequests()
                .antMatchers(URL_WHITELIST).permitAll()
                .anyRequest().authenticated()
        //异常处理器
        //配置自定义的过滤器
    ;
    }
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3389f7ae7393461b83db72c3a548f2d9~tplv-k3u1fbpfcp-zoom-1.image)

刷新页面

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/430feea29a1b489db7a8027492888a0a~tplv-k3u1fbpfcp-zoom-1.image)

#### 5、设置点击刷新二维码

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae9645d97b334287a168babdfe06e4f3~tplv-k3u1fbpfcp-zoom-1.image)

```
<el-image style="width: 80px; height: 40px;float: left;padding-left: 25px;" 
@click="getCaptcha" :src="captchaImg" ></el-image>
```

设置点击后清空对应的内容

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fee239def5174b048dbbe3744846e6b5~tplv-k3u1fbpfcp-zoom-1.image)

#### 6、设置验证码过滤器

（1）设置验证码错误异常

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60a4c73ad9ee465cb73dafaa1661fb2c~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/883930c6387b46b3b4ab20d0c655c072~tplv-k3u1fbpfcp-zoom-1.image)

```
public class CaptchaException extends AuthenticationException {
 

    public CaptchaException(String msg) {
 
        super(msg);
    }
}
```

（2）验证码过滤器

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf0b5052eebf41afbc5613eb2aa97e40~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8db4270ee277447c97f01664f5430f9a~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4feaf6e4e6044a6cb508ef76f3373c36~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.security;

import cn.itbluebox.springbootadminvue.common.exception.CaptchaException;
import cn.itbluebox.springbootadminvue.common.lang.Const;
import cn.itbluebox.springbootadminvue.utils.RedisUtil;
import com.baomidou.mybatisplus.core.toolkit.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@Component
public class CaptchaFilter extends OncePerRequestFilter {
 


    @Autowired
    private RedisUtil redisUtil;

    @Autowired
    private LoginFailureHandler loginFailureHandler;

    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
 

        String url = request.getRequestURI();

        if("/login".equals(url) && request.getMethod().equals("POST") ){
 
            try{
 
                //校验验证码
                validate(request);
                //如果不正确，就跳转到认证失败处理器
            }catch (CaptchaException e){
 
                //交给失败的处理器（认证失败处理器）
                loginFailureHandler.onAuthenticationFailure(request,response,e);
            }
        }
        filterChain.doFilter(request,response);
    }
    //校验逻辑
    private void validate(HttpServletRequest request) {
 
        String code = request.getParameter("code");
        String key = request.getParameter("token");
        if(StringUtils.isBlank(code) || StringUtils.isBlank(key)){
 
            throw new CaptchaException("验证码错误");
        }
        if(!code.equals(redisUtil.hget(Const.CAPTCHA_KEY,key))){
 
            throw new CaptchaException("验证码错误");
        }
        //一次性使用
        redisUtil.hdel(Const.CAPTCHA_KEY);
    }
}
```

#### 7、配置过滤器

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8f023f660f34d7fb62ccc5c4a584ab0~tplv-k3u1fbpfcp-zoom-1.image)

```
//异常处理器
        //配置自定义的过滤器
        .and()
        .addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class);
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e88b11c8af27478f8b6ff8b078ed401a~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d31bd4c44507499b90912387d292c3e5~tplv-k3u1fbpfcp-zoom-1.image)

## 七、完成登录并生成JWT

登录成功之后前端就可以获取到了jwt的信息，

前端中我们是保存在了store中，

同时也保存在了localStorage中，

然后每次axios请求之前，

我们都会添加上我们的请求头信息，可以回顾一下。

### 1、编写JwtUtils

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d885cb0b00c46919d57b9528fcc8023~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49e3af796f614566997ab66379b916f3~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9507dbd4123a4be0b715d3bf6c9e879e~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.utils;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

import java.util.Date;
@Data
@Component
@ConfigurationProperties(prefix = "itbluebox.jwt")
public class JwtUtils {
 
    private long expire;
    private String secret;
    private String header;
    //生成  JWT
    public String generateToken(String username){
 

        Date nowDate = new Date();
        Date expireDate = new Date(nowDate.getTime() + 1000 * expire);
        return Jwts.builder()
                .setHeaderParam("typ","JWT")
                .setSubject(username)
                .setIssuedAt(nowDate)
                .setExpiration(expireDate)//7天逾期
                .signWith(SignatureAlgorithm.ES512,secret)
                .compact();
    }
    //解析JWT
    public Claims getClaimByToken(String jwt){
 
        try{
 
            return   Jwts.parser()
                    .setSigningKey(secret)
                    .parseClaimsJws(jwt)
                    .getBody();
        }catch (Exception e){
 
            return null;
        }
    }
    //JWT 是否过期的方法
    public boolean isTokenExpired(Claims claims){
 
        return claims.getExpiration().before(new Date());
    }
}
```

### 2、编写Jwt对应的配置文件

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d1a04edf4c1c4800b657b22f5895b4cf~tplv-k3u1fbpfcp-zoom-1.image)

```
itbluebox:
  jwt:
    header: Authorization
    expire: 604800 #7天，秒单位
    secret: 212wdseqw23red232r3rds23r21212hg  #填够32位
```

## 八、身份认证 - 1

登录成功之后前端就可以获取到了jwt的信息，前端中我们是保存在了store中，同时也保存在了localStorage中，然后每次axios请求之前，我们都会添加上我们的请求头信息

所以后端进行用户身份识别的时候，我们需要通过请求头中获取jwt，然后解析出我们的用户名，这样我们就可以知道是谁在访问我们的接口啦，然后判断用户是否有权限等操作。

那么我们自定义一个过滤器用来进行识别jwt。

### 1、JwtAuthenticationFilter

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f545c489caee43809207542398a8d7f8~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f97a2ead0384e719ecede7f46b09dce~tplv-k3u1fbpfcp-zoom-1.image)

```
public class JwtAuthenticationFilter extends BasicAuthenticationFilter {
 

    @Autowired
    private JwtUtils jwtUtils;

    public JwtAuthenticationFilter(AuthenticationManager authenticationManager) {
 
        super(authenticationManager);
    }
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws IOException, ServletException {
 
        String jwt = request.getHeader(jwtUtils.getHeader());
        if(StrUtil.isBlankOrUndefined(jwt)){
 
            chain.doFilter(request,response);
            return;
        }
        Claims claim = jwtUtils.getClaimByToken(jwt);
        if(ObjectUtils.isEmpty(claim)){
 
            throw new JwtException("token 异常");
        }
        if(jwtUtils.isTokenExpired(claim)){
 
            throw new JwtException("token已经过期");
        }
        String username = claim.getSubject();
        //获取用户的权限信息
        UsernamePasswordAuthenticationToken token =
                new UsernamePasswordAuthenticationToken(username,null,null);
        SecurityContextHolder.getContext().setAuthentication(token);
        chain.doFilter(request,response);
    }
}
```

### 2、完善SecurityConfig

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0fa5d01e77264d18a0eb4c5e83ed5d83~tplv-k3u1fbpfcp-zoom-1.image)

```
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {
 
    @Autowired
    private LoginFailureHandler loginFailureHandler;
    @Autowired
    private LoginSuccessHandler loginSuccessHandler;

    @Autowired
    CaptchaFilter captchaFilter;

    @Bean
    JwtAuthenticationFilter jwtAuthenticationFilter() throws Exception {
 
        JwtAuthenticationFilter jwtAuthenticationFilter = new JwtAuthenticationFilter(authenticationManager());
        return jwtAuthenticationFilter;
    }

    private static final String[] URL_WHITELIST = {
 
        "/login",
        "/logout",
        "/captcha",
        "/favicon.ico",
    };
    protected void configure(HttpSecurity http) throws Exception {
 
        http.cors().and().csrf().disable()
        //登录配置
        .formLogin()
        .successHandler(loginSuccessHandler)
        .failureHandler(loginFailureHandler)
        //禁用session
        .and()
                .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        //配置拦截规则
        .and()
                .authorizeRequests()
                .antMatchers(URL_WHITELIST).permitAll()
                .anyRequest().authenticated()
        //异常处理器
        //配置自定义的过滤器
                .and()
                .addFilter(jwtAuthenticationFilter())
                .addFilterBefore(captchaFilter, UsernamePasswordAuthenticationFilter.class)
    ;
    }
}
```

### 3、发起请求测试

<http://localhost:8081/sys-user/list>

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec9e3ca646dd4ce1b7475f13610aab87~tplv-k3u1fbpfcp-zoom-1.image)

## 九、用户认证失败或权限不足异常处理

### 1、认证失败处理器

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/21b29ca116f546959fc0fd6af16029a7~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b15622a3cff942c5b40aebc4ddb07438~tplv-k3u1fbpfcp-zoom-1.image)

```
@Component
public class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint {
 
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
 

    }
}
```

### 2、异常处理器

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/397d2b36602a4b40a7554ef01cbb92d1~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f17ee6fdb6fd45ed8d9b34851101446f~tplv-k3u1fbpfcp-zoom-1.image)

```
@Component
public class JwtAccessDeniedHandler implements AccessDeniedHandler {
 
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException {
 
    }
}
```

### 3、SecurityConfig当中

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fad9d16ee6d14ebaa6ec2b837a141439~tplv-k3u1fbpfcp-zoom-1.image)

```
@Autowired
    JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;

    @Autowired
    JwtAccessDeniedHandler jwtAccessDeniedHandler;
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ddcb80acad654ca9b6c9af5fab4cb191~tplv-k3u1fbpfcp-zoom-1.image)

```
//异常处理器
        .and()
                .exceptionHandling()
                .authenticationEntryPoint(jwtAuthenticationEntryPoint)
                .accessDeniedHandler(jwtAccessDeniedHandler)
```

### 4、完善JwtAccessDeniedHandler和JwtAuthenticationEntryPoint

#### （1）JwtAccessDeniedHandler

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f68c0ebe06c24b6b8b0025cc3f52bb79~tplv-k3u1fbpfcp-zoom-1.image)

```
@Component
public class JwtAccessDeniedHandler implements AccessDeniedHandler {
 
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException {
 
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);

        ServletOutputStream outputStream = response.getOutputStream();

        Result result = Result.fail(accessDeniedException.getMessage());

        outputStream.write(JSONUtil.toJsonStr(result).getBytes("UTF-8"));

        outputStream.flush();
        outputStream.close();
    }
}
```

#### （2）JwtAuthenticationEntryPoint

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af7c7fa526d2450681d7d5040ac2e8b4~tplv-k3u1fbpfcp-zoom-1.image)

```
@Component
public class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint {
 
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
 
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        ServletOutputStream outputStream = response.getOutputStream();
        Result result = Result.fail("请先登录");
        outputStream.write(JSONUtil.toJsonStr(result).getBytes("UTF-8"));
        outputStream.flush();
        outputStream.close();
    }
}
```

### 5、内容测试

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5e597f5f52c47a29ccc09dfe9fd572f~tplv-k3u1fbpfcp-zoom-1.image)

向接口发送请求： <http://localhost:8081/sys-user/list>

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/45f9797920194d5aaab53c82b68abd98~tplv-k3u1fbpfcp-zoom-1.image)

### 6、用户登录查库

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ef0c312f8134df9b12a5e3d88cb6c19~tplv-k3u1fbpfcp-zoom-1.image)

UserDetailServiceImpl

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3811f0dd66994741aec79645cc665fc1~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/855383a1195c4f99aaa6e5435c45caf4~tplv-k3u1fbpfcp-zoom-1.image)

```
SysUser sysUser =  sysUserService.getByUserName(username);
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d13beb05241a415a8f6241b3c63d5893~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2c320f68e284b93b977c175cf31d668~tplv-k3u1fbpfcp-zoom-1.image)

```
public interface SysUserService extends IService<SysUser> {
 
    SysUser getByUserName(String username);
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05605e98106c42b0bda6336e664c8ae9~tplv-k3u1fbpfcp-zoom-1.image)

```
@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
 
    @Override
    public SysUser getByUserName(String username) {
 
        return getOne(new QueryWrapper<SysUser>().eq("username",username));
    }
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/555067b8233e493f99a4f9bbfa1eb99e~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e08fb6301fd54766a433d453b9592161~tplv-k3u1fbpfcp-zoom-1.image)

```
package cn.itbluebox.springbootadminvue.security;
import cn.hutool.core.lang.Assert;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import java.util.Collection;

public class AccountUser implements UserDetails {
 
    private Long userId;
    private String password;
    private final String username;
    private final Collection<? extends GrantedAuthority> authorities;
    private final boolean accountNonExpired;
    private final boolean accountNonLocked;
    private final boolean credentialsNonExpired;
    private final boolean enabled;
    public AccountUser(Long userId, String username, String password, Collection<? extends GrantedAuthority> authorities) {
 
        this(userId, username, password, true, true, true, true, authorities);
    }

    public AccountUser(Long userId, String username, String password, boolean enabled, boolean accountNonExpired,
                       boolean credentialsNonExpired, boolean accountNonLocked,
                       Collection<? extends GrantedAuthority> authorities) {
 
        Assert.isTrue(username != null && !"".equals(username) && password != null,
                "Cannot pass null or empty values to constructor");
        this.userId = userId;
        this.username = username;
        this.password = password;
        this.enabled = enabled;
        this.accountNonExpired = accountNonExpired;
        this.credentialsNonExpired = credentialsNonExpired;
        this.accountNonLocked = accountNonLocked;
        this.authorities = authorities;
    }
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
 
        return this.authorities;
    }
    @Override
    public String getPassword() {
 
        return this.password;
    }
    @Override
    public String getUsername() {
 
        return this.username;
    }
    @Override
    public boolean isAccountNonExpired() {
 
        return this.accountNonExpired;
    }
    @Override
    public boolean isAccountNonLocked() {
 
        return this.accountNonLocked;
    }
    @Override
    public boolean isCredentialsNonExpired() {
 
        return this.credentialsNonExpired;
    }
    @Override
    public boolean isEnabled() {
 
        return this.enabled;
    }
}
```

完善SecurityConfig

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11b8218554b14106876759fd17a0b18f~tplv-k3u1fbpfcp-zoom-1.image)

```
@Bean
    BCryptPasswordEncoder bCryptPasswordEncoder(){
 
        return new BCryptPasswordEncoder();
    }
```

完善UserDetailServiceImpl

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d92694974e844a3bc6b15c98628c59a~tplv-k3u1fbpfcp-zoom-1.image)

```
@Service
public class UserDetailServiceImpl implements UserDetailsService {
 

    @Autowired
    private SysUserService sysUserService;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
 
        SysUser sysUser =  sysUserService.getByUserName(username);
        if(ObjectUtils.isEmpty(sysUser)){
 
            throw new UsernameNotFoundException("用户名或密码不正确");
        }
        return new AccountUser(sysUser.getId(),sysUser.getUsername(),sysUser.getPassword(),getUserAuthority(sysUser.getId()));
    }
    /*
    * 获取用户权限信息（角色，菜单权限）
    * */
    public List<GrantedAuthority> getUserAuthority(Long userId){
 

        return null;

    }
}
```

完善SecurityConfig

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f35a13aa0c5848799cf0a729dc732a2f~tplv-k3u1fbpfcp-zoom-1.image)

```
@Autowired
    UserDetailServiceImpl userDetailService;
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a304087acfaf4c8dbff41c673764133f~tplv-k3u1fbpfcp-zoom-1.image)

```
@Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception{
 
        auth.userDetailsService(userDetailService);
    }
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d51bc2baea842518eaac1c01155e005~tplv-k3u1fbpfcp-zoom-1.image)

```
@RestController
@RequestMapping("/sys-user")
public class SysUserController extends BaseController {
 

    @Autowired
    private SysUserService sysUserService;

    @Autowired
    private BCryptPasswordEncoder bCryptPasswordEncoder;

    @GetMapping("list")
    public Result getUserList(){
 
        List<SysUser> list = sysUserService.list(new QueryWrapper<>(null));
        return  Result.success(list);
    }

    @GetMapping("list/pass")
    public Result pass(){
 


        //加密后的密码
        String password = bCryptPasswordEncoder.encode("111111");

        boolean matches = bCryptPasswordEncoder.matches("111111", password);

        System.out.println("匹配结果："+matches);

        return  Result.success(password);
    }

}
```

编写一个测试方法生成一下密码

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/707fc1384f0d438b943fb0b0090e4593~tplv-k3u1fbpfcp-zoom-1.image)

```
@SpringBootTest
class SpringbootAdminvueApplicationTests {
 
    @Autowired
    private BCryptPasswordEncoder bCryptPasswordEncoder;
    @Test
    void contextLoads() {
 
        String password = bCryptPasswordEncoder.encode("111111");

        boolean matches = bCryptPasswordEncoder.matches("111111", password);

        System.out.println("匹配结果："+matches);

        System.out.println(password);
    }
}
```

在数据库当中添加对应的账号和密码

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcba837f44aa4cc8827de78b443b5584~tplv-k3u1fbpfcp-zoom-1.image)

将配置文件当中SpringSecurity的内容注释掉

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00d3611d870445c290997f1dfac291ac~tplv-k3u1fbpfcp-zoom-1.image)

```
server:
  port: 8081
# DataSource Config
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/itzheng-vue-admin?useUnicode=true&useSSL=false&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: root
#  security:
#    user:
#      name: user
#      password: 111111
mybatis-plus:
  mapper-locations: classpath*:/mapper/**Mapper.xml
itbluebox:
  jwt:
    header: Authorization
    expire: 604800 #7天，秒单位
    secret: 212wdseqw23red232r3rds23r21212hg  #填够32位
```

发送登录请求

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df0b1f8e241a4e8b96eb7dc25edd5c6b~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/390f80d07acc47aab35e8582782d36a2~tplv-k3u1fbpfcp-zoom-1.image)

### 7、用户授权

然后关于权限部分，也是security的重要功能，当用户认证成功之后，我们就知道谁在访问系统接口，这是又有一个问题，就是这个用户有没有权限来访问我们这个接口呢，要解决这个问题,我们需要知道用户有哪些权限，哪些角色，这样security才能我们做权限判断。

之前我们已经定义及几张表，用户、角色、菜单、以及一些关联表，一般当权限粒度比较细的时候，我们都通过判断用户有没有此菜单或操作的权限，而不是通过角色判断，而用户和菜单是不直接做关联的，是通过用户拥有哪些角色，然后角色拥有哪些菜单权限这样来获得的。

#### 问题1:我们是在哪里赋予用户权限的?有两个地方:

-   1、用户登录，调用调用UserDetailsService.loadUserByUsername()方法时候可以返回用户的权限信息。
-   2、接口调用进行身份认证过滤器时候JWTAuthenticationFilter，需要返回用户权限信息

#### 问题2:在哪里决定什么接口需要什么权限?

Security内置的权限注解:

-   @PreAuthorize:方法执行前进行权限检查
-   @PostAuthorize:方法执行后进行权限检查
-   @Secured:类似于@PreAuthorize\
    可以在Controller的方法前添加这些注解表示接口需要什么权限。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8c99f5f711e469c9b92340970473593~tplv-k3u1fbpfcp-zoom-1.image)

```
@RestController
@RequestMapping("/sys-user")
public class SysUserController extends BaseController {
 

    @Autowired
    private SysUserService sysUserService;

    @Autowired
    private BCryptPasswordEncoder bCryptPasswordEncoder;

    //合作权限拥有admin的才能访问
    @PreAuthorize("hasRole('admin')")
    @GetMapping("list")
    public Result getUserList(){
 
        List<SysUser> list = sysUserService.list(new QueryWrapper<>(null));
        return  Result.success(list);
    }

    //普通用户、超级管理员
    //当前方法只有拥有sys:user:list的权限的管理员才能访问方法
    @PreAuthorize("hasAnyAuthority('sys:user:list')")
    @GetMapping("list/pass")
    public Result pass(){
 

        //加密后的密码
        String password = bCryptPasswordEncoder.encode("111111");

        boolean matches = bCryptPasswordEncoder.matches("111111", password);

        System.out.println("匹配结果："+matches);

        return  Result.success(password);
    }

}
```

### 8、完善权限方法

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/04e1a5cd1ddc4d9db01a5947fefb2631~tplv-k3u1fbpfcp-zoom-1.image)

```
/*
    * 获取用户权限信息（角色，菜单权限）
    * */
    public List<GrantedAuthority> getUserAuthority(Long userId){
 
        //角色(ROLE_admin)、菜单操作权限、sys:user:list
        String authority = sysUserService.getUserAuthorityInfo(userId); //ROLE_admin,ROLE_normal,sys:user:list,....
        return AuthorityUtils.commaSeparatedStringToAuthorityList(authority);
    }
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7047becfea504eb2bf926fe8bd66c2cb~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/20e69b23c5624c7ca6fb49c8285a865e~tplv-k3u1fbpfcp-zoom-1.image)

```
String getUserAuthorityInfo(Long userId);
```

在SysUserServiceImpl当中

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cc99a8a684aa439bad5c98a275b6ebfa~tplv-k3u1fbpfcp-zoom-1.image)

```
@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
 

    @Autowired
    private SysRoleService sysUserService;

    @Autowired
    private SysUserMapper sysUserMapper;

    @Override
    public SysUser getByUserName(String username) {
 
        return getOne(new QueryWrapper<SysUser>().eq("username",username));
    }

    @Override
    public String getUserAuthorityInfo(Long userId) {
 
        //通过用户id获取对应的角色信息

        String authority = null;

        //获取角色
        //通过用户id，查出对应的用户角色id，通过角色id查询，对应用户的角色信息
        List<SysRole> roles = sysUserService.list(new QueryWrapper<SysRole>().inSql("id", "select role_id from sys_user_role where user_id = " + userId));

        if(roles.size() > 0){
 
            String roleCode = roles.stream().map(r -> "ROLE_"+r.getCode()).collect(Collectors.joining(","));
            authority = roleCode;
        }
        //获取菜单操作权限
        List<Long> menuIds = sysUserMapper.getNavMenuIds(userId);



        return null;
    }
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8cf5746f88f24639b921adda46b661da~tplv-k3u1fbpfcp-zoom-1.image)![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b63b6ecf081e49cdad24773cf1bfbf58~tplv-k3u1fbpfcp-zoom-1.image)

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.itbluebox.springbootadminvue.mapper.SysUserMapper">

    <select id="getNavMenuIds" resultType="java.lang.Long">

        select
            DISTINCT rm.menu_id
        from
            sys_user_role ur
        left join sys_role_menu rm on ur.role_id = rm.role_id

        where ur.user_id = #{userId}

    </select>
</mapper>
```

完善SysUserServiceImpl

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fecd8ab9aa9343e688a9012c7ccd380d~tplv-k3u1fbpfcp-zoom-1.image)

```
/**
 * <p>
 *  服务实现类
 * </p>
 * @author itbluebox
 * @since 2022-05-26
 */
@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
 
    @Autowired
    private SysRoleService sysUserService;

    @Autowired
    private SysUserMapper sysUserMapper;

    @Autowired
    private SysMenuService sysMenuService;

    @Override
    public SysUser getByUserName(String username) {
 
        return getOne(new QueryWrapper<SysUser>().eq("username",username));
    }
    @Override
    public String getUserAuthorityInfo(Long userId) {
 
        //通过用户id获取对应的角色信息
        String authority = null;
        //获取角色编码
        //通过用户id，查出对应的用户角色id，通过角色id查询，对应用户的角色信息
        List<SysRole> roles = sysUserService.list(new QueryWrapper<SysRole>().inSql("id", "select role_id from sys_user_role where user_id = " + userId));
        if(roles.size() > 0){
 
            String roleCode = roles.stream().map(r -> "ROLE_"+r.getCode()).collect(Collectors.joining(","));
            authority = roleCode.concat(",");
        }
        //获取菜单操作权限
        List<Long> menuIds = sysUserMapper.getNavMenuIds(userId);
        if(menuIds.size() > 0){
 
            List<SysMenu> sysMenus = sysMenuService.listByIds(menuIds);
            String menuPerms = sysMenus.stream().map(m -> m.getPerms()).collect(Collectors.joining(","));
            authority = authority.concat(menuPerms);
        }
        return authority;
    }
}
```

完善JwtAuthenticationFilter

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ac10d72376543c79d3250c651416b0f~tplv-k3u1fbpfcp-zoom-1.image)

```
public class JwtAuthenticationFilter extends BasicAuthenticationFilter {
 

    @Autowired
    private JwtUtils jwtUtils;

    @Autowired
    private UserDetailServiceImpl userDetailService;

    @Autowired
    private SysUserService sysUserService;

    public JwtAuthenticationFilter(AuthenticationManager authenticationManager) {
 
        super(authenticationManager);
    }
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws IOException, ServletException {
 
        String jwt = request.getHeader(jwtUtils.getHeader());
        if(StrUtil.isBlankOrUndefined(jwt)){
 
            chain.doFilter(request,response);
            return;
        }
        Claims claim = jwtUtils.getClaimByToken(jwt);
        if(ObjectUtils.isEmpty(claim)){
 
            throw new JwtException("token 异常");
        }
        if(jwtUtils.isTokenExpired(claim)){
 
            throw new JwtException("token已经过期");
        }
        String username = claim.getSubject();

        SysUser sysUser = sysUserService.getByUserName(username);

        //获取用户的权限信息
        UsernamePasswordAuthenticationToken token =
                new UsernamePasswordAuthenticationToken(username,null,userDetailService.getUserAuthority(sysUser.getId()));
        SecurityContextHolder.getContext().setAuthentication(token);
        chain.doFilter(request,response);
    }
}
```

### 9、测试运行

<http://localhost:8081/captcha>

发起获取验证码请求

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f1b943b3ecc4acfb94b1f07930d497f~tplv-k3u1fbpfcp-zoom-1.image)

发起登录请求

<http://localhost:8081/login>

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38086dcf3b074c649a1bf160b7b0aaa4~tplv-k3u1fbpfcp-zoom-1.image)

复制token

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0365a83898cf4f2e9a2063f778533cff~tplv-k3u1fbpfcp-zoom-1.image)

粘贴到回去信息的header当中

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/be88623278e244f6a0954db8a656b8b4~tplv-k3u1fbpfcp-zoom-1.image)

发起获取信息请求： <http://localhost:8081/sys-user/list>

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a955c4b762f4f588aea4bbc3f28d4d1~tplv-k3u1fbpfcp-zoom-1.image)