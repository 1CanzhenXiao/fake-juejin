ä½œè€…ï¼šé—²é±¼æŠ€æœ¯â€”â€”æ–°å®¿
===========

èƒŒæ™¯ï¼š
===

å»å¹´ï¼Œé—²é±¼æ–°ä¸€ä»£å›¾ç‰‡åº“ PowerImage åœ¨ç»è¿‡ä¸€ç³»åˆ—ç°åº¦ã€é—®é¢˜ä¿®å¤ã€ä»£ç è°ƒä¼˜åï¼Œå·²å…¨é‡ç¨³å®šåº”ç”¨äºé—²é±¼ã€‚ç›¸å¯¹äºä¸Šä¸€ä»£ IFImageï¼ŒPowerImage ç»è¿‡è¿›ä¸€æ­¥çš„æ¼”è¿›ï¼Œé€‚åº”äº†æ›´å¤šçš„ä¸šåŠ¡åœºæ™¯ä¸æœ€æ–°çš„ flutter ç‰¹æ€§ï¼Œè§£å†³äº†ä¸€ç³»åˆ—ç—›ç‚¹ï¼šæ¯”å¦‚ï¼Œå› ä¸ºå®Œå…¨æŠ›å¼ƒäº†åŸç”Ÿçš„ ImageCacheï¼Œåœ¨ä¸åŸç”Ÿå›¾ç‰‡æ··ç”¨çš„åœºæ™¯ä¸‹ï¼Œä¼šè®©ä¸€äº›ä½é¢‘çš„å›¾ç‰‡åè€Œå ç”¨äº†ç¼“å­˜ï¼›æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨æ¨¡æ‹Ÿå™¨ä¸Šæ— æ³•å±•ç¤ºå›¾ç‰‡ï¼›æ¯”å¦‚æˆ‘ä»¬åœ¨ç›¸å†Œä¸­ï¼Œéœ€è¦åœ¨å›¾ç‰‡åº“ä¹‹å¤–å†æ­å»ºå›¾ç‰‡é€šé“ã€‚

ç®€ä»‹ï¼š
===

PowerImage æ˜¯ä¸€ä¸ªå……åˆ†åˆ©ç”¨ native åŸç”Ÿå›¾ç‰‡åº“èƒ½åŠ›ã€é«˜æ‰©å±•æ€§çš„flutterå›¾ç‰‡åº“ã€‚æˆ‘ä»¬å·§å¦™åœ°å°†å¤–æ¥çº¹ç†ä¸ ffi æ–¹æ¡ˆç»„åˆï¼Œä»¥æ›´è´´è¿‘åŸç”Ÿçš„è®¾è®¡ï¼Œè§£å†³äº†ä¸€ç³»åˆ—ä¸šåŠ¡ç—›ç‚¹ã€‚

**èƒ½åŠ›ç‰¹ç‚¹ï¼š**

*   â€¢ æ”¯æŒåŠ è½½ ui.Image èƒ½åŠ›ã€‚åœ¨åŸºäºå¤–æ¥çº¹ç†çš„æ–¹æ¡ˆä¸­ï¼Œä½¿ç”¨æ–¹æ— æ³•æ‹¿åˆ°çœŸæ­£çš„ ui.Image å»ä½¿ç”¨ï¼Œè¿™å¯¼è‡´å›¾ç‰‡åº“åœ¨è¿™ç§ç‰¹æ®Šçš„ä½¿ç”¨åœºæ™¯ä¸‹æ— èƒ½ä¸ºåŠ›ã€‚
*   â€¢ æ”¯æŒå›¾ç‰‡é¢„åŠ è½½èƒ½åŠ›ã€‚æ­£å¦‚åŸç”ŸprecacheImageä¸€æ ·ã€‚è¿™åœ¨æŸäº›å¯¹å›¾ç‰‡å±•ç¤ºé€Ÿåº¦è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚
*   â€¢ æ–°å¢çº¹ç†ç¼“å­˜ï¼Œä¸åŸç”Ÿå›¾ç‰‡åº“ç¼“å­˜æ‰“é€šï¼ç»Ÿä¸€å›¾ç‰‡ç¼“å­˜ï¼Œé¿å…åŸç”Ÿå›¾ç‰‡æ··ç”¨å¸¦æ¥çš„å†…å­˜é—®é¢˜ã€‚
*   â€¢ æ”¯æŒæ¨¡æ‹Ÿå™¨ã€‚åœ¨ flutter-1.23.0-18.1.preä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæ¨¡æ‹Ÿå™¨æ— æ³•å±•ç¤º Texture Widgetã€‚
*   â€¢ å®Œå–„è‡ªå®šä¹‰å›¾ç‰‡ç±»å‹é€šé“ã€‚è§£å†³ä¸šåŠ¡è‡ªå®šä¹‰å›¾ç‰‡è·å–è¯‰æ±‚ã€‚
*   â€¢ å®Œå–„çš„å¼‚å¸¸æ•è·ä¸æ”¶é›†ã€‚
*   â€¢ æ”¯æŒåŠ¨å›¾ã€‚ï¼ˆæ¥è‡ªæ·˜ç‰¹çš„PRï¼‰

Flutter åŸç”Ÿæ–¹æ¡ˆï¼š
=============

åœ¨ä»‹ç»æ–°æ–¹æ¡ˆå¼€å§‹ä¹‹å‰ï¼Œå…ˆç®€å•å›å¿†ä¸€ä¸‹ flutter åŸç”Ÿå›¾ç‰‡æ–¹æ¡ˆã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c606cdb84b824c3a9d9e820a72dda550~tplv-k3u1fbpfcp-zoom-1.image "null")

åŸç”Ÿ Image Widget å…ˆé€šè¿‡ ImageProvider å¾—åˆ° ImageStreamï¼Œé€šè¿‡ç›‘å¬å®ƒçš„çŠ¶æ€ï¼Œè¿›è¡Œå„ç§çŠ¶æ€çš„å±•ç¤ºã€‚æ¯”å¦‚`frameBuilder`ã€`loadingBuilder`ï¼Œæœ€ç»ˆåœ¨å›¾ç‰‡åŠ è½½æˆåŠŸåï¼Œä¼š `rebuild` å‡º `RawImage`ï¼Œ`RawImage` ä¼šé€šè¿‡ `RenderImage` æ¥ç»˜åˆ¶ï¼Œæ•´ä¸ªç»˜åˆ¶çš„æ ¸å¿ƒæ˜¯ `ImageInfo` ä¸­çš„ `ui.Image`ã€‚

*   â€¢ Imageï¼šè´Ÿè´£å›¾ç‰‡åŠ è½½çš„å„ä¸ªçŠ¶æ€çš„å±•ç¤ºï¼Œå¦‚åŠ è½½ä¸­ã€å¤±è´¥ã€åŠ è½½æˆåŠŸå±•ç¤ºå›¾ç‰‡ç­‰ã€‚
*   â€¢ ImageProviderï¼šè´Ÿè´£ ImageStream çš„è·å–ï¼Œæ¯”å¦‚ç³»ç»Ÿå†…ç½®çš„ NetworkImageã€AssetImage ç­‰ã€‚
*   â€¢ ImageStreamï¼šå›¾ç‰‡èµ„æºåŠ è½½çš„å¯¹è±¡ã€‚

åœ¨æ¢³ç† flutter åŸç”Ÿå›¾ç‰‡æ–¹æ¡ˆä¹‹åï¼Œæˆ‘ä»¬å‘ç°æ˜¯ä¸æ˜¯æœ‰æœºä¼šåœ¨æŸä¸ªç¯èŠ‚å°† flutter å›¾ç‰‡å’Œ native ä»¥åŸç”Ÿçš„æ–¹å¼æ‰“é€šï¼Ÿ

æ–°ä¸€ä»£æ–¹æ¡ˆï¼š
======

æˆ‘ä»¬å·§å¦™åœ°å°† FFi æ–¹æ¡ˆä¸å¤–æ¥çº¹ç†æ–¹æ¡ˆç»„åˆï¼Œè§£å†³äº†ä¸€ç³»åˆ—ä¸šåŠ¡ç—›ç‚¹ã€‚

### FFIï¼š

æ­£å¦‚å¼€å¤´è¯´çš„é‚£äº›é—®é¢˜ï¼ŒTexture æ–¹æ¡ˆæœ‰äº›åšä¸åˆ°çš„äº‹æƒ…ï¼Œè¿™éœ€è¦å…¶ä»–æ–¹æ¡ˆæ¥äº’è¡¥ï¼Œè¿™å…¶ä¸­æ ¸å¿ƒéœ€è¦çš„å°±æ˜¯ `ui.Image`ã€‚æˆ‘ä»¬æŠŠ native å†…å­˜åœ°å€ã€é•¿åº¦ç­‰ä¿¡æ¯ä¼ é€’ç»™ flutter ä¾§ï¼Œç”¨äºç”Ÿæˆ `ui.Image`ã€‚

é¦–å…ˆ native ä¾§å…ˆè·å–å¿…è¦çš„å‚æ•°ï¼ˆä»¥ iOS ä¸ºä¾‹ï¼‰ï¼š

        _rowBytes = CGImageGetBytesPerRow(cgImage);        CGDataProviderRef dataProvider = CGImageGetDataProvider(cgImage);    CFDataRef rawDataRef = CGDataProviderCopyData(dataProvider);    _handle = (long)CFDataGetBytePtr(rawDataRef);        NSData *data = CFBridgingRelease(rawDataRef);    self.data = data;    _length = data.length;

dart ä¾§æ‹¿åˆ°å

    @override  FutureOr<ImageInfo> createImageInfo(Map map) {    Completer<ImageInfo> completer = Completer<ImageInfo>();    int handle = map['handle'];    int length = map['length'];    int width = map['width'];    int height = map['height'];    int rowBytes = map['rowBytes'];    ui.PixelFormat pixelFormat =        ui.PixelFormat.values[map['flutterPixelFormat'] ?? 0];    Pointer<Uint8> pointer = Pointer<Uint8>.fromAddress(handle);    Uint8List pixels = pointer.asTypedList(length);    ui.decodeImageFromPixels(pixels, width, height, pixelFormat,        (ui.Image image) {      ImageInfo imageInfo = ImageInfo(image: image);      completer.complete(imageInfo);      //é‡Šæ”¾ native å†…å­˜      PowerImageLoader.instance.releaseImageRequest(options);    }, rowBytes: rowBytes);    return completer.future;  }

æˆ‘ä»¬å¯ä»¥é€šè¿‡ ffi æ‹¿åˆ° native å†…å­˜ï¼Œä»è€Œç”Ÿæˆ ui.Imageã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œè™½ç„¶é€šè¿‡ ffi èƒ½ç›´æ¥è·å– native å†…å­˜ï¼Œä½†æ˜¯ç”±äº `decodeImageFromPixels` ä¼šæœ‰å†…å­˜æ‹·è´ï¼Œåœ¨æ‹·è´è§£ç åçš„å›¾ç‰‡æ•°æ®æ—¶ï¼Œå†…å­˜å³°å€¼ä¼šæ›´åŠ ä¸¥é‡ã€‚

è¿™é‡Œæœ‰ä¸¤ä¸ªä¼˜åŒ–æ–¹å‘ï¼š

1.  1\. è§£ç å‰çš„å›¾ç‰‡æ•°æ®ç»™ flutterï¼Œç”± flutter æä¾›çš„è§£ç å™¨è§£ç ï¼Œä»è€Œå‰Šå‡å†…å­˜æ‹·è´å³°å€¼ã€‚
2.  2\. ä¸ flutter å®˜æ–¹è®¨è®ºï¼Œå°è¯•ä»å†…éƒ¨å‡å°‘è¿™æ¬¡å†…å­˜æ‹·è´ã€‚

FFI è¿™ç§æ–¹å¼é€‚åˆè½»åº¦ä½¿ç”¨ã€ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ï¼Œæ”¯æŒè¿™ç§æ–¹å¼å¯ä»¥è§£å†³æ— æ³•è·å– ui.Image çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥åœ¨æ¨¡æ‹Ÿå™¨ä¸Šå±•ç¤ºå›¾ç‰‡ï¼ˆflutter <= 1.23.0-18.1.preï¼‰ï¼Œå¹¶ä¸”å›¾ç‰‡ç¼“å­˜å°†å®Œå…¨äº¤ç»™ ImageCache ç®¡ç†ã€‚

### Textureï¼š

Texture æ–¹æ¡ˆä¸åŸç”Ÿç»“åˆæœ‰ä¸€äº›éš¾åº¦ï¼Œè¿™é‡Œæ¶‰åŠåˆ°æ²¡æœ‰ `ui.Image` åªæœ‰ textureIdã€‚è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š

é—®é¢˜ä¸€ï¼šImage Widget éœ€è¦ `ui.Image` å» build `RawImage` ä»è€Œç»˜åˆ¶ï¼Œè¿™åœ¨æœ¬æ–‡å‰é¢çš„Flutter åŸç”Ÿæ–¹æ¡ˆä»‹ç»ä¸­ä¹Ÿæåˆ°äº†ã€‚ é—®é¢˜äºŒï¼šImageCache ä¾èµ– ImageInfo ä¸­ `ui.Image` çš„å®½é«˜è¿›è¡Œ cache å¤§å°è®¡ç®—ä»¥åŠç¼“å­˜å‰çš„æ ¡éªŒã€‚ é—®é¢˜ä¸‰ï¼šnative ä¾§ texture ç”Ÿå‘½å‘¨æœŸç®¡ç†

éƒ½æœ‰è§£å†³æ–¹æ¡ˆï¼š

é—®é¢˜ä¸€ï¼šé€šè¿‡è‡ªå®šä¹‰ Image è§£å†³ï¼Œé€å‡º imageBuilder æ¥è®©å¤–éƒ¨è‡ªå®šä¹‰å›¾ç‰‡ widget é—®é¢˜äºŒï¼šä¸º Texture è‡ªå®šä¹‰ `ui.image`ï¼Œå¦‚ä¸‹ï¼š

    import 'dart:typed_data';import 'dart:ui' as ui show Image;import 'dart:ui';class TextureImage implements ui.Image {  int _width;  int _height;  int textureId;  TextureImage(this.textureId, int width, int height)      : _width = width,        _height = height;  @override  void dispose() {    // TODO: implement dispose  }  @override  int get height => _height;  @override  Future<ByteData> toByteData(      {ImageByteFormat format = ImageByteFormat.rawRgba}) {    // TODO: implement toByteData    throw UnimplementedError();  }  @override  int get width => _width;}

è¿™æ ·çš„è¯ï¼ŒTextureImage å®é™…ä¸Šå°±æ˜¯ä¸ªå£³ï¼Œä»…ä»…ç”¨æ¥è®¡ç®— cache å¤§å°ã€‚ å®é™…ä¸Šï¼ŒImageCache è®¡ç®—å¤§å°ï¼Œå®Œå…¨æ²¡å¿…è¦ç›´æ¥æ¥è§¦åˆ° ui.Imageï¼Œå¯ä»¥ç›´æ¥æ‰¾ ImageInfo å–ï¼Œè¿™æ ·çš„è¯å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥å…·ä½“çœ‹ @çš“é»¯ çš„ ISSUE ä¸ PRã€‚

é—®é¢˜ä¸‰ï¼šå…³äº native ä¾§æ„ŸçŸ¥ flutter image é‡Šæ”¾æ—¶æœºçš„é—®é¢˜

ä¿®æ”¹çš„ ImageCache é‡Šæ”¾å¦‚ä¸‹(éƒ¨åˆ†ä»£ç )ï¼š

    typedef void HasRemovedCallback(dynamic key, dynamic value);class RemoveAwareMap<K, V> implements Map<K, V> {  HasRemovedCallback hasRemovedCallback;  ...}//------  final RemoveAwareMap<Object, _PendingImage> _pendingImages = RemoveAwareMap<Object, _PendingImage>();//------void hasImageRemovedCallback(dynamic key, dynamic value) {    if (key is ImageProviderExt) {      waitingToBeCheckedKeys.add(key);    }    if (isScheduledImageStatusCheck) return;    isScheduledImageStatusCheck = true;    //We should do check in MicroTask to avoid if image is remove and add right away    scheduleMicrotask(() {      waitingToBeCheckedKeys.forEach((key) {        if (!_pendingImages.containsKey(key) &&            !_cache.containsKey(key) &&            !_liveImages.containsKey(key)) {          if (key is ImageProviderExt) {            key.dispose();          }        }      });      waitingToBeCheckedKeys.clear();      isScheduledImageStatusCheck = false;    });  }

æ•´ä½“æ¶æ„ï¼š
=====

æˆ‘ä»¬å°†ä¸¤ç§è§£å†³æ–¹æ¡ˆéå¸¸ä¼˜é›…åœ°ç»“åˆåœ¨äº†ä¸€èµ·ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b6b1e7fef1b492cacfd8d92d7a96713~tplv-k3u1fbpfcp-zoom-1.image "null")

æˆ‘ä»¬æŠ½è±¡å‡ºäº† PowerImageProvider ï¼Œå¯¹äº externalï¼ˆffiï¼‰ã€textureï¼Œåˆ†åˆ«ç”Ÿäº§è‡ªå·±çš„ ImageInfo å³å¯ã€‚å®ƒå°†é€šè¿‡å¯¹ PowerImageLoader çš„è°ƒç”¨ï¼Œæä¾›ç»Ÿä¸€çš„åŠ è½½ä¸é‡Šæ”¾èƒ½åŠ›ã€‚

è“è‰²å®çº¿çš„ ImageExt å³ä¸ºè‡ªå®šä¹‰çš„ Image Widgetï¼Œä¸º texture æ–¹å¼é€å‡ºäº† imageBuilderã€‚

è“è‰²è™šçº¿ ImageCacheExt å³ä¸º ImageCache çš„æ‰©å±•ï¼Œä»…åœ¨ flutter < 2.2.0 ç‰ˆæœ¬æ‰éœ€è¦ï¼Œå®ƒå°†æä¾› ImageCache é‡Šæ”¾æ—¶æœºçš„å›è°ƒã€‚

è¿™æ¬¡ï¼Œæˆ‘ä»¬ä¹Ÿè®¾è®¡äº†è¶…å¼ºçš„æ‰©å±•èƒ½åŠ›ã€‚é™¤äº†æ”¯æŒç½‘ç»œå›¾ã€æœ¬åœ°å›¾ã€flutter èµ„æºã€native èµ„æºå¤–ï¼Œæˆ‘ä»¬æä¾›äº†è‡ªå®šä¹‰å›¾ç‰‡ç±»å‹çš„é€šé“ï¼Œflutter å¯ä»¥ä¼ é€’ä»»ä½•è‡ªå®šä¹‰çš„å‚æ•°ç»„åˆç»™ nativeï¼Œåªè¦ native æ³¨å†Œå¯¹åº”ç±»å‹ loaderï¼Œæ¯”å¦‚ã€Œç›¸å†Œã€è¿™ç§åœºæ™¯ï¼Œä½¿ç”¨æ–¹å¯ä»¥è‡ªå®šä¹‰ imageType ä¸º album ï¼Œnative ä½¿ç”¨è‡ªå·±çš„é€»è¾‘è¿›è¡ŒåŠ è½½å›¾ç‰‡ã€‚æœ‰äº†è¿™ä¸ªè‡ªå®šä¹‰é€šé“ï¼Œç”šè‡³å›¾ç‰‡æ»¤é•œéƒ½å¯ä»¥ä½¿ç”¨ PowerImage è¿›è¡Œå±•ç¤ºåˆ·æ–°ã€‚

é™¤äº†å›¾ç‰‡ç±»å‹çš„æ‰©å±•ï¼Œæ¸²æŸ“ç±»å‹ä¹Ÿå¯è¿›è¡Œè‡ªå®šä¹‰ã€‚æ¯”å¦‚åœ¨ä¸Šé¢ ffi ä¸­è¯´çš„ï¼Œä¸ºäº†é™ä½å†…å­˜æ‹·è´å¸¦æ¥çš„å³°å€¼é—®é¢˜ï¼Œä½¿ç”¨æ–¹å¯ä»¥åœ¨ flutter ä¾§è¿›è¡Œè§£ç ï¼Œå½“ç„¶è¿™éœ€è¦ native å›¾ç‰‡åº“æä¾›è§£ç å‰çš„æ•°æ®ã€‚

æ•°æ®ï¼š
===

### FFI vs Textureï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eda30dc6b30c40d49b21f807b92f929a~tplv-k3u1fbpfcp-zoom-1.image "null")

    æœºå‹ï¼šiPhone 11 Proï¼›å›¾ç‰‡ï¼š300 å¼ ç½‘ç»œå›¾ï¼›è¡Œä¸ºï¼šåœ¨listViewä¸­æ‰‹åŠ¨æ»šåŠ¨åˆ°åº•éƒ¨å†æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼›native Cacheï¼š20 maxMemoryCount; flutter Cacheï¼š30MBflutter version 2.5.3; release æ¨¡å¼ä¸‹

è¿™é‡Œæœ‰ä¸¤ä¸ªç°è±¡ï¼š

    FFIï¼š   186MBæ³¢åŠ¨Textureï¼š 194MBæ³¢åŠ¨

åœ¨ 2.5.3 ç‰ˆæœ¬ä¸­ï¼ŒTexture æ–¹æ¡ˆä¸ FFIï¼Œåœ¨å†…å­˜æ°´ä½ä¸Šå·®å¼‚ä¸å¤§ï¼Œå†…å­˜æ³¢åŠ¨ä¸Šé¢ä¸ flutter 1.22 ç»“è®ºç›¸åã€‚

å›¾ä¸­æ£‹æ ¼å›¾ï¼Œä¸ºæ‰“å¼€ `checkerboardRasterCacheImages` åæ‰€å±•ç¤ºï¼Œå¯ä»¥çœ‹å‡ºï¼Œffiæ–¹æ¡ˆä¼šç¼“å­˜æ•´ä¸ªcellï¼Œè€Œtextureæ–¹æ¡ˆï¼Œåªæœ‰cellä¸­çš„æ–‡å­—è¢«ç¼“å­˜ï¼ŒRasterCache ä¼šä½¿å¾— ffi åœ¨æµç•…åº¦æ–¹é¢ä¼šæœ‰ä¸€å®šä¼˜åŠ¿ã€‚

### æ»šåŠ¨æµç•…æ€§åˆ†æï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa63df832a674f778b65720966fb1a28~tplv-k3u1fbpfcp-zoom-1.image "null")

    è®¾å¤‡: Android OnePlus 8tï¼ŒCPUå’ŒGPUè¿›è¡Œäº†é”é¢‘ã€‚case: GridViewæ¯è¡Œ4å¼ å›¾ç‰‡ï¼Œ300å¼ å›¾ç‰‡ï¼Œä»ä¸Šå¾€ä¸‹ï¼Œå†ä»ä¸‹å¾€ä¸Šï¼Œæ»‘åŠ¨å¹…åº¦ä»500ï¼Œ1000ï¼Œ1500ï¼Œ2000ï¼Œ2500ï¼Œ5è½®æ»‘åŠ¨ã€‚é‡å¤20æ¬¡ã€‚æ–¹å¼: for i in {1..20}; do flutter drive --target=test_driver/app.dart --profile; done è·‘æ•°æ®ï¼Œè·å–TimeLineæ•°æ®å¹¶åˆ†æã€‚

ç»“è®ºï¼š

*   â€¢ UI thread è€—æ—¶ texture æ–¹å¼æœ€å¥½ï¼ŒPowerImage ç•¥å¥½äº IFImageï¼ŒFFIæ–¹å¼æ³¢åŠ¨æ¯”è¾ƒå¤§ã€‚
*   â€¢ Raster thread è€—æ—¶ PowerImage å¥½äº IFImageã€‚Origin åŸç”Ÿæ–¹å¼å¥½æ˜¯å› ä¸ºå¯¹å›¾ç‰‡ resizeäº†ï¼Œå…¶ä»–æ–¹å¼åŠ è½½çš„æ˜¯åŸå›¾ã€‚

### æ›´ç²¾ç®€çš„ä»£ç ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/35bea20c017a493986d333b688803e04~tplv-k3u1fbpfcp-zoom-1.image "null")

dart ä¾§ä»£ç æœ‰è¾ƒå¤§å¹…åº¦çš„å‡å°‘ï¼Œè¿™å½’åŠŸäºæŠ€æœ¯æ–¹æ¡ˆè´´åˆ flutter åŸç”Ÿè®¾è®¡ï¼Œæˆ‘ä»¬ä¸åŸç”Ÿå›¾ç‰‡å…±ç”¨è¾ƒå¤šä»£ç ã€‚

FFI æ–¹æ¡ˆè¡¥å…¨äº†å¤–æ¥çº¹ç†çš„ä¸è¶³ï¼Œéµå¾ªåŸç”Ÿ Image çš„è®¾è®¡è§„èŒƒï¼Œä¸ä»…è®©æˆ‘ä»¬äº«å—åˆ° ImageCache å¸¦æ¥çš„ç»Ÿä¸€ç®¡ç†ï¼Œä¹Ÿå¸¦æ¥äº†æ›´ç²¾ç®€çš„ä»£ç ã€‚

### å•æµ‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7be93c063dee429b91facda66b64376b~tplv-k3u1fbpfcp-zoom-1.image "null")

ä¸ºäº†ä¿è¯æ ¸å¿ƒä»£ç çš„ç¨³å®šæ€§ï¼Œæˆ‘ä»¬æœ‰ç€è¾ƒä¸ºå®Œå–„çš„å•æµ‹ï¼Œè¡Œè¦†ç›–ç‡æ¥è¿‘95%ã€‚

å…³äºå¼€æºï¼š
=====

æˆ‘ä»¬æœŸå¾…é€šè¿‡ç¤¾åŒºçš„åŠ›é‡è®© PowerImage æ›´åŠ å®Œå–„ä¸å¼ºå¤§ï¼Œä¹Ÿå¸Œæœ› PowerImage èƒ½ä¸ºå¤§å®¶åœ¨å·¥ç¨‹ç ”å‘ä¸­å¸¦æ¥æ”¶ç›Šã€‚

### Issuesï¼š

å…³äº issueï¼Œæˆ‘ä»¬å¸Œæœ›å¤§å®¶åœ¨ä½¿ç”¨ PowerImage é‡åˆ°é—®é¢˜ä¸è¯‰æ±‚æ—¶ï¼Œç§¯æäº¤æµï¼Œæå‡º issue æ—¶å°½å¯èƒ½æä¾›è¯¦ç»†çš„ä¿¡æ¯ï¼Œä»¥å‡å°‘æ²Ÿé€šæˆæœ¬ã€‚åœ¨æå‡º issue å‰ï¼Œè¯·ç¡®ä¿å·²é˜…è¯» readmeã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f55d6b86351c4d808f0dff6905d4e179~tplv-k3u1fbpfcp-zoom-1.image "null")

å¯¹äº bug çš„ issueï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†æ¨¡æ¿ï¼ˆBug reportï¼‰ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¡«ä¸€äº›å¿…è¦çš„ä¿¡æ¯ã€‚å…¶ä»–ç±»å‹åˆ™å¯ä»¥é€‰æ‹© `Open a blank issue`ã€‚

æˆ‘ä»¬æ¯å‘¨ä¼šèŠ±éƒ¨åˆ†æ—¶é—´ç»Ÿä¸€å¤„ç† issuesï¼Œä¹ŸæœŸå¾…å¤§å®¶çš„è®¨è®ºä¸ PRã€‚

### PRï¼š

ä¸ºäº†ä¿æŒ PowerImage æ ¸å¿ƒåŠŸèƒ½çš„ç¨³å®šæ€§ï¼Œæˆ‘ä»¬æœ‰ç€å®Œå–„çš„å•æµ‹ï¼Œè¡Œè¦†ç›–ç‡è¾¾åˆ°äº† 95%ï¼ˆpower\_imageåº“ï¼‰ã€‚

åœ¨æäº¤PRæ—¶ï¼Œè¯·ç¡®ä¿æ‰€æäº¤çš„ä»£ç è¢«å•æµ‹è¦†ç›–åˆ°ï¼Œå¹¶ä¸”æ¶‰åŠåˆ°çš„å•æµ‹ä»£ç è¯·åŒæ—¶æäº¤ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/988cd76996e34fcd94c798a7a86eadd7~tplv-k3u1fbpfcp-zoom-1.image "null")

å¾—ç›Šäº Github çš„ Actions èƒ½åŠ›ï¼Œæˆ‘ä»¬åœ¨ä¸»åˆ†æ”¯ push ä»£ç ã€å¯¹ä¸»åˆ†æ”¯è¿›è¡Œ PR æ“ä½œæ—¶ï¼Œéƒ½ä¼šè§¦å‘ `flutter test`ä»»åŠ¡ï¼Œåªæœ‰å•æµ‹é€šè¿‡æ‰å¯åˆå…¥ã€‚

æœªæ¥ï¼š
===

å¼€æºæ˜¯ PowerImage çš„å¼€å§‹ï¼Œè€Œä¸æ˜¯ç»“æŸï¼ŒPowerImage å¯åšçš„äº‹æƒ…è¿˜æœ‰å¾ˆå¤šï¼Œæœ‰è¶£è€Œä¸°å¯Œã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ª issue ä¸­æè¿°çš„ `loadingBuilder` å¦‚ä½•å®ç°ï¼Ÿæ¯”å¦‚ ffi æ–¹æ¡ˆå¦‚ä½•æ”¯æŒåŠ¨å›¾ï¼Ÿå†æ¯”å¦‚Kotlinå’ŒSwiftÂ·Â·Â·

PowerImage æœªæ¥å°†æŒç»­æ¼”è¿›ï¼Œåœ¨å½“å‰ texture æ–¹æ¡ˆä¸ ffi æ–¹æ¡ˆå…±å­˜çš„æƒ…å†µä¸‹ï¼Œä¼´éšç€ flutter æœ¬èº«çš„è¿­ä»£ï¼Œæˆ‘ä»¬å°†æ›´å€¾å‘äºå‘ ffi å‘å±•ï¼Œæ­£å¦‚åœ¨ä¸Šæ–‡çš„å¯¹æ¯”ä¸­ï¼Œ ffi æ–¹æ¡ˆå¯ä»¥å¤©ç„¶äº«ç”¨ raster cache æ‰€å¸¦æ¥çš„æµç•…åº¦çš„ä¼˜åŠ¿ã€‚

PowerImage ä¹Ÿä¼šæŒç»­è¿½éš flutter çš„è„šæ­¥ï¼Œä»¥å§‹ç»ˆè´´åˆåŸç”Ÿçš„è®¾è®¡ç†å¿µï¼Œä¸æ–­è¿›æ­¥ï¼Œæˆ‘ä»¬å¸Œæœ›æ›´å¤šçš„åŒå­¦åŠ å…¥è¿›æ¥ï¼Œå…±åŒæˆé•¿ã€‚

å…¶ä»–å››ä¸ªFlutterå¼€æºé¡¹ç›®:Â Â é—²é±¼æŠ€æœ¯å…¬ä¼—å·-é—²é±¼å¼€æº
------------------------------

PowerImageç›¸å…³é“¾æ¥ï¼š
---------------

### GitHubï¼šï¼ˆâœ…starğŸŒŸï¼‰

https://github.com/alibaba/power\_image

Flutter pubï¼šï¼ˆâœ…likeğŸ‘ï¼‰

https://pub.dev/packages/power\_image