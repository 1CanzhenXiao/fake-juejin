# chatRobotè®¾è®¡æ€»ç»“

```
ğŸ’æœ¬æ–‡æ˜¯åšä¸»å‘¨æœ«åšçš„å°ç©æ„ï¼Œ
ğŸ”ˆå¤§é‡å‚è€ƒäº†è¯¥åšæ–‡ï¼šhttps://blog.csdn.net/NIeson2012/article/details/96476878 
ä»¥åŠåä¸º https://support.huaweicloud.com/cbs/index.htmlã€
ç™¾åº¦ https://cloud.baidu.com/doc/SPEECH/index.html å®˜æ–¹æŠ€æœ¯æ–‡æ¡£ã€‚
æœ‰éœ€è¦çš„æœ‹å‹å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚
ğŸ‘€åä¸ºåå°è¯­æ–™åº“éœ€è‡ªè¡Œï¼ˆtiaoï¼‰é…ç½®ï¼ˆjiaoï¼‰ https://download.csdn.net/download/m0_66681776/86269857 å¯ç›´æ¥ä¸‹è½½æºæ–‡ä»¶
```

## 1 å‡†å¤‡å·¥ä½œ
- vscode
- anaconda
- ç™¾åº¦è´¦å·ï¼ˆå·²å®åï¼‰
- åä¸ºè´¦å·ï¼ˆå·²å®åï¼‰

**åœ¨ç™¾åº¦äº‘å®˜ç½‘  äº§å“->äººå·¥æ™ºèƒ½->è¯­éŸ³æŠ€æœ¯->çŸ­æ–‡æœ¬åˆæˆ->ç«‹å³ä½¿ç”¨->â€¦â€¦** åˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼ˆå¯ä»¥è¯•ç”¨ï¼Œè·Ÿç€æç¤ºèµ°å°±å¥½ï¼‰  

**åä¸ºäº‘å®˜ç½‘ä¹Ÿä¸€æ ·ï¼Œåœ¨äº§å“é‡Œæ‰¾åˆ°æ™ºèƒ½è¯­éŸ³äº¤äº’æœºå™¨äººCBS** ï¼Œä¹Ÿæ˜¯ç”³è¯·è¯•ç”¨ï¼ˆåšä¸»ä½œä¸ºå­¦ç”Ÿï¼Œå±å®è´Ÿæ‹…ä¸èµ·åŸä»·&#129402;ï¼‰

åç»­çš„APP_IDä¹‹ç±»çš„ä¹Ÿåœ¨è¿™äº›é‡Œé¢æ‰¾å°±è¡Œï¼ŒæŠ€æœ¯æ–‡æ¡£é‡Œæœ‰ç›´è¾¾é“¾æ¥ï¼Œå¾ˆæ–¹ä¾¿ğŸ™‚ã€‚

ç”¨anacondaåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒï¼ˆå¯¹äºä¸åŒçš„é¡¹ç›®æœ€å¥½ç›¸äº’ç¯å¢ƒç‹¬ç«‹ï¼‰ï¼Œæœ€å¥½æ˜¯pythonç‰ˆæœ¬3.6ï¼Œé«˜ç‰ˆæœ¬æœ‰äº›åº“ä¸æ”¯æŒã€‚

å®‰è£…`pygame`ã€`pyaudio`ã€`baidu-sip`ã€`huaweicloudsdkcore`å’Œ`huaweicloudsdkcbs`åº“ï¼ˆpipå’Œcondaéƒ½è¯•ä¸€è¯•ï¼Œå“ªä¸ªè¡Œç”¨å“ªä¸ªğŸ˜†ï¼‰

## 2 è®¾è®¡æ€è·¯
```flow
st=>start: å¼€å§‹ç¨‹åº
op=>operation: å½•åˆ¶éŸ³é¢‘å¹¶å­˜å‚¨ï¼šä½¿ç”¨pyaudioåº“è¿›è¡Œå½•åˆ¶ï¼Œwaveåº“è¿›è¡Œ.wavæ–‡ä»¶çš„å­˜å‚¨
op1=>operation: è¯†åˆ«éŸ³é¢‘æ–‡ä»¶ï¼šä¸Šä¼ è‡³ç™¾åº¦AIå¹³å°SDKé‰´æƒè°ƒç”¨API
è¿”å›sentenceï¼šå¯¹è¿”å›çš„å†…å®¹è¿›è¡ŒæŠ½å–
cd=>condition: sentence is not "é€€å‡ºç¨‹åº"
op2=>operation: ä¸Šä¼ sentenceï¼šä¸Šä¼ è‡³åä¸ºAIå¹³å°SDKé‰´æƒè°ƒç”¨API
è¿”å›responseï¼šå¯¹è¿”å›çš„å†…å®¹è¿›è¡ŒæŠ½å–
op3=>operation: è¯­éŸ³åˆæˆresponseï¼šä¸Šä¼ è‡³ç™¾åº¦â€¦â€¦
å­˜å‚¨éŸ³é¢‘æ–‡ä»¶ï¼šå¯¹è¿”å›çš„å†…å®¹â€¦â€¦
op4=>operation: æ’­æ”¾éŸ³é¢‘æ–‡ä»¶ï¼šä½¿ç”¨pygameåº“è¿›è¡Œæ’­æ”¾
end=>end: é€€å‡ºç¨‹åº

st->op->op1->cd
cd(yes)->op2->op3->op4->op
cd(no)->end
```

## 3 é¡¹ç›®æºç 

```
è¿™éƒ¨åˆ†åè€Œå¯¹åšä¸»è€Œè¨€æ˜¯æœ€ç®€å•çš„ï¼Œ
å½•éŸ³/æ’­æ”¾åœ¨CSDNæŸ¥æŸ¥å°±æœ‰å¾ˆå¤šï¼Œ
APIçš„è°ƒç”¨å®˜æ–¹æ–‡æ¡£å·²ç»æ¨ä¸å¾—æŠŠé¥­å–‚æˆ‘ä»¬åƒäº†ï¼Œ
ç®€ç®€å•å•`CV`ä¸€æ³¢ğŸ‰‘ã€‚
```

**æ–‡ä»¶å¤¹çš„æ¶æ„æŒ‰åšä¸»çš„æ¥ï¼Œè·¯å¾„éƒ½æ˜¯ç›¸å¯¹çš„ã€‚åšä¸»æ˜¯ç”¨çš„VSCï¼Œæ‰€ä»¥åœ¨launch.jsonå°†functionsè®¾ç½®ä¸ºæ ¹ç›®å½•ã€‚_pychae_æ˜¯åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è‡ªå·±å»ºç«‹èµ·æ¥çš„ã€‚**

```
chatRobot:
    |_>.vscode:
        |_>launch.json
    |_>conclusion:
        |_>conclusion.ipynb
        |_>conclusion.md
    |_>functions:
        |_>__init__.py
        |_>baidu.py
        |_>huawei.py
        |_>recoder.py
    |_>music:
        |_>myvoice.wav
        |_>robotVoice.mp3
    |_>secrets:
        |_>baiduSecrets.csv
        |_>huaweiSecrets.csv
    |_>tests:
        |_>test.py
    |_>main.py
```

### 3.1 recoderç±»

```python
"""
å‚è€ƒåšæ–‡:
    @author: https://nieson.blog.csdn.net/?type=blog
    @blog: https://blog.csdn.net/NIeson2012/article/details/96476878
"""
import wave
import time 
from pyaudio import PyAudio, paInt16
from pygame import mixer,quit

class recoder():
    
    def __init__(self, filepath="music/myvoice.wav") -> None:
        """_summary_

        Args:
            filepath (str): æ–‡ä»¶ä¿å­˜ä½ç½®
        """
        self.framerate = 16000
        self.num_samples = 2000
        self.channels = 1
        self.sampwidth = 2
        self.FILEPATH = filepath
    
    def save_wave_file(self, filepath: str, data: list) -> None :
        
        """_summary_

        Args:
            filepath (str): æ–‡ä»¶ä¿å­˜è·¯å¾„
            data (list): éŸ³é¢‘æ•°æ®
        """
        
        wf = wave.open(filepath, "wb")
        wf.setnchannels(self.channels)
        wf.setsampwidth(self.sampwidth)
        wf.setframerate(self.framerate)
        wf.writeframes(b''.join(data))
        wf.close()
    
    def recordVoice(self) -> None :
        
        """_function_
            è®°å½•å£°éŸ³
        """
        
        pa = PyAudio()
        #æ‰“å¼€ä¸€ä¸ªæ–°çš„éŸ³é¢‘stream
        stream = pa.open(format=paInt16, channels=self.channels,
                        rate=self.framerate, input=True, frames_per_buffer=self.num_samples)
        my_buf = [] #å­˜æ”¾å½•éŸ³æ•°æ®
 
        t = time.time()
        print('æ­£åœ¨å½•éŸ³...')
 
        while time.time() < t + 10:  # è®¾ç½®å½•éŸ³æ—¶é—´ï¼ˆç§’ï¼‰
    	    #å¾ªç¯readï¼Œæ¯æ¬¡read 2000frames
            string_audio_data = stream.read(self.num_samples)
            my_buf.append(string_audio_data)
        print('å½•éŸ³ç»“æŸ.')
        self.save_wave_file(self.FILEPATH, my_buf)
        stream.close()
        
    def playVoice(self, filepath="music/robotVoice.mp3"):
        """_summary_

        Args:
            filepath (_type_): å¾…æ’­æ”¾æ–‡ä»¶è·¯å¾„
        """
        mixer.init()
        mixer.music.load(filepath)
        mixer.music.play()
        time.sleep(10)
        mixer.music.stop()
        quit()


if __name__ == "__main__":
    recoder = recoder("music/myvoice.wav")
    recoder.recordVoice()
    recoder.playVoice("music/myvoice.wav")
```

### 3.2 huaweiç±»

```python
from huaweicloudsdkcore.auth.credentials import BasicCredentials
from huaweicloudsdkcore.exceptions import exceptions
from huaweicloudsdkcore.http.http_config import HttpConfig
# å¯¼å…¥CBSæœåŠ¡åº“huaweicloudsdkcbs
from huaweicloudsdkcbs.v1.region.cbs_region import CbsRegion
from huaweicloudsdkcbs.v1 import *

import codecs
import csv

class huawei():
    
    def __init__(self) -> None:
        
        """_function_
        
            è¯»å–secretså†…çš„å„ç±»å¯†åŒ™
        """

        with codecs.open('secrets/huaweiSecrets.csv', encoding='utf-8-sig') as f:
            for row in csv.DictReader(f, skipinitialspace=True):
                self.project_id = row["Project ID"]
                self.qabot_id = row["qabot_id"]
                self.ak = row["Access Key Id"]
                self.sk = row["Secret Access Key"]
    
    def getResponse(self, sentence: str) -> str:
        
        """_summary_

        Args:
            sentence (str): å¾…å›å¤çš„è¯­å¥

        Returns:
            str: åå°é¢„è®¾å›å¤
        """
        
        # ä½¿ç”¨é»˜è®¤é…ç½®
        config = HttpConfig.get_default_config()
    
        # åˆå§‹åŒ–å®¢æˆ·ç«¯è®¤è¯ä¿¡æ¯ï¼Œä½¿ç”¨å½“å‰å®¢æˆ·ç«¯åˆå§‹åŒ–æ–¹å¼å¯ä¸å¡« project_id/domain_idï¼Œä»¥BasicCredentialsä¸ºä¾‹
        basic_credentials = BasicCredentials(self.ak, self.sk, self.project_id)

        # åˆå§‹åŒ–æŒ‡å®šäº‘æœåŠ¡çš„å®¢æˆ·ç«¯ {Service}Client ï¼Œä»¥åˆå§‹åŒ– Region çº§æœåŠ¡CBSçš„ CbsClient ä¸ºä¾‹
        client = CbsClient.new_builder() \
            .with_http_config(config) \
            .with_credentials(basic_credentials) \
            .with_region(CbsRegion.value_of("cn-north-4")) \
            .build()

        # ä»¥è°ƒç”¨é—®ç­”æœºå™¨äººä¼šè¯æ¥å£ExecuteQaChatä¸ºä¾‹
        request = ExecuteQaChatRequest()
        # qabot_idè·å–æ–¹æ³•å‚è€ƒæœ¬ç« èŠ‚â€œå‡†å¤‡å·¥ä½œâ€
        request.qabot_id = self.qabot_id
        request.body = PostRequestsReq(
            # session_idé¦–è½®ä¸éœ€è¦ä¼ å…¥æˆ–å¯ä¼ å…¥ä»»æ„å€¼ï¼Œç¬¬äºŒè½®å¼€å§‹ä½¿ç”¨ä¸Šä¸€è½®è¿”å›çš„session_id
            session_id="ad7a5010-3817...",
            question=sentence,
        )
        response = client.execute_qa_chat(request)
    
        # å¼‚å¸¸å¤„ç†
        try:
            request = ExecuteQaChatRequest()
            response = client.execute_qa_chat(request)
            print(response)
        except exceptions.ClientRequestException as e:
            pass
            # print(e.status_code)
            # print(e.request_id)
            # print(e.error_code)
            # print(e.error_msg)
    
        return response.qabot_answers.answers[0].answer[3:-4]
    
                
if __name__ == "__main__":
    huawei = huawei()
    print(huawei.project_id)
    print(huawei.getResponse("æ—©ä¸Šå¥½"))
```

### 3.3 baiduç±»

```python
from aip import AipSpeech
import codecs
import csv

class baidu():
    
    def __init__(self) -> None:
        
        """_function_
        
            è¯»å–secrets.csvå†…çš„å„ç±»å¯†åŒ™
        """
        
        with codecs.open('secrets/baiduSecrets.csv', encoding='utf-8-sig') as f:
            for row in csv.DictReader(f, skipinitialspace=True):
                self.APP_ID = row["APP_ID"]
                self.API_KEY = row["API_KEY"]
                self.SECRET_KEY = row["SECRET_KEY"]
        self.client = AipSpeech(self.APP_ID, self.API_KEY, self.SECRET_KEY)
    
    
        
    def getWords(self, filepath="music/myvoice.wav") -> str:
        
        """_summary_

        Args:
            filepath (str): å¾…è¯†åˆ«è¯­éŸ³

        Returns:
            str: è¯†åˆ«åå­—ç¬¦ä¸²
        """
        
        def get_file_content(filePath: str):
            with open(filePath, 'rb') as fp:
                return fp.read()
        
        result = self.client.asr(get_file_content(filepath), 'pcm', 16000, {
            'dev_pid': 1537,})
        return result["result"][0]
    
    def getVoice(self, sentence: str):
        
        filePath = "music/robotVoice.mp3"
        result  = self.client.synthesis(sentence, 'zh', 1, {
        'vol': 5, 'per': 111,
        })

        # è¯†åˆ«æ­£ç¡®è¿”å›è¯­éŸ³äºŒè¿›åˆ¶ é”™è¯¯åˆ™è¿”å›dict å‚ç…§ä¸‹é¢é”™è¯¯ç 
        if not isinstance(result, dict):
            with open(filePath, 'wb') as f:
                f.write(result)
                f.close()
                        
if __name__ == "__main__":
    baidu = baidu()
    print(baidu.APP_ID)
    response = baidu.getWords("music/myvoice.wav")
    print(response)
    baidu.getVoice("æ—©ä¸Šå¥½")
```

### 3.4 CSVæ–‡ä»¶

```CSV
IAM Name,IAM ID,Project ID,qabot_id,User Name,Access Key Id,Secret Access Key
******,******,******,******,******,******,******
APP_ID,API_KEY,SECRET_KEY
******,******,******
```

## 4 æ€»ç»“

æœ¬æ¬¡çš„å°é¡¹ç›®å®Œæˆçš„è¿˜ç®—æˆåŠŸï¼Œä½†æ˜¯å½•éŸ³/æ’­æ”¾åŠŸèƒ½å±å®å¾ˆæ‹‰èƒ¯ï¼Œæ˜¯å›ºå®šæ—¶é—´çš„ã€‚æœ‰ä¸ªæ€è·¯ï¼Œå‚ç…§å¾®ä¿¡ç”¨ç©ºæ ¼é”®æ§åˆ¶è¯­éŸ³çš„è¾“å…¥ä¸è¾“å‡ºï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è¯•è¯•ğŸ’¡ã€‚  

ç‚¹èµğŸ‘æ”¶è—ğŸ”¸åŠ å…³æ³¨ğŸ’–ï¼Œå›çœ‹ä¸è¿·è·¯ï¼