è¿™æ˜¯æˆ‘å‚ä¸2022é¦–æ¬¡æ›´æ–‡æŒ‘æˆ˜çš„ç¬¬8å¤©ï¼Œæ´»åŠ¨è¯¦æƒ…æŸ¥çœ‹ï¼š[2022é¦–æ¬¡æ›´æ–‡æŒ‘æˆ˜](https://juejin.cn/post/7052884569032392740)

å¾€æœŸç²¾å½©

ğŸ‘‰Â [Flutter å¿…çŸ¥å¿…ä¼šç³»åˆ—â€”â€”ä¸‰é¢—æ ‘åˆ°åº•æ˜¯ä»€ä¹ˆ](https://juejin.cn/post/7057356671948947464)

ğŸ‘‰ [Flutter å¿…çŸ¥å¿…ä¼šç³»åˆ—â€”â€” Element çš„æ›´æ–°å¤ç”¨æœºåˆ¶](https://juejin.cn/post/7058170445706559496)

å‰é¢æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸‰æ£µæ ‘ã€Element çš„æ›´æ–°æœç”¨ï¼Œéƒ½æœ‰ç‚¹åç†è®ºï¼Œè¿™ä¸€ç¯‡æ–‡ç« ï¼Œå°±ä»å‡ ä¸ªå®é™…çš„ä¾‹å­æ¥æ£€éªŒä¹‹å‰çš„çŸ¥è¯†ç‚¹ã€‚

ä»¥ä¸‹æ˜¯æ­£æ–‡

---

# æ¡ˆä¾‹ç®€ä»‹

æ¡ˆä¾‹çš„åŸºæœ¬åŠŸèƒ½å°±æ˜¯**ç‚¹å‡»æŒ‰é’®äº¤æ¢è‰²å—**ã€‚\
æ¡ˆä¾‹çš„è¯¦ç»†ä»£ç å¯ä»¥åœ¨è¿™é‡Œçœ‹ ğŸ‘‰ [æ¡ˆä¾‹ä»£ç ](https://github.com/ShzMinato/sFlutter/tree/main/flutter_update) 

æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

## StatelessColor

ä½¿ç”¨ StatelessWidget æ˜¾ç¤ºè‰²å—ï¼Œä»£ç å¦‚ä¸‹ï¼š

```dart
class StatelessColor extends StatelessWidget {
  final Color defaultColor = UniqueColorGenerator().getColor();

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 100,
      width: 100,
      child: Container(
        color: defaultColor,
      ),
    );
  }

  StatelessColor({Key? key}) : super(key: key);
}
```

## StatefulColor 

ä½¿ç”¨ StatefulWidget æ˜¾ç¤ºè‰²å—ï¼Œä»£ç å¦‚ä¸‹ï¼š

```dart
class StatefulColorfulTileState extends State<StatefulColor> {
  final Color defaultColor = UniqueColorGenerator().getColor();

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 100,
      width: 100,
      child: Container(
        color: defaultColor,
      ),
    );
  }
}
```
## UniqueColorGenerator

éšæœºäº§ç”Ÿé¢œè‰²ï¼Œä»£ç å¦‚ä¸‹ï¼š

```dart
class UniqueColorGenerator {
  List<Color> colorList = [
    Colors.blue,
    Colors.yellow,
    Colors.red,
    Colors.black54,
    Colors.greenAccent,
    Colors.pinkAccent
  ];

  Random random = Random();

  Color getColor() {
    return colorList[random.nextInt(6)];
  }
}
```

# æ¡ˆä¾‹ä¸€ï¼šäº¤æ¢ Statelessçš„Color

æˆ‘ä»¬çœ‹è¿è¡Œçš„ä»£ç ï¼š

```dart
class _SwapColorDemo1State extends State<SwapColorDemo1> {
  late List<Widget> widgets;

  @override
  void initState() {
    super.initState();
    widgets = [StatelessColor(), StatelessColor()]; //ç¬¬ä¸€å¤„
  }

  swapTile() {
    setState(() {
      widgets.insert(1, widgets.removeAt(0)); //ç¬¬ä¸‰å¤„
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Stateless'),
      ),
      body: SafeArea(
        child: Row( // ç¬¬äºŒå¤„
          children: widgets,
        ),
      ),
      floatingActionButton: FloatingActionButton(
        child: const Icon(Icons.swap_horiz),
        onPressed: swapTile, //ç¬¬ä¸‰å¤„
      ),
    );
  }
}
```
æˆ‘ä»¬çœ‹è¿™å°±æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„é¡µé¢ï¼Œé¡µé¢ä¸Šæœ‰ä¸¤ä¸ª**éšæœºé¢œè‰²çš„100\*100çš„è‰²å—**ã€‚\
ç‚¹å‡»å³ä¸‹è§’çš„æŒ‰é’®ï¼Œäº¤æ¢è‰²å—ï¼Œå¹¶åˆ·æ–°é¡µé¢ã€‚\

ç¬¬ä¸€å¤„ä»£ç ï¼šåœ¨é¡µé¢åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆå§‹åŒ–ä¸¤ä¸ªè‰²å—ã€‚\
ç¬¬äºŒå¤„ä»£ç ï¼šä½¿ç”¨ Row ç»„ä»¶ï¼ŒåŒ…è£¹ä¸¤ä¸ªè‰²å—ã€‚\
ç¬¬ä¸‰å¤„ä»£ç ï¼šç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œåˆ·æ–°é¡µé¢ï¼Œå®ç°äº¤æ¢è‰²å—çš„åŠŸèƒ½

```dart
widgets.insert(1, widgets.removeAt(0)); 
 
æ•°ç»„ä¸€å¼€å§‹ ï¼šA  B

widgets.removeAt(0) å–å¾—æ˜¯Aï¼Œå¹¶ä¸”æ•°ç»„æ˜¯ B

insert åœ¨1å·ä½æ’å…¥A
 
ç»“æœå°±æ˜¯ï¼šB A

åç»­åŒæ ·çš„é“ç†ï¼Œå°±å®ç°äº†äº¤æ¢ã€‚
```

å¤§å®¶è§‰å¾—å¯ä»¥å®ç°äº¤æ¢å—ï¼Ÿ**è‚¯å®šæ˜¯å¯ä»¥çš„** ğŸ˜„ã€‚


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6e186fb49af460da009a7c9850b894a~tplv-k3u1fbpfcp-watermark.image?)

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹åŸå› ã€‚é€šè¿‡å‰é¢æˆ‘ä»¬çš„å‡ ç¯‡æ–‡ç« çŸ¥é“äº†ï¼š**Widget æ˜¯è¦æ˜¾ç¤ºçš„ UI é…ç½®ï¼ŒElement æ ¹æ® Widget å»çœŸæ­£çš„æ˜¾ç¤º UI**ã€‚ ç”±äºæˆ‘ä»¬çš„é¢œè‰²å­˜åœ¨ **Widget** ä¸­ï¼Œé‚£èƒ½åšåˆ°å›¾å—äº¤æ¢çš„ï¼Œå°±æ˜¯ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

> Element çš„ widget æŒ‡å‘äº† æ–°Widgetï¼Œæ¯”å¦‚åŸæ¥ Element æŒ‡å‘çš„ ç²‰çº¢è‰²çš„ Widgetï¼Œç°åœ¨æŒ‡å‘çš„æ˜¯é»„è‰² Widgetã€‚
>
> æ ¹æ®äº¤æ¢åçš„ Widgetï¼Œé‡æ–°ç”Ÿæˆ Elementã€‚æ¯”å¦‚æŠŠåŸæ¥æ‰¿è½½çº¢è‰² Widget çš„ Elementï¼Œé”€æ¯æ‰å¹¶æ ¹æ®é»„è‰² Widget çš„ç”Ÿæˆ Elementã€‚
>
> ç›´æ¥äº¤æ¢ Element ã€‚æ¯”å¦‚æŠŠçº¢è‰²å’Œé»„è‰²çš„ Element ä½ç½®è¿›è¡Œäº¤æ¢

ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„ä»£ç å±äºä¸Šé¢çš„å“ªä¸€ç§æƒ…å†µã€‚

å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œä¼šè§¦å‘ build æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘ Row æ§ä»¶çš„æ›´æ–°ï¼ŒRow å¯¹åº”çš„ Element æ˜¯ **MultiChildRenderObjectElement**ï¼Œå®ƒçš„æ›´æ–°å°±ä¼šæ‰§è¡Œåˆ° ğŸ‘‰ [updateChildren æ–¹æ³•](https://juejin.cn/post/7058170445706559496#heading-12)ã€‚


Row çš„å­ç»„ä»¶ æ˜¯è¿™æ ·çš„ï¼š

![æ¡ˆä¾‹ä¸€åˆå§‹åŒ–ä»£ç .png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6be9fc4767bd4f32a4e5f08320375bd3~tplv-k3u1fbpfcp-watermark.image?)

å› æ­¤åœ¨ **updateChildren** æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åªä¼šåœç•™åœ¨ç¬¬ä¸€æ­¥çš„å¾ªç¯ ----- **è‡ªä¸Šè€Œä¸‹ diff å¹¶æ›´æ–°å­èŠ‚ç‚¹**

> å› ä¸º Widget.canUpdate è¿”å›çš„æ˜¯trueã€‚ æ–°æ—§çš„ Widget çš„ runtimeType éƒ½æ˜¯ StatelessColorï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬æ²¡æœ‰æ‰‹åŠ¨è®¾ç½® Keyï¼Œæ‰€ä»¥æ–°æ—§ Widget çš„ key å±æ€§æ˜¯ nullã€‚
>
> æ‰€ä»¥ canUpdate è¿”å› trueã€‚ framework å°±è®¤ä¸ºè¦å¤ç”¨ Element äº†ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°äº†æ›´æ–° child çš„æ“ä½œã€‚

ğŸ‘‡æˆ‘ä»¬çœ‹æ˜¯å¦‚ä½•æ›´æ–° child çš„ã€‚

è¿™é‡Œå›å¿†ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰è®²è¿‡çš„ï¼ŒupdateChild çš„è¡¨æ ¼ï¼š

![è¡¨æ ¼.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6331a54de0ac4905952a2fb1d0007b80~tplv-k3u1fbpfcp-watermark.image?)

**æ¡ˆä¾‹ä¸€ä¸­çš„å…¥å‚æƒ…å†µï¼š**

child æ˜¯æ—§ Element newWidgets æ˜¯è¦æ˜¾ç¤ºçš„ widgetï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„Widgetï¼Œäº¤æ¢ä¹‹åçš„ Widget

é€šè¿‡ä¸Šé¢çš„æ›´æ–°åˆ¤æ–­è¡¨æ ¼ï¼Œæ‰§è¡Œå¤ç”¨æ›´æ–°çš„é€»è¾‘ã€‚

```dart
 Element updateChild(Element child, Widget newWidget, dynamic newSlot) {
 Â  Â  Â   ...
 Â  Â  Â   //keyå’ŒruntimeTypeä¸€æ · å°±å¯ä»¥å¤ç”¨ ç¬¬å››å¤„
 Â  Â  Â   child.update(newWidget);
 Â  Â  Â   ...
  }

```

æ‰§è¡Œçš„æ˜¯ **ç¬¬å››å¤„ä»£ç çš„é€»è¾‘**ã€‚ child æ˜¯æ‰¿è½½ StatelessColor çš„ Elementï¼Œè€Œ StatelessColor å°±æ˜¯ StatelessWidgetï¼Œæ‰€ä»¥ **child å°±æ˜¯ [StatelessElement](https://juejin.cn/post/7058170445706559496#heading-7)ã€‚**

è¿˜è®°å¾— [StatelessElement](https://juejin.cn/post/7058170445706559496#heading-7) çš„æ›´æ–°é€»è¾‘å—ï¼Ÿ å°±æ˜¯è°ƒç”¨å…¶ Widget çš„ build æ–¹æ³•ã€‚

![Untitled Diagram.drawio.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/522e5330ea7e4a899bfc73b5c763b73f~tplv-k3u1fbpfcp-watermark.awebp?)

æ˜¾ç¤ºçš„ UI å°±æ˜¯ Element æŒæœ‰çš„ Widget å¯¹è±¡çš„ build æ–¹æ³•è¿”å›çš„ UIï¼Œæˆ‘ä»¬å°†é¢œè‰²çš„ä¿¡æ¯ä¿å­˜åœ¨ Widget ä¸­ï¼Œå› æ­¤å°±ä¼šæ­£å¸¸çš„äº’æ¢é¢œè‰²ã€‚


![æ¡ˆä¾‹ä¸€.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8677307ff425479da9a67e987f2ebf69~tplv-k3u1fbpfcp-watermark.image?)

å›¾ä¸­çš„åº•å—ä»£è¡¨çš„æ˜¯ Elementï¼Œæ–‡å­—ä»£è¡¨ Widgetã€‚**Elementæ²¡æœ‰æ”¹å˜ï¼Œåªæ˜¯å°†æŒ‡å‘çš„ Widge tæ”¹å˜äº†**ï¼Œè¿™å°±æ˜¯é¢œè‰²äº’æ¢ç°è±¡çš„åŸå› ã€‚

## å°ç»“

StatelessWidget é¢œè‰²æ›¿æ¢çš„åŸå› ï¼š
-   å¤ç”¨äº† Elementï¼Œå¹¶æ›´æ–°äº† Element æŒ‡å‘çš„ Widget
-   Widget æ˜¯ StatelessWidgetï¼Œé¢œè‰²å­˜å‚¨åœ¨Widget ä¸­ã€‚

# æ¡ˆä¾‹äºŒï¼šäº¤æ¢ Stateful çš„Color


é¡µé¢çš„ä¸»ä½“ä»£ç å’ŒåŠŸèƒ½ä¸å˜ ğŸ‘‰ [è¯¦ç»†ä»£ç ](https://github.com/ShzMinato/sFlutter/blob/main/flutter_update/lib/widget/keys/swap_color_2.dart)ï¼Œåªæ˜¯å°† `StatelessColor` æ›¿æ¢ä¸º `StatefulColor`ã€‚




![æ¡ˆä¾‹äºŒ 33%.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7384339bc601466ba2b07fd33cde01a3~tplv-k3u1fbpfcp-watermark.image?)

**ä»ç°è±¡æ¥çœ‹ï¼Œå›¾å—æ²¡æœ‰è¿›è¡Œäº¤æ¢**ã€‚

é‚£æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œä¸ºå•¥ä» StatelessWidget æ›¿æ¢ä¸º StatefulWidget ä¹‹åï¼Œé¢œè‰²å’‹å°±ä¸å˜åŒ–äº†ã€‚

å’Œæ¡ˆä¾‹ä¸€çš„åˆ†æ ç›¸ä¼¼ï¼ŒåŒæ ·ä¼šæ‰§è¡Œåˆ° **`updateChildren`** æ–¹æ³•ã€‚

![image-20220129141216945.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d3c189b464445028eb58463e4bd2715~tplv-k3u1fbpfcp-watermark.image?)

å¹¶ä¸”åœ¨ updateChildren æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åŒæ ·åªä¼šåœç•™åœ¨ç¬¬ä¸€æ­¥çš„å¾ªç¯ ----- **è‡ªä¸Šè€Œä¸‹ diff å¹¶æ›´æ–°å­èŠ‚ç‚¹**ã€‚ 

æœ‰äº†æ¡ˆä¾‹ä¸€åˆ†æï¼Œæˆ‘ä»¬ç›´æ¥èµ°åˆ° updateChild ä¸­ï¼Œåªä¸è¿‡æ¯ä¸ª child çš„ç±»å‹ä» **StatelessElement** å˜ä¸º **StatefulElement**ã€‚è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š

![Untitled Diagram.drawio (1).png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1bb891dbaa044c22aba4f9410110f688~tplv-k3u1fbpfcp-watermark.awebp?)

å’Œæ¡ˆä¾‹ä¸€çš„ StatelessElemen tä¸åŒï¼Œè¿™é‡Œ Element ç”Ÿæˆçš„ UI æ˜¯ Stateå¯¹è±¡çš„ build æ–¹æ³•ï¼Œæˆ‘ä»¬çš„é¢œè‰²ä¹Ÿæ˜¯å­˜å‚¨åœ¨ State ä¸­çš„ï¼Œè€Œ **State çš„åˆå§‹åŒ–æ—¶æœºæ˜¯åœ¨ Element åˆå§‹åŒ–çš„æ—¶å€™**ã€‚å¦‚ä¸‹ä»£ç ï¼š

```dart
StatefulElement(StatefulWidget widget)
 Â   : _state = widget.createState(),
 Â  Â  Â super(widget) {
 Â state._element = this;
 Â state._widget = widget;
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼š**Element å’Œ State å¯¹è±¡æ˜¯åŒç”Ÿå…±æ­»çš„**ï¼ŒElement æ˜¯å¤ç”¨çš„ï¼Œå› æ­¤ Element çš„ State å¼•ç”¨æ˜¯ä¸å˜çš„ï¼Œè€Œæˆ‘ä»¬é¢œè‰²å­˜å‚¨åœ¨ State å¯¹è±¡ä¸­ï¼Œä»è€Œå¯¼è‡´ï¼šElement åªæ˜¯æ›¿æ¢äº† Widgetï¼Œé¢œè‰²æ²¡æœ‰å˜åŒ–ã€‚ 

æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š


![æ¡ˆä¾‹äºŒ åŸå› å›¾.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68a50ad83a7d40ef8b6747c51a544379~tplv-k3u1fbpfcp-watermark.image?)

## å°ç»“

StatefulWidget é¢œè‰²ä¸æ›¿æ¢çš„åŸå› ï¼š

-   å¤ç”¨äº† Elementï¼Œå¹¶æ›´æ–°äº† Element æŒ‡å‘çš„ Widget
-   `Element æŒæœ‰çš„ State å¼•ç”¨æ²¡æœ‰å˜åŒ–`ï¼Œé¢œè‰²å­˜å‚¨åœ¨ State å¯¹è±¡ä¸­


# æ¡ˆä¾‹ä¸‰ï¼šäº¤æ¢å¸¦æœ‰ Key å±æ€§çš„ Stateful çš„Color

åœ¨è¯¦ç»†ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸ªç‚¹ `Slot` æ§½ç‚¹ä¿¡æ¯ã€‚

## Slot æ§½ç‚¹ä¿¡æ¯

**æ§½ç‚¹** æ˜¯æŒ‡ Element åœ¨å…¶çˆ¶èŠ‚ç‚¹çš„ä½ç½®ï¼Œå¦‚æœçˆ¶ Element æ˜¯å•èŠ‚ç‚¹çš„ Elementï¼Œé‚£ä¹ˆå­èŠ‚ç‚¹çš„æ§½ç‚¹å°±æ˜¯ nullã€‚

å¦‚æœçˆ¶ Element æ˜¯å¤šèŠ‚ç‚¹çš„ Elementï¼Œé‚£ä¹ˆå­èŠ‚ç‚¹çš„æ§½ç‚¹å°±æ˜¯ä½ç½®ä¿¡æ¯(**IndexedSlot**) \
IndexedSlot æ˜¯ä¸€ä¸ªå°è£…ç±»ï¼Œå°è£…äº† index ç´¢å¼•å’Œæ§½ç‚¹å€¼ï¼Œç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çš„æ§½ç‚¹å€¼æ˜¯ nullï¼Œç¬¬äºŒä¸ªå­èŠ‚ç‚¹çš„æ§½ç‚¹å€¼æ˜¯å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»¥æ­¤æ¬¡ç±»æ¨ã€‚ã€
å› æ­¤é€šè¿‡æ§½ç‚¹ï¼Œå°±å¯ä»¥å¾—åˆ°ä½ç½®ã€‚


**æ§½ç‚¹çš„ç¡®å®šæ˜¯åœ¨ mount æ–¹æ³•ä¸­**ã€‚

å•èŠ‚ç‚¹çš„æ§½ç‚¹ï¼š

![å•èŠ‚ç‚¹æ§½ç‚¹.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6f224f800bd4de08ff25a15e9353e17~tplv-k3u1fbpfcp-watermark.image?)

å¤šèŠ‚ç‚¹çš„æ§½ç‚¹ï¼š
![å¤šèŠ‚ç‚¹æ§½ç‚¹.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae62ab6d54064da7855a45c40b0e0660~tplv-k3u1fbpfcp-watermark.image?)

åœ¨ `updateChild` çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€åˆ¤æ–­ç‚¹å°±æ˜¯æ¯”è¾ƒæ§½ç‚¹ä¿¡æ¯ã€‚

```dart
///çœç•¥ä»£ç 
 Element? updateChild(Element? child, Widget? newWidget, Object? newSlot) {
 Â   final Element newChild;
 Â   if (child != null) {
 Â  Â   bool hasSameSuperclass = true;
 Â  Â   if (hasSameSuperclass && child.widget == newWidget) { //ç¬¬ä¸€å¤„
 Â  Â  Â   if (child.slot != newSlot)
 Â  Â  Â  Â   updateSlotForChild(child, newSlot);
 Â  Â  Â   newChild = child;
 Â  Â   } 
 Â   return newChild;
  }
```

å¦‚æœæ–°æ—§ Widget æ˜¯åŒä¸€ä¸ª Widgetã€‚åœ¨æ–°ä¸€å¸§çš„æ˜¾ç¤ºä¸­ï¼Œä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œåªæ›´æ–°ä¸€ä¸‹ä½ç½®ä¿¡æ¯ã€‚

## æ¡ˆä¾‹åˆ†æ

é¡µé¢çš„ä¸»ä½“ä»£ç å’ŒåŠŸèƒ½ä¸å˜ ğŸ‘‰ [è¯¦ç»†ä»£ç ](https://github.com/ShzMinato/sFlutter/blob/main/flutter_update/lib/widget/keys/swap_color_3.dart)ï¼Œå’Œæ¡ˆä¾‹äºŒç›¸æ¯” `StatefulColor` å¢åŠ äº† Key å±æ€§ã€‚



![æ¡ˆä¾‹ä¸‰åŸå›¾33%.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2348e7237a549148df34b5d242d7eca~tplv-k3u1fbpfcp-watermark.image?)


**ä»ç°è±¡æ¥çœ‹ï¼Œå›¾å—è¿›è¡Œäº†äº¤æ¢**ã€‚

è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰è¯´çš„å¯èƒ½çš„åŸå› å—ï¼Ÿ

> ä¸€ï¼šElement çš„ widget æŒ‡å‘äº† æ–°Widgetï¼Œæ¯”å¦‚åŸæ¥ Element æŒ‡å‘çš„ ç²‰çº¢è‰²çš„ Widgetï¼Œç°åœ¨æŒ‡å‘çš„æ˜¯é»„è‰² Widgetã€‚
>
> äºŒï¼šæ ¹æ®äº¤æ¢åçš„ Widgetï¼Œé‡æ–°ç”Ÿæˆ Elementã€‚æ¯”å¦‚æŠŠåŸæ¥æ‰¿è½½çº¢è‰² Widget çš„ Elementï¼Œé”€æ¯æ‰å¹¶æ ¹æ®é»„è‰² Widget çš„ç”Ÿæˆ Elementã€‚
>
> ä¸‰ï¼šç›´æ¥äº¤æ¢ Element ã€‚æ¯”å¦‚æŠŠçº¢è‰²å’Œé»„è‰²çš„ Element ä½ç½®è¿›è¡Œäº¤æ¢

æ¡ˆä¾‹ä¸€èƒ½å¤Ÿäº¤æ¢æ˜¯å› ä¸ºç¬¬ä¸€ç‚¹åŸå› ã€‚

ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸€ä¸‹ï¼Œæ¡ˆä¾‹ä¸‰å±äºä¸Šé¢çš„å“ªä¸€ç§æƒ…å†µã€‚

å’Œä¸Šé¢çš„åˆ†æç›¸ä¼¼ï¼ŒåŒæ ·ä¼šæ‰§è¡Œåˆ° updateChildren æ–¹æ³•ã€‚


![æ¡ˆä¾‹ä¸‰ä»£ç .png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a89096b91a6241019191181c6efc2ff8~tplv-k3u1fbpfcp-watermark.image?)

å’Œæ¡ˆä¾‹ä¸€ã€äºŒä¸ä¸€æ ·ï¼Œ**updateChildren** æ–¹æ³•ä»£ç ä¼šèµ°åˆ° ----- **å­˜å‚¨å¯å¤ç”¨çš„ Element**ã€‚

> å› ä¸ºæ¯æ¬¡diffçš„æ—¶å€™ï¼Œkeyæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥è·³è¿‡äº†æ­¥éª¤ä¸€ å’Œ æ­¥éª¤äºŒ æ¯”å¦‚åŸæ¥ç¬¬ä¸€ä¸ªä½ç½®çš„ Element çš„ Widget çš„ key æ˜¯ key1ï¼Œè¦æ˜¾ç¤ºçš„ Widget çš„ key æ˜¯ key2ï¼Œæ‰€ä»¥ diff éƒ½ä¼šè·³è¿‡

è¿™é‡Œèµ°å®Œç¬¬ä¸‰æ­¥éª¤ä¹‹åMapçš„æƒ…å†µå¦‚ä¸‹ï¼š

```
key1:Element1ï¼ˆWidgetæ˜¯1ï¼‰
key2:Element2ï¼ˆWidgetæ˜¯2ï¼‰
```

æŒ‰ç…§å¤„ç†çš„æµç¨‹ï¼šWidget2 çš„ key æ˜¯ key2ï¼Œå‘ç° Map ä¸­æœ‰ key2ï¼Œé‚£å°±å–å‡ºæ¥ Element2ã€‚ ä½†æ˜¯åŸæ¥ Element2 çš„å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯Element1ï¼Œ**ç°åœ¨Element2è¦æ˜¾ç¤ºåœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥å®ƒçš„ slot å˜ä¸ºäº†null**

å¤„ç†å®Œç¬¬ä¸‰æ­¥ï¼Œå°±å¼€å§‹é€æ­¥çš„æ›´æ–°ã€‚ç°åœ¨åŸæ¥æ˜¾ç¤º Widget1 çš„åœ°æ–¹ï¼Œç°åœ¨è¦æ˜¾ç¤º Widget2 ã€‚

æ‰€ä»¥ï¼š

```dart
 final Element newChild = updateChild(oldChild, newWidgetï¼ŒpreviousChild);
 å…¥å‚æƒ…å†µï¼š
 Â  Â oldChildï¼šæ˜¯Element2ï¼Œå¹¶ä¸”Element2çš„widgetæ˜¯Widget2
 Â  Â newWidgetï¼šæ˜¯widget2
 Â  Â previousChildï¼š null
-----------------------------------------------------------------------------
 Â  Â oldChildï¼šæ˜¯Element1ï¼Œå¹¶ä¸”Element1çš„widgetæ˜¯Widget1
 Â  Â newWidgetï¼šæ˜¯widget1
 Â  Â previousChildï¼š Element2
```

æ ¹æ®å…¥å‚æ•°çš„æƒ…å†µï¼ŒupdateChild æ–¹æ³•ä¹Ÿæ˜¯æ‰§è¡Œåˆ°äº† updateChild çš„ä»£ç ç¬¬ä¸‰å¤„ï¼Œä½†æ˜¯è£…åœ¨æ–°æ—§ Widget ç›¸åŒï¼Œä½†æ˜¯**æ§½ç‚¹ä¿¡æ¯ä¸ä¸€æ ·**ï¼Œä»è€Œå°† **Element çš„ä½ç½®è¿›è¡Œäº†äº¤æ¢**ï¼Œå°½è€Œ State è¿›è¡Œäº†äº¤æ¢ï¼Œæ‰€ä»¥é¢œè‰²æ‰ä¼šäº¤æ¢ã€‚ 

æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š

![æ¡ˆä¾‹ä¸‰åŸå› å›¾.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e130d9de9b5a405c86568eece412e50e~tplv-k3u1fbpfcp-watermark.image?)

æ³¨æ„è¿™ç§æƒ…å†µä¸‹ï¼Œ**State çš„ build æ–¹æ³•**ä¹Ÿä¸ä¼šæ‰§è¡Œå“¦ï½ã€‚

## å°ç»“

è®¾ç½® Key ä¹‹åï¼ŒStatefulWidget é¢œè‰²è¿›è¡Œäº†æ›¿æ¢çš„åŸå› ï¼š

-   å¤ç”¨äº† Elementï¼ŒElement çš„ Widgetã€State ä¿¡æ¯éƒ½è¿›è¡Œäº†ä¿ç•™
-   **æ›´æ–°äº† Element çš„ä½ç½®ä¿¡æ¯**

# æ¡ˆä¾‹å››

æˆ‘ä»¬ç»™ StatefulWidget åŒ…è£¹ä¸€ä¸ª Paddingï¼Œä»£ç æ¡ˆä¾‹åœ¨[SwapColorDemo4](https://github.com/ShzMinato/sFlutter/blob/main/flutter_update/lib/widget/keys/swap_color_4.dart)ç±»ä¸­ã€‚ä½†æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œ**è‰²å—ç«Ÿç„¶éšæœºå‡ºç°äº†**ã€‚


![æ¡ˆä¾‹å››åŸå›¾33%.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b17ee8ebc45b496f805250af40fd4ee0~tplv-k3u1fbpfcp-watermark.image?)

**ä»ç°è±¡æ¥çœ‹ï¼Œå›¾å—è¿›è¡Œäº†éšæœºäº¤æ¢ã€‚å’Œæ¡ˆä¾‹ä¸‰ç›¸æ¯”çš„è¯ï¼Œåªæ˜¯åŒ…è£¹äº†ä¸€å±‚**ã€‚ç»è¿‡äº†å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šéšæœºå‡ºç°é¢œè‰²ï¼Ÿ

> æˆ‘ä»¬çŸ¥é“é¢œè‰²å­˜åœ¨ State ä¸­ï¼Œé‚£å°±æ˜¯æ‰¿è½½ State çš„ Element é‡æ–°åˆ›å»ºäº†ã€‚
>
> é‚£ä»€ä¹ˆæ—¶å€™ä¼šé‡æ–°åˆ›å»ºå‘¢ï¼Œæ— æ³•å¤ç”¨çš„æ—¶å€™ã€‚
>
> é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±çœ‹ StatefulWidget çš„ Element çš„å­˜æ´»æƒ…å†µã€‚

åœ¨å¤„ç† Padding çš„è¿™ä¸€å±‚çš„æ—¶å€™ï¼Œå¤„ç†çš„æµç¨‹å’Œæ¡ˆä¾‹ä¸€ç›¸ä¼¼ã€‚åªä¼šåœç•™åœ¨ç¬¬ä¸€æ­¥çš„å¾ªç¯ ----- **`è‡ªä¸Šè€Œä¸‹ diff å¹¶æ›´æ–°å­èŠ‚ç‚¹`**

> å› ä¸ºæ–°æ—§çš„ Widget çš„ runtimeType éƒ½æ˜¯Paddingï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬æ²¡æœ‰æ‰‹åŠ¨è®¾ç½® Keyï¼Œæ‰€ä»¥æ–°æ—§ Widgetçš„key å±æ€§æ˜¯ nullã€‚æ‰€ä»¥ canUpdate è¿”å› trueã€‚<br> 
>framework è®¤ä¸ºè¦å¤ç”¨äº†ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°äº†æ›´æ–° child çš„æ“ä½œã€‚


```
 Â final Element newChild = updateChild(oldChild, newWidget, previousChild);
 Â å…¥å‚æƒ…å†µï¼š
 Â  oldChildæ˜¯æ—§Paddingçš„Element
 Â  newWidgetæ˜¯æ–°Padding
```

æ‰§è¡Œ Padding çš„ update æ–¹æ³•ï¼Œæ¥ä¸‹æ¥çš„å°±ä¸ç”¨ä»‹ç»äº†å§ã€‚\
åœ¨æ˜¾ç¤º Padding çš„ child çš„æ—¶å€™ï¼Œå‘ç°ä¸¤ä¸ª child çš„ Key ä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œåˆ°äº† updateChild çš„**é‡æ–°æ„é€ å­èŠ‚ç‚¹çš„é€»è¾‘**ï¼Œæ‰€ä»¥ä¿å­˜é¢œè‰²çš„ Stateï¼Œä¹Ÿè¿›è¡Œäº†é‡æ–°æ„é€ ã€‚

æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š


![æ¡ˆä¾‹å››åŸå› å›¾.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ae2a2d7cf9b4b74befc6b240478d329~tplv-k3u1fbpfcp-watermark.image?)

## å°ç»“

åŒ…è£¹ Padding ä¹‹åï¼ŒStatefulWidget é¢œè‰²éšæœºå‡ºç°çš„åŸå› ï¼š

-   å¤ç”¨äº† Padding çš„ Elementï¼Œä½†æ˜¯**ç”±äº Padding çš„ child å¸¦æœ‰Keyï¼Œå› æ­¤ Padding çš„å­èŠ‚ç‚¹ä¸ä¼šå¤ç”¨**ã€‚


# æ€»ç»“

è¿™ä¸ªå‡ ä¸ªå°ä¾‹å­ï¼Œæˆ‘ä»¬å°±çŸ¥é“ Flutter 99% çš„æ›´æ–°é€»è¾‘äº†ï¼Œè¿˜å‰© 1% æ˜¯ `
InheritedWidget
`ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢æ¥ç€å¥ä¹æ¥ç€èˆï½ã€‚





