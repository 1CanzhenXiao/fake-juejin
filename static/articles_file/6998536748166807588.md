---
theme: channing-cyan
highlight: darcula
---
/n
è¿™æ˜¯æˆ‘å‚ä¸8æœˆæ›´æ–‡æŒ‘æˆ˜çš„ç¬¬20å¤©ï¼Œæ´»åŠ¨è¯¦æƒ…æŸ¥çœ‹ï¼š[8æœˆæ›´æ–‡æŒ‘æˆ˜](https://juejin.cn/post/6987962113788493831)
#### å‰è¨€
æˆ‘ä»¬åœ¨å‰é¢èŠ±äº†å¾ˆå¤§ç¯‡å¹…ä»‹ç» `Provider` çŠ¶æ€ç®¡ç†ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ Flutter ä¸­ï¼Œ`Provider` æ˜¯ä¼—å¤šçŠ¶æ€ç®¡ç†æ’ä»¶çš„é¦–é€‰ã€‚æœ¬ç¯‡ä»¥å³æ—¶èŠå¤©ä¸ºä¾‹ï¼Œæ¥è®²è¿° `Provider` çš„ç»¼åˆåº”ç”¨ï¼Œä¹Ÿç®—æ˜¯ `Provider` çŠ¶æ€ç®¡ç†ç³»åˆ—çš„ç»ˆç»“ç¯‡ã€‚æœ¬ç¯‡æ¶‰åŠçš„å†…å®¹å¦‚ä¸‹ï¼š

- è”ç³»äººç•Œé¢çš„æ„å»ºï¼›
- èŠå¤©ç•Œé¢çš„ç®€å•å®ç°;
- StreamProvider æ¥æ”¶ Socketæµæ•°æ®å¹¶è‡ªåŠ¨é€šçŸ¥ç•Œé¢åˆ·æ–°;
- MultiProviderä¸ºèŠå¤©ä¸»ç•Œé¢æä¾›å¤šä¸ªProviderçŠ¶æ€;
- å¤šä¸ª Providerå­˜åœ¨äº¤å‰æ•°æ®æ—¶å¤„ç†æ–¹å¼ã€‚
#### è”ç³»äººç•Œé¢æ„å»º
æˆ‘ä»¬åœ¨èŠå¤©å‰ï¼Œéœ€è¦é€‰æ‹©å¯¹åº”çš„è”ç³»äººè¿›è¡Œå•èŠï¼Œå› æ­¤éœ€è¦æ„å»ºä¸€ä¸ªè”ç³»äººåˆ—è¡¨ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç®€å•çš„ ListView.builder+Mock æ•°æ®æ„å»ºè”ç³»äººåˆ—è¡¨ã€‚ç•Œé¢å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­å…³é”®çš„å°±æ˜¯ç‚¹å‡»è”ç³»äººæ—¶å°†è”ç³»äººçš„ idé€šè¿‡è·¯ç”±ä¼ é€’è¿‡å»ï¼Œä»¥ä¾¿å‘é€æ¶ˆæ¯æ—¶é€šè¿‡ç”¨æˆ· idæŒ‡å®šæ¥æ”¶ç”¨æˆ·ã€‚
```dart
return ListTile(
  leading: _getRoundImage(contactors[index].avatar, 50),
  title: Text(contactors[index].nickname),
  subtitle: Text(
    contactors[index].description,
    style: TextStyle(fontSize: 14.0, color: Colors.grey),
  ),
  onTap: () {
    debugPrint(contactors[index].id);
    RouterManager.router.navigateTo(context,
        '${RouterManager.chatPath}?toUserId=${contactors[index].id}');
  },
);
```
#### èŠå¤©ç•Œé¢çš„å®ç°
æˆ‘ä»¬å°†å‘é€çš„æ¶ˆæ¯æ”¾åœ¨å³è¾¹ï¼Œå°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ”¾åœ¨å·¦è¾¹ï¼Œè·åšè¿˜æ˜¯å±…å³é€šè¿‡ `Container` çš„ `margin` æ¥å®ç°ã€‚è‡³äºåŒºåˆ†ï¼Œé€šè¿‡æ¶ˆæ¯å¯¹è±¡çš„`fromUserId` æ¥åŒºåˆ†ï¼Œå¦‚æœ `fromUserId` å’Œå½“å‰ç”¨æˆ·`id` ä¸€è‡´ï¼Œåˆ™æ˜¯å‘é€å‡ºå»çš„æ¶ˆæ¯ï¼Œå¦åˆ™å°±æ˜¯æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å› ä¸ºè¿˜æ²¡æœ‰ç”¨æˆ·ä½“ç³»ï¼Œå…ˆå°†å½“å‰çš„ç”¨æˆ· `id` å†™æ­»ã€‚ä¸ºäº†å®ç°æ¨¡æ‹Ÿå™¨ä¹‹é—´çš„èŠå¤©ï¼Œæˆ‘ä»¬ä¸€ä¸ªæ¨¡æ‹Ÿå™¨è®¾ç½®ä¸º `user1`ï¼Œä¸€ä¸ªè®¾ç½®ä¸º `user2`ã€‚ç•Œé¢ä¹Ÿæ˜¯ä½¿ç”¨`ListView.builder`(ä¸‡èƒ½ä¸ï¼Ÿ)æ„å»ºã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4260272ad35044c18189ee9b4a0b9e52~tplv-k3u1fbpfcp-zoom-1.image)

```dart
return ListView.builder(
  itemBuilder: (context, index) {
    MessageEntity message = messages[index];
    double margin = 20;
    double marginLeft = message.fromUserId == 'user1' ? 60 : margin;
    double marginRight = message.fromUserId == 'user1' ? margin : 60;
    return Container(
      margin: EdgeInsets.fromLTRB(marginLeft, margin, marginRight, margin),
      padding: EdgeInsets.all(15),
      alignment: message.fromUserId == 'user1'
          ? Alignment.centerRight
          : Alignment.centerLeft,
      decoration: BoxDecoration(
          color: message.fromUserId == 'user1'
              ? Colors.green[300]
              : Colors.blue[400],
          borderRadius: BorderRadius.circular(10)),
      child: Text(
        message.content,
        style: TextStyle(color: Colors.white),
      ),
    );
  },
  itemCount: messages.length,
);
```
èŠå¤©ç•Œé¢çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯ä¼šæ¥æ”¶`StreamProvider` æ¨é€çš„æœ€æ–°çš„æ¶ˆæ¯ï¼Œä¸ºäº†ç»Ÿä¸€ï¼Œæˆ‘ä»¬å°†æ¥æ”¶æ¶ˆæ¯å’Œå‘é€æ¶ˆæ¯éƒ½é€šè¿‡`StreamProvider`æ¨é€æ›´æ–°ç•Œé¢ã€‚
```dart
// å‘é€æ¶ˆæ¯æ—¶å°†æ¶ˆæ¯åŠ å…¥åˆ°æµæ§åˆ¶å™¨ä¸­
void sendMessage(String event, T message) {
  _socket.emit(event, message);
  _socketResponse.sink.add(message);
}

// æ¥æ”¶æ¶ˆæ¯æ—¶ä¹ŸåŠ å…¥åˆ°æµæ§åˆ¶å™¨ä¸­
_socket.on(recvEvent, (data) {
  _socketResponse.sink.add(data);
});
```
è¿™æ ·ä¸ç®¡æ˜¯æ¥æ”¶æ¶ˆæ¯è¿˜æ˜¯å‘é€æ¶ˆæ¯éƒ½ä¼šé€šè¿‡ `StreamProvider` é‡æ–°æ„å»ºèŠå¤©ç•Œé¢ã€‚é‚£é—®é¢˜æ¥äº†ï¼ŒèŠå¤©åˆ—è¡¨æ•°æ®å¦‚ä½•åˆ·æ–°å‘¢ï¼Ÿ
#### æ¶ˆæ¯ç•Œé¢çš„ MultiProvider
æ¶ˆæ¯ç•Œé¢éœ€è¦æ¥æ”¶ `StreamProvider` çš„æ¶ˆæ¯æµï¼Œè¿˜éœ€è¦ä½¿ç”¨æ¶ˆæ¯åˆ—è¡¨æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† `MultiProvider`ã€‚å…¶ä¸­æ¶ˆæ¯å‘é€æ¡†å’ŒèŠå¤©ç•Œé¢å…±ç”¨ `ChatMessageModel`ï¼ˆä»…ä¸ºæ¼”ç¤ºï¼Œå®é™…å¯ä»¥æ‹†åˆ†å¼€ï¼‰ã€‚
```dart
final chatMessageModel = ChatMessageModel();
//...
body: Stack(
  alignment: Alignment.bottomCenter,
  children: [
    MultiProvider(
      providers: [
        StreamProvider<Map<String, dynamic>?>(
            create: (context) => streamSocket.getResponse,
            initialData: null),
        ChangeNotifierProvider.value(value: chatMessageModel)
      ],
      child: StreamDemo(),
    ),
    ChangeNotifierProvider.value(
      child: MessageReplyBar(messageSendHandler: (message) {
        Map<String, String> json = {
          'fromUserId': 'user1',
          'toUserId': widget.toUserId,
          'contentType': 'text',
          'content': message
        };
        streamSocket.sendMessage('chat', json);
      }),
      value: chatMessageModel,
    ),
]

//...
```
å…¶ä¸­`ChatMessageModel`å³æ¶ˆæ¯åˆ—è¡¨çŠ¶æ€æ•°æ®ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡æ•°ç»„å’Œä¸€ä¸ªæ·»åŠ æ¶ˆæ¯æ–¹æ³•ï¼Œä»¥åŠä¸€ä¸ª `content` å±æ€§æ˜¯ç»™æ¶ˆæ¯å›å¤æ¡†ä½¿ç”¨çš„ã€‚
â€‹

è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ`StreamProvider` æ¨é€ `StreamSocket`è¿‡æ¥çš„æ¶ˆæ¯çš„æ—¶å€™ï¼Œ `ChatMessageModel` å…¶å®æ˜¯ä¸çŸ¥é“çš„ã€‚å¦‚æœè¦çŸ¥é“ï¼Œä¸€ä¸ªåŠæ³•å°±æ˜¯åœ¨ `StreamSocket` å¼•ç”¨ `ChatMessageModel`å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶ `addMessage` æ–¹æ³•æ·»åŠ æ¶ˆæ¯ã€‚ä½†æ˜¯è¿™æ ·ä¼šå¢åŠ ä¸¤ä¸ªç±»çš„è€¦åˆã€‚è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯å–å·§çš„æ–¹å¼äº†ï¼Œé‚£å°±æ˜¯ `StreamdDemo`çš„ `build` æ–¹æ³•èƒ½å¤Ÿè·å–åˆ° `StreamSocket` æ¨é€çš„æœ€æ–°æ¶ˆæ¯ï¼Œåœ¨è¿™é‡Œè¯»å–åˆ°æœ€æ–°çš„æ¶ˆæ¯åå°±å¯ä»¥æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨äº†ã€‚ç”±äºå‰é¢æˆ‘ä»¬å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯éƒ½å°†æ¶ˆæ¯åŠ å…¥åˆ°äº†æ¶ˆæ¯æµä¸­ï¼Œè¿™æ ·å¤„ç†æ–¹å¼å°±ç»Ÿä¸€äº†ã€‚

è¿™ç§æ–¹å¼éœ€è¦æ³¨æ„ï¼Œ`Provider` ä¸å…è®¸åœ¨ç»„ä»¶çš„`build` æ–¹æ³•ä¸­å†æ¬¡è°ƒç”¨ç±»ä¼¼ `notifyListeners` çš„æ–¹æ³•é€šçŸ¥è¯¥ç»„ä»¶åˆ·æ–°ï¼Œå› æ­¤åœ¨ `ChatMessageModel`çš„ `addMessage` æ–¹æ³•é‡Œä¸å¯ä»¥ä½¿ç”¨`notifyListeners`æ¥é€šçŸ¥ç»„ä»¶åˆ·æ–°ï¼Œå¦åˆ™ä¼šå‡ºç°åŒä¸€ç»„ä»¶åˆ·æ–°å†²çªã€‚å®é™…ä¸Šï¼Œå› ä¸ºå¦ä¸€ä¸ª`Provider` å·²ç»é€šçŸ¥è¯¥ç»„ä»¶åˆ·æ–°äº†ï¼Œå› æ­¤ä¹Ÿæ²¡å¿…è¦å†é€šçŸ¥äº†ã€‚å½“ç„¶ï¼Œè¿™ä»…ä»…æ˜¯ä¸€ç§å–å·§æ–¹æ³•ï¼Œå‡è®¾è¿™ä¸ª`addMessage` æ–¹æ³•è¿˜éœ€è¦é€šçŸ¥å…¶ä»–ç»„ä»¶åˆ·æ–°ï¼Œé‚£è¿™ç§å½¢å¼å°±å°±ä¸å¯å–äº†ã€‚
```dart
class ChatMessageModel with ChangeNotifier {
  List<MessageEntity> _messages = [];
  List<MessageEntity> get messages => _messages;

  String content = '';

  void addMessage(Map<String, dynamic> json) {
    _messages.add(MessageEntity.fromJson(json));
  }
}
```


 è¿™é‡Œæˆ‘ä»¬å…ˆä¸è€ƒè™‘è¿™ç§æƒ…å†µï¼Œ`StreamDemo` çš„ `build`å…³äºè¿™éƒ¨åˆ†çš„å¤„ç†æ–¹æ³•å¦‚ä¸‹ï¼Œè¿™é‡Œå¯¹äºå§ `ChatMessageModel` ä¹Ÿå°±ä¸éœ€è¦ä½¿ç”¨ `watch` æ–¹æ³•äº†ï¼Œå®Œå…¨ä¾èµ–äº `StreamProvider` çš„æµæ¨é€æ¥æ›´æ–°ç»„ä»¶ã€‚æ¯æ¬¡å‘é€æ¶ˆæ¯æˆ–æ¥æ”¶æ¶ˆæ¯åï¼Œæ„å»ºæ—¶åœ¨è¿”å›ç»„ä»¶æ ‘å‰å°±æ›´æ–°äº†æ¶ˆæ¯åˆ—è¡¨æ•°æ®äº†ï¼Œå› æ­¤ä¹Ÿèƒ½ä¿è¯æ•°æ®æ˜¯æœ€æ–°çš„ã€‚å…¶å®ï¼Œç›¸å½“äºæˆ‘ä»¬æŠ•æœºå–å·§å®ç°äº†ä¸¤ä¸ª `Provider`ä¹‹é—´çš„æ•°æ®äº¤äº’ã€‚
```dart
@override
Widget build(BuildContext context) {
  Map<String, dynamic>? messageJson = context.watch<Map<String, dynamic>?>();
  if (messageJson != null) {
    context.read<ChatMessageModel>().addMessage(messageJson);
  }
  List<MessageEntity> messages = context.read<ChatMessageModel>().messages;
  // ListView éƒ¨åˆ†
}
```
#### è¿è¡Œæ•ˆæœ
æ¥çœ‹ä¸€ä¸‹è¿è¡Œæ•ˆæœï¼Œæ¨¡æ‹Ÿå™¨çš„å¥½å¤„å°±æ˜¯å¯ä»¥å¼€å¤šä¸ªè°ƒè¯•ã€‚æ•ˆæœæ˜¯å®ç°äº†ï¼Œä¸è¿‡å®é™…å³æ—¶èŠå¤©æ¯”è¿™ä¸ªå¤æ‚å¾ˆå¤šï¼Œè€Œä¸”ä¸€èˆ¬ä¹Ÿä¸ä¼šç”¨ `Socket`ï¼Œä½†æ˜¯å¦‚æœ App å†…éƒ¨è¦å®ç°åº”ç”¨æ‰“å¼€åçš„å³æ—¶æ¶ˆæ¯æ¨é€ï¼Œ`WebSocket` æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æºç å·²ç»æäº¤ï¼Œåç«¯å’ŒFlutter ä»£ç åˆ†å¸ƒå¦‚ä¸‹ï¼š

- [Flutter Provider éƒ¨åˆ†ä»£ç ï¼ˆnull safety ç‰ˆæœ¬ï¼‰](https://gitee.com/island-coder/flutter-beginner)
- [åç«¯ä»£ç ï¼ˆExpress ç‰ˆæœ¬ï¼‰](https://gitee.com/island-coder/express-api)

![è¿è¡Œæ•ˆæœ](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2485ed082fe47bdb5c9650e0cae7fef~tplv-k3u1fbpfcp-zoom-1.image)

#### æ€»ç»“
Provider éƒ¨åˆ†çš„ä»£ç æˆ‘ä»¬å°±å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»‹ç»å…¶ä»–çš„çŠ¶æ€ç®¡ç†æ’ä»¶ã€‚å›é¡¾ä¸€ä¸‹ Provider ç›¸å…³ç¯‡ç« ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆå››åä¸ƒï¼‰ï¼šä½¿ç”¨ Provider æ”¹é€ ğŸ’©ä¸€æ ·çš„ä»£ç ï¼Œä»£ç é‡é™ä½äº†2/3ï¼](https://juejin.cn/post/6994586098676531231)
- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆå››åå…«ï¼‰ï¼šä½¿ç”¨MultiProviderå®ç°å¤šçŠ¶æ€åŒæ—¶ç®¡ç†](https://juejin.cn/post/6994958494642388999)
- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆå››åä¹ï¼‰ï¼šProvider å¯ä»¥åšåµŒå¥—çŠ¶æ€ç®¡ç†å—ï¼Ÿ](https://juejin.cn/post/6995331566951989261)
- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆäº”åï¼‰ï¼š Providerå®ç°ä¸ç›¸å…³é¡µé¢çŠ¶æ€å…±äº«](https://juejin.cn/post/6995771766551347214)
- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆäº”åä¸‰ï¼‰ï¼šä»¿æ˜é‡‘ä¸ªäººä¸»é¡µï¼Œå­¦ä¹  FutureProvider çŠ¶æ€ç®¡ç†](https://juejin.cn/post/6996816190530142239)
- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆäº”åå››ï¼‰ï¼šProvider ä¹‹ç›‘å¬çŠ¶æ€çš„å±€éƒ¨å˜åŒ–](https://juejin.cn/post/6997165264949215240)
- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆäº”åäº”ï¼‰ï¼šå’Œ Provider ä¸€èµ·ç© WebSocket](https://juejin.cn/post/6997538437897125895)
- [Flutter å…¥é—¨ä¸å®æˆ˜ï¼ˆäº”åå…­ï¼‰ï¼šè®©æ¨¡æ‹Ÿå™¨å’Œå’Œé‚®é€’å‘˜ï¼ˆPostmanï¼‰èŠèŠå¤©](https://juejin.cn/post/6998138798739554317)

å†…å®¹åŸºæœ¬è¦†ç›–äº† Provider çš„ä½¿ç”¨ï¼Œå¦‚æœæƒ³æ·±å…¥ç ”ç©¶çš„ä¹Ÿå¯ä»¥è‡ªè¡Œå»çœ‹å®˜æ–¹ç¤ºä¾‹å’Œæºç ã€‚

---

> æˆ‘æ˜¯å²›ä¸Šç å†œï¼Œå¾®ä¿¡å…¬ä¼—å·åŒåï¼Œè¿™æ˜¯[Flutter å…¥é—¨ä¸å®æˆ˜](https://juejin.cn/column/6960631670378594311)çš„ä¸“æ æ–‡ç« ï¼Œå¯¹åº”æºç è¯·çœ‹è¿™é‡Œï¼š[Flutter å…¥é—¨ä¸å®æˆ˜ä¸“æ æºç ](https://gitee.com/island-coder/flutter-beginner)ã€‚
> 
> ğŸ‘ğŸ»ï¼šè§‰å¾—æœ‰æ”¶è·è¯·ç‚¹ä¸ªèµé¼“åŠ±ä¸€ä¸‹ï¼
> 
> ğŸŒŸï¼šæ”¶è—æ–‡ç« ï¼Œæ–¹ä¾¿å›çœ‹å“¦ï¼
> 
> ğŸ’¬ï¼šè¯„è®ºäº¤æµï¼Œäº’ç›¸è¿›æ­¥ï¼