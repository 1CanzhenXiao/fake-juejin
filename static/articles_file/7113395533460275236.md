---
theme: smartblue
highlight: atom-one-dark
---
## åŸºæœ¬æƒ…å†µ
ä¹‹å‰åœ¨é¡¹ç›®ä¸Šåšå†…å­˜æ³„æ¼ä¼˜åŒ–çš„æ—¶å€™æœ‰ä¸€ä¸ªå…³äºRecyclerViewå†…å­˜æ³„æ¼ï¼Œé¡µé¢ç»“æ„å¦‚å›¾ï¼š


![pic_layer.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d160ddb181c4deba9d41aead7ee5c53~tplv-k3u1fbpfcp-watermark.image?)

LeakCanaryæ•è·çš„å¼•ç”¨é“¾å¦‚ä¸‹

```
â”¬â”€â”€â”€
â”‚ GC Root: Thread object
â”‚
â”œâ”€ java.lang.Thread instance
â”‚    Thread name: 'main'
â”‚    â†“ Thread.threadLocals
â”‚             ~~~~~~~~~~~~
â”œâ”€ java.lang.ThreadLocal$ThreadLocalMap instance
â”‚    â†“ ThreadLocal$ThreadLocalMap.table
â”‚                                 ~~~~~
â”œâ”€ java.lang.ThreadLocal$ThreadLocalMap$Entry[] array
â”‚    â†“ ThreadLocal$ThreadLocalMap$Entry[4]
â”‚                                      ~~~
â”œâ”€ java.lang.ThreadLocal$ThreadLocalMap$Entry instance
â”‚    â†“ ThreadLocal$ThreadLocalMap$Entry.value
â”‚                                       ~~~~~
â”œâ”€ androidx.recyclerview.widget.GapWorker instance
â”‚    â†“ GapWorker.mRecyclerViews
â”‚                ~~~~~~~~~~~~~~
â”œâ”€ java.util.ArrayList instance
â”‚    â†“ ArrayList[0]
â”‚               ~~~
â•°â†’ androidx.recyclerview.widget.RecyclerView instance
```
## æ‰¾å‡ºé—®é¢˜
ä»å¼•ç”¨é“¾å¯ä»¥çœ‹å‡ºå…³é”®ç‚¹åœ¨äºGapWorkerï¼Œé¦–å…ˆçœ‹çœ‹è¿™ä¸ªGapWorker

RecyclerViewåœ¨android 21åŠä»¥ä¸Šç‰ˆæœ¬ä¼šä½¿ç”¨`GapWorker`å®ç°é¢„åŠ è½½æœºåˆ¶ï¼Œåœ¨Recyclerviewçš„`onAttachedToWindow`æ–¹æ³•ä¸­å°è¯•å°†å…¶å®ä¾‹åŒ–ï¼Œå¹¶é€šè¿‡GapWorkerçš„`add`æ–¹æ³•å°†Recyclerviewè‡ªèº«æ·»åŠ åˆ°`GapWoker`çš„æˆå‘˜å˜é‡`mRecyclerViews`é“¾è¡¨ä¸­å»ï¼Œåœ¨`onDetachedFromWindow`ä¼šè°ƒç”¨`GapWorker`çš„`remove`æ–¹æ³•ç§»é™¤å…¶å¯¹è‡ªèº«çš„å¼•ç”¨ï¼Œ`GapWoker`å®ä¾‹ä¿å­˜åœ¨å…¶ç±»é™æ€æˆå‘˜å˜é‡`sGapWorker`ï¼ˆThreadLocalï¼‰ä¸­ï¼Œç¡®ä¿ä¸»çº¿ç¨‹åªæœ‰ä¸€ä¸ªå®ä¾‹

```java
 RecyclerView
 
 @Override
    protected void onAttachedToWindow() {
        ......
        if (ALLOW_THREAD_GAP_WORK) {
          //ä»ThreadLocalä¸­è·å–GapWorkerå®ä¾‹ï¼Œä¸ºnullåˆ™ç›´æ¥åˆ›å»ºä¸€ä¸ª
            mGapWorker = GapWorker.sGapWorker.get();
            if (mGapWorker == null) {
                mGapWorker = new GapWorker();
                Display display = ViewCompat.getDisplay(this);
                float refreshRate = 60.0f;
                if (!isInEditMode() && display != null) {
                    float displayRefreshRate = display.getRefreshRate();
                    if (displayRefreshRate >= 30.0f) {
                        refreshRate = displayRefreshRate;
                    }
                }
                mGapWorker.mFrameIntervalNs = (long) (1000000000 / refreshRate);
              //å°†åˆ›å»ºçš„GapWorkerå®ä¾‹è®¾ç½®åˆ°ThreadLocalä¸­å»
                GapWorker.sGapWorker.set(mGapWorker);
            }
          //æ·»åŠ è‡ªèº«çš„å¼•ç”¨
            mGapWorker.add(this);
        }
    }

 @Override
    protected void onDetachedFromWindow() {
        ......
        if (ALLOW_THREAD_GAP_WORK && mGapWorker != null) {
          //å¼‚å¸¸è‡ªèº«çš„å¼•ç”¨
            mGapWorker.remove(this);
            mGapWorker = null;
        }
    }
```

```java
final class GapWorker implements Runnable {
  ......
    static final ThreadLocal<GapWorker> sGapWorker = new ThreadLocal<>();

    ArrayList<RecyclerView> mRecyclerViews = new ArrayList<>();
  
  	public void add(RecyclerView recyclerView) {
        if (RecyclerView.DEBUG && mRecyclerViews.contains(recyclerView)) {
            throw new IllegalStateException("RecyclerView already present in worker list!");
        }
        mRecyclerViews.add(recyclerView);
    }

    public void remove(RecyclerView recyclerView) {
        boolean removeSuccess = mRecyclerViews.remove(recyclerView);
        if (RecyclerView.DEBUG && !removeSuccess) {
            throw new IllegalStateException("RecyclerView removal failed!");
        }
    }
  ......
```

`GapWoker`å®ä¾‹åˆ›å»ºååœ¨ä¸»çº¿ç¨‹çš„`ThreadLocalMap`ä¸­å°†ä»¥ä¸€ä¸ªkeyä¸º`sGapWorker`ï¼Œvalueä¸ºæ­¤å®ä¾‹çš„Entryä¿å­˜ï¼Œ`GapWoker`ä¸ä¼šä¸»åŠ¨è°ƒç”¨`sGapWorker`ï¼ˆThreadLocalï¼‰çš„`remove`æ–¹æ³•å°†è¿™ä¸ªEntryä»`ThreadLocalMap`ä¸­ç§»é™¤ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸»çº¿ç¨‹å¯¹åº”çš„`ThreadLocalMap`ä¼šä¸€ç›´æŒæœ‰è¿™ä¸ªEntryï¼Œé‚£ä¹ˆè¿™å°±ä¸º`Recyclerview`çš„å†…å­˜æ³„æ¼åˆ›é€ äº†æ¡ä»¶ï¼šåªè¦`GapWorker.add`å’Œ`GapWorker.remove`æ²¡æœ‰æˆå¯¹çš„è°ƒç”¨ï¼Œå°±ä¼šå¯¼è‡´`Recyclerview`ä¸€ç›´è¢«`GapWorker`çš„æˆå‘˜`mRecyclerViews`æŒæœ‰å¼ºå¼•ç”¨ï¼Œå½¢æˆå¼•ç”¨é“¾:

**Thread->ThreadLocalMap->Entry(sGapWorker,GapWokerå®ä¾‹)->mRecyclerViews->Recyclerview->Context**

æ¥ä¸‹æ¥å°±æ˜¯æ‰¾åˆ°é—®é¢˜å‘ç”Ÿçš„åœ°æ–¹äº†ï¼Œé€šè¿‡æ–­ç‚¹å‘ç°`Recyclerview`çš„`onAttachedToWindow`æ–¹æ³•æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œ`onDetachedFromWindow`æ–¹æ³•åªæ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè¿™å°±å¯¼è‡´äº†`GapWorker`çš„`mRecyclerViews`è¿˜ä¿ç•™ç€ä¸€ä¸ªå¯¹`Recyclerview`çš„å¼•ç”¨ï¼Œæ‰€ä»¥æ‰¾åˆ°ä¸ºä»€ä¹ˆ`onAttachedToWindow`å¤šæ‰§è¡Œä¸€æ¬¡å°±æ˜¯é—®é¢˜çš„ç­”æ¡ˆäº†ï¼Œé‚£ä¹ˆé€šå¸¸æƒ…å†µä¸‹å¸ƒå±€é‡Œçš„Viewçš„`onAttachedToWindow`ä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Ÿ

1. `ViewRootImpl`é¦–å¸§ç»˜åˆ¶çš„æ—¶å€™ï¼Œä¼šå±‚å±‚å‘ä¸‹è°ƒç”¨å­viewçš„`dispatchAttachedToWindow`æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šè°ƒç”¨`onAttachedToWindow`æ–¹æ³•
2. å°†å­Viewæ·»åŠ åˆ°çˆ¶ViewGroupä¸­ï¼Œå¹¶ä¸”çˆ¶ViewGroupçš„æˆå‘˜å˜é‡`mAttachInfo`(å®šä¹‰åœ¨Viewä¸­)ä¸ä¸ºç©ºæ—¶ï¼ˆåœ¨`dispatchAttachedToWindow`æ–¹æ³•ä¸­èµ‹å€¼ï¼Œ`dispatchDetachedFromWindow`æ–¹æ³•ä¸­ç½®ç©ºï¼‰ï¼Œviewçš„`dispatchAttachedToWindow`ä¼šè¢«è°ƒç”¨ï¼Œè¿›è€Œè°ƒç”¨åˆ°`onAttachedToWindow`æ–¹æ³•

ä»é¡µé¢çš„ç»“æ„åˆ†æï¼ŒRecyclerviewå±äºFragmentçš„Viewï¼Œè€ŒFragmentä¾é™„åœ¨ViewPagerä¸Šï¼Œåˆ™Fragmentçš„å®ä¾‹åŒ–ç”±ViewPageræ§åˆ¶ï¼Œåœ¨ViewPagerçš„onMeasureæ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°å®ƒä¼šå»åŠ è½½å½“å‰é¡µçš„Fragment

```java
  ViewPager
  
  @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
    	......
    	mInLayout = true;
    	//1 å®ä¾‹åŒ–å½“å‰é¡µFragment
        populate();
        mInLayout = false;
    		......
    }
    
    void populate() {
        populate(mCurItem);
    }

    void populate(int newCurrentItem) {
	  		......
        if (curItem == null && N > 0) {
        //2 åœ¨è¿™é‡Œé¢ä¼šè°ƒç”¨adapterçš„instantiateItemæ–¹æ³•å®ä¾‹åŒ–fragment
        //å¹¶ä¸”å°†ä¼šè°ƒç”¨FragmentManager.beginTransaction()å¯åŠ¨äº‹åŠ¡ï¼Œå°†fragmentçš„attachï¼Œaddç­‰è¡Œä¸ºæ·»åŠ è¿›å»
            curItem = addNewItem(mCurItem, curIndex);
        }
	......
	//3 åœ¨è¿™é‡Œé¢ä¼šæ‰§è¡Œå‰é¢ç”Ÿæˆçš„äº‹åŠ¡ï¼Œå°†fragmentçš„viewæ·»åŠ åˆ°ViewPagerä¸­
	mAdapter.finishUpdate(this);
	...... 
	}
    }
```

åœ¨ä»£ç çš„ç¬¬ä¸‰ç‚¹ä¸­`FragmentManager`æ‰§è¡Œäº‹åŠ¡å°†Fragmentçš„viewæ·»åŠ åˆ°ViewPagerä¸­ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯ä¸Šæ–‡è¯´åˆ°çš„`onAttachedToWindow`æ–¹æ³•è¢«è°ƒç”¨çš„ç¬¬äºŒç§æƒ…å†µã€‚ï¼ˆæ­¤æ—¶ViewPagerå·²ç»åœ¨ç»˜åˆ¶æµç¨‹ä¸­ï¼Œ`mAttachInfo`ä¸ä¸ºç©ºï¼‰

å†çœ‹é¡¹ç›®ä¸­FragmentåŠ è½½viewçš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

```java
 é¡¹ç›®ä¸­çš„Fragment
	override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        val view = inflater.inflate(R.layout.fragment_list, container, true /**é—®é¢˜æ‰€åœ¨*/)
        //è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯LayoutInflator.infalteçš„attachToRootä¸ºtrueæ—¶ï¼Œè¿”å›çš„æ˜¯ä¼ å…¥çš„rootå‚æ•°ï¼Œä¹Ÿå°±container
        //æ­¤å¤„çš„containerå®é™…æ˜¯ViewPagerï¼Œå› æ­¤éœ€è¦å†é€šè¿‡findViewByIdæ‰¾åˆ°R.layout.fragment_listçš„æ ¹viewè¿”å›
        val list = view.findViewById<RecyclerView>(R.id.list)
        return list
    }
```

`inflate`æ–¹æ³•çš„`attachToRoot`å‚æ•°ä¼ é€’äº†trueï¼Œå¯¼è‡´äº†`LayoutInflater`ä¼šè°ƒç”¨`root.addView()`å°†viewæ·»åŠ åˆ°rootï¼ˆä¹Ÿå°±æ˜¯ViewPagerï¼‰ä¸­å»

```java
LayoutInflater
public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) {
	......
	if (root != null && attachToRoot) {
    	root.addView(temp, params);
	}
	......
}
```

```java
ViewGroup
 public void addView(View child, LayoutParams params) {
        addView(child, -1, params);
 }
 
 public void addView(View child, int index, LayoutParams params) {
 	......
 	addViewInner(child, index, params, false);
 }
 
 private void addViewInner(View child, int index, LayoutParams params,
            boolean preventRequestLayout) {
        ......
        //ViewPagerå·²ç»åœ¨measureè¿‡ç¨‹ä¸­ï¼ŒmAttachInfoä¸ä¸ºç©ºï¼Œæ­¤caseä¼šè¿›å…¥
        AttachInfo ai = mAttachInfo;
        if (ai != null && (mGroupFlags & FLAG_PREVENT_DISPATCH_ATTACHED_TO_WINDOW) == 0) {
            ......
            //childä¸ºfragmentä¸­åŠ è½½çš„view
            child.dispatchAttachedToWindow(mAttachInfo, (mViewFlags&VISIBILITY_MASK));
        }
        ......
 }
```

æ¢³ç†ä¸€ä¸‹æµç¨‹ï¼šViewPageråœ¨`onMeasure`ä¸­åŠ è½½Framgentï¼ŒFragmentçš„`onCreateView`ä¸­åŠ è½½viewæ—¶`attachToWindow`ä¼ trueè§¦å‘äº†viewçš„ç¬¬ä¸€æ¬¡`onAttachedToWindow`ï¼Œåœ¨FragmentåŠ è½½å®Œæˆä¹‹åï¼ŒViewPageræ²¡æœ‰åˆ¤æ–­viewçš„çˆ¶Viewæ˜¯å¦ä¸ºè‡ªèº«ï¼Œåˆé€šè¿‡`FragmentManager`å†ä¸€æ¬¡å°†viewæ·»åŠ è¿›æ¥ï¼Œè¿™å°±è§¦å‘äº†viewçš„ç¬¬äºŒæ¬¡`onAttachedToWindow`ï¼Œè‡³æ­¤`Recyclerview`ä¸¤æ¬¡è°ƒç”¨ `mGapWorker.add(this)`å°†è‡ªèº«æ·»åŠ åˆ°`GapWoker`çš„`mRecyclerViews`ä¸­å»ï¼Œåœ¨Activityé€€å‡ºæ—¶ï¼Œ`onDetachedFromWindow`è°ƒç”¨äº†ä¸€æ¬¡ï¼Œåˆ™`mRecyclerViews`è¿˜æ®‹ç•™äº†ä¸€ä¸ªå¯¹`Recyclerview`çš„å¼ºå¼•ç”¨ï¼Œè¿™å°±å¯¼è‡´äº†å†…å­˜æ³„æ¼çš„å‘ç”Ÿã€‚

**è§£å†³æ–¹æ¡ˆï¼šå°†trueæ”¹ä¸ºfalseè§£å†³é—®é¢˜ï¼Œæœ‰æ—¶å€™ä¸èµ·çœ¼çš„å°é”™è¯¯æ€»èƒ½æµªè´¹ä½ å¾ˆå¤šæ—¶é—´ğŸ˜‚**


## æ€è€ƒ
### ThreadLocalMapçš„Entryå¯¹äºKeyä¸æ˜¯å¼±å¼•ç”¨å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ

ä»å¼±å¼•ç”¨çš„å®šä¹‰ä¸Šæ¥çœ‹ï¼Œä¸€ä¸ªå¯¹è±¡è‹¥åªè¢«å¼±å¼•ç”¨æ‰€å¼•ç”¨ï¼Œé‚£ä¹ˆå¯¹è±¡ä¼šè¢«gcå›æ”¶ã€‚ä½†ä»`GapWorker`çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œ`sGapWorker`æ˜¯`static final`ä¿®é¥°çš„ç±»é™æ€æˆå‘˜ï¼Œ`sGapWorker`å¯¹äºå…¶æŒ‡å‘çš„`ThreadLocal`å®ä¾‹æ˜¯å¼ºå¼•ç”¨ï¼Œè¿™å°±å¯¼è‡´äº†`ThreadLocalMap`ä¸­å¯¹åº”çš„Entryçš„Keyä¸ä¼šè¢«gcå›æ”¶ï¼Œé‚£ä¹ˆ`ThreadLocal`ä¸­çš„`get`å’Œ`set`å¯¹keyä¸ºnullçš„Entryç§»é™¤çš„è¾…åŠ©æœºåˆ¶ä¹Ÿæ— æ³•ç”Ÿæ•ˆï¼Œå› æ­¤é™¤äº†ä¸»åŠ¨ç§»é™¤Entryä¹‹å¤–ï¼Œåªèƒ½ç­‰åˆ°ä¸»çº¿ç¨‹é€€å‡ºä¹‹å`GapWorker`æ‰ä¼šè¢«å›æ”¶ï¼Œä½†æ˜¯ä¸»çº¿ç¨‹é€€å‡ºäº†è¿™ä¸ªå›æ”¶å·²ç»æ²¡æœ‰æ„ä¹‰äº†ã€‚

### æ—¢ç„¶è¿™æ ·ä¸ºä»€ä¹ˆEntryçš„Keyè¿˜è¦ä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ 

å‡è®¾keyä½¿ç”¨çš„æ˜¯å¼ºå¼•ç”¨ï¼Œè®¾æƒ³æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¿ç¨‹æ± åˆ›å»ºäº†å¤šä¸ªçº¿ç¨‹ï¼Œä¸”è¿™äº›çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­éƒ½è°ƒç”¨äº†`sGapWorker`çš„`set`æ–¹æ³•è¿›è¡Œèµ‹å€¼ï¼Œè¿™äº›çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä¹‹åä¼šè¢«ç¼“å­˜ï¼Œé‚£ä¹ˆè¿™äº›çº¿ç¨‹çš„`ThreadLocalMap`å¯¹åº”çš„Entryä¸­çš„Keyä¼šå¯¹`sGapWorker`æŒ‡å‘çš„`ThreadLocal`å®ä¾‹æŒæœ‰å¼ºå¼•ç”¨ï¼Œå¯¼è‡´å®ä¾‹æ— æ³•è¢«å›æ”¶å‡ºç°å†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆkeyä½¿ç”¨å¼±å¼•ç”¨å°±èƒ½é¿å…è¿™ç§é—®é¢˜ã€‚

### æ—¢ç„¶è¿™æ ·ä¸ºä»€ä¹ˆEntryçš„Valueä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ 

```java
class Test{
	static final ThreadLocal<GapWorker> sGapWorker = new ThreadLocal<>();
	void A(){
		sGapWorker.set(new GapWorker());
	}
	
	void B(){
		GapWorker gp = sGapWorker.get()
	}
}
```

å‡è®¾valueä½¿ç”¨çš„æ˜¯å¼±å¼•ç”¨ï¼Œè®¾æƒ³æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œé¦–å…ˆè°ƒç”¨`Test`çš„æ–¹æ³•Aï¼Œæ¥ç€å‘ç”Ÿäº†gcï¼Œç”±äºvalueæŒ‡å‘çš„`GapWorker`å¯¹è±¡åªæœ‰valueå¯¹å®ƒçš„å¼±å¼•ç”¨äº†ï¼Œé‚£ä¹ˆå®ƒå°†è¢«å›æ”¶ï¼Œåœ¨è¿™ä¹‹åçš„æŸä¸ªæ—¶é—´è°ƒç”¨äº†æ–¹æ³•Bï¼Œåˆ™è¿™æ—¶å€™è·å–åˆ°çš„å€¼ä¼šæ˜¯nullã€‚å¯è§è¿™ç§æƒ…å†µä¸‹valueä¿å­˜çš„å€¼ç›¸å½“ä¸ç¨³å®šï¼Œéšæ—¶éƒ½å¯èƒ½è¢«å›æ”¶ã€‚

ä½†ç”±äºvalueä½¿ç”¨çš„æ˜¯å¼ºå¼•ç”¨ï¼Œvalueå¼•ç”¨çš„å¯¹è±¡è¿˜æ˜¯å­˜åœ¨ç€å†…å­˜æ³„æ¼çš„å¯èƒ½ï¼ŒThreadLocalçš„setå’Œgetæ–¹æ³•ä¸­ä¹Ÿä¼šå¯¹è¿™äº›keyä¸ºnullçš„Entryè¿›è¡Œæ¸…é™¤ï¼Œä¸è¿‡è¿™æ ·å›æ”¶çš„æ—¶æœºå°±å­˜åœ¨ä¸ç¡®å®šæ€§ï¼Œä¸ºé¿å…valueçš„å†…å­˜æ³„æ¼ï¼Œå°±éœ€è¦æˆ‘ä»¬ä¸»åŠ¨åœ¨é€‚å½“çš„æ—¶å€™è°ƒç”¨`ThreadLocal`çš„`remove`æ–¹æ³•æ¸…é™¤valueçš„å¼•ç”¨
