---
theme: juejin
---
# ç»„ä»¶åŒ–

æœ¬æ–‡ä¸»è¦ä»‹ç»`ç»„ä»¶åŒ–å¸¸ç”¨ä¸‰ç§é€šè®¯æ–¹å¼`.

## å¸¸â½¤çš„ä¸‰ç§ç»„ä»¶åŒ–é€šè®¯æ–¹æ¡ˆ
- ç»„ä»¶åŒ–é€šä¿¡æ–¹æ¡ˆ
    - ç»„ä»¶åŒ–æœ€é‡è¦çš„æ˜¯å…„å¼Ÿæ¨¡å—çš„é€šè®¯
    - å¸¸â½¤çš„ä¸‰ç§æ–¹æ¡ˆ 
       - URL Scheme
       - Target - Action
       - Protocol - Class åŒ¹é…

## URL Schemeè·¯ç”±

- ä½¿Â URLÂ å¤„ç†æœ¬åœ°çš„è·³è½¬
- é€šè¿‡ä¸­é—´å±‚è¿›â¾æ³¨å†ŒÂ &Â è°ƒâ½¤ ï¼ˆloadæ–¹æ³•é‡ŒæŠŠè¢«è°ƒç”¨è€…æ³¨å†Œåˆ°ä¸­é—´å±‚ï¼‰
- æ³¨å†Œè¡¨â½†éœ€ä½¿ç”¨åå°„
- éæ‡’åŠ è½½Â /Â æ³¨å†Œè¡¨çš„ç»´æŠ¤Â /Â å‚æ•°

### URL Schemeè·¯ç”±ç®€å•ç¤ºä¾‹
é€šè¿‡ä¸‹é¢[ç®€å•ç¤ºä¾‹](https://gitlab.com/marry/matinal) å¼•å…¥URL è·¯ç”±
```js
//MTMediator.h --- start
typedef void(^MTMediatorProcessBlock)(NSDictionary *params);

+ (void)registerScheme:(NSString *)scheme processBlock:(MTMediatorProcessBlock)processBlock;

+ (void)openUrl:(NSString *)url params:(NSDictionary *)params;
//MTMediator.h --- end

//MTMediator.m --- start
+ (NSMutableDictionary *)mediatorCache{
Â  Â  static NSMutableDictionary *cacheScheme;
Â  Â  static dispatch_once_t onceToken;
Â  Â  dispatch_once(&onceToken, ^{
Â  Â  Â  Â  cacheScheme = @{}.mutableCopy;
Â  Â  });

Â  Â  return cacheScheme;
}

+ (void)registerScheme:(NSString *)scheme processBlock:(MTMediatorProcessBlock)processBlock{
Â  Â  if (scheme.length > 0 && processBlock) {
Â  Â  Â  Â  [[[self class] mediatorCache] setObject:processBlock forKey:scheme];
Â  Â  }
}

+ (void)openUrl:(NSString *)url params:(NSDictionary *)params{
Â  Â  MTMediatorProcessBlock block = [[[self class] mediatorCache] objectForKey:url];
Â  Â  if (block) {
Â  Â  Â  Â  block(params);
Â  Â  }
}
//MTMediator.m --- end

//æ³¨å†Œ --- start
+ (void)load {
Â  Â  [MTMediator registerScheme:@"detail://" processBlock:^(NSDictionary * _Nonnull params) {
Â  Â  Â  Â  NSString *url = (NSString *)[params objectForKey:@"url"];
Â  Â  Â  Â  UINavigationController *navigationController = (UINavigationController *)[params objectForKey:@"controller"];
Â  Â  Â  Â  MTDetailViewController *controller = [[MTDetailViewController alloc] initWithUrlString:url];
//Â  Â  Â  Â  controller.title = [NSString stringWithFormat:@"%@", @(indexPath.row)];
Â  Â  Â  Â  [navigationController pushViewController:controller animated:YES];
Â  Â  }];
}
//æ³¨å†Œ --- end

//è°ƒç”¨ --- start
//URL Scheme
[MTMediator openUrl:@"detail://" params:@{@"url":item.articleUrl,@"controller":self.navigationController}];
//è°ƒç”¨ --- end
```
> è¯´æ˜ï¼š
> - å‚è€ƒäº†ç³»ç»ŸURL Schemeæœºåˆ¶
> - å‚æ•°ä¼ é€’é€šè¿‡dictionaryï¼Œå¯¹è°ƒç”¨è€…ä¸é€æ˜

ç›®å‰iOSä¸Šå¤§éƒ¨åˆ†è·¯ç”±å·¥å…·éƒ½æ˜¯åŸºäºURLåŒ¹é…çš„ï¼Œæˆ–è€…æ˜¯æ ¹æ®å‘½åçº¦å®šï¼Œç”¨runtimeæ–¹æ³•è¿›è¡ŒåŠ¨æ€è°ƒç”¨

è¿™äº›åŠ¨æ€åŒ–çš„æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œç¼ºç‚¹æ˜¯éœ€è¦ç»´æŠ¤å­—ç¬¦ä¸²è¡¨ï¼Œæˆ–è€…ä¾èµ–äºå‘½åçº¦å®šï¼Œæ— æ³•åœ¨ç¼–è¯‘æ—¶æš´éœ²å‡ºæ‰€æœ‰é—®é¢˜ï¼Œéœ€è¦åœ¨è¿è¡Œæ—¶æ‰èƒ½å‘ç°é”™è¯¯ã€‚

### MGJRouter
URLè·¯ç”±æ–¹å¼ä¸»è¦æ˜¯ä»¥è˜‘è‡è¡—ä¸ºä»£è¡¨çš„çš„[MGJRouter](https%3A%2F%2Fgithub.com%2Fmeili%2FMGJRouter)

å…¶å®ç°æ€è·¯æ˜¯ï¼š

-   Appå¯åŠ¨æ—¶å®ä¾‹åŒ–å„ç»„ä»¶æ¨¡å—ï¼Œç„¶åè¿™äº›ç»„ä»¶å‘`ModuleManager`æ³¨å†Œ`Url`ï¼Œæœ‰äº›æ—¶å€™ä¸éœ€è¦å®ä¾‹åŒ–ï¼Œä½¿ç”¨classæ³¨å†Œ
-   å½“ç»„ä»¶Aéœ€è¦è°ƒç”¨ç»„ä»¶Bæ—¶ï¼Œå‘`ModuleManager`ä¼ é€’URLï¼Œå‚æ•°è·ŸéšURLä»¥GETæ–¹å¼ä¼ é€’ï¼Œç±»ä¼¼openURLã€‚ç„¶åç”±ModuleManagerè´Ÿè´£è°ƒåº¦ç»„ä»¶Bï¼Œæœ€åå®Œæˆä»»åŠ¡ã€‚

```
// 1ã€æ³¨å†ŒæŸä¸ªURL
MGJRouter.registerURLPattern("app://home") { (info) in
    print("info: (info)")
}

//2ã€è°ƒç”¨è·¯ç”±
MGJRouter.openURL("app://home")
```

**URL è·¯ç”±çš„ä¼˜ç‚¹**

-   æé«˜çš„åŠ¨æ€æ€§ï¼Œé€‚åˆç»å¸¸å¼€å±•è¿è¥æ´»åŠ¨çš„appï¼Œä¾‹å¦‚ç”µå•†
-   æ–¹ä¾¿åœ°ç»Ÿä¸€ç®¡ç†å¤šå¹³å°çš„è·¯ç”±è§„åˆ™
-   æ˜“äºé€‚é…URL Scheme

**URl è·¯ç”±çš„ç¼ºç‚¹**

-   ä¼ å‚æ–¹å¼æœ‰é™ï¼Œå¹¶ä¸”æ— æ³•åˆ©ç”¨ç¼–è¯‘å™¨è¿›è¡Œå‚æ•°ç±»å‹æ£€æŸ¥ï¼Œå› æ­¤æ‰€æœ‰çš„å‚æ•°éƒ½æ˜¯é€šè¿‡å­—ç¬¦ä¸²è½¬æ¢è€Œæ¥
-   åªé€‚ç”¨äºç•Œé¢æ¨¡å—ï¼Œä¸é€‚ç”¨äºé€šç”¨æ¨¡å—
-   å‚æ•°çš„æ ¼å¼ä¸æ˜ç¡®ï¼Œæ˜¯ä¸ªçµæ´»çš„ dictionaryï¼Œä¹Ÿéœ€è¦æœ‰ä¸ªåœ°æ–¹å¯ä»¥æŸ¥å‚æ•°æ ¼å¼ã€‚
-   ä¸æ”¯æŒstoryboard
-   ä¾èµ–äºå­—ç¬¦ä¸²ç¡¬ç¼–ç ï¼Œéš¾ä»¥ç®¡ç†ï¼Œè˜‘è‡è¡—åšäº†ä¸ªåå°ä¸“é—¨ç®¡ç†ã€‚
-   æ— æ³•ä¿è¯æ‰€ä½¿ç”¨çš„çš„æ¨¡å—ä¸€å®šå­˜åœ¨
-   è§£è€¦èƒ½åŠ›æœ‰é™ï¼Œurl çš„â€æ³¨å†Œâ€ã€â€å®ç°â€ã€â€ä½¿ç”¨â€å¿…é¡»ç”¨ç›¸åŒçš„å­—ç¬¦è§„åˆ™ï¼Œä¸€æ—¦ä»»ä½•ä¸€æ–¹åšå‡ºä¿®æ”¹éƒ½ä¼šå¯¼è‡´å…¶ä»–æ–¹çš„ä»£ç å¤±æ•ˆï¼Œå¹¶ä¸”é‡æ„éš¾åº¦å¤§

é™¤äº†`MGJRouter`ï¼Œè¿˜æœ‰ä»¥ä¸‹è¿™äº›ä¸‰æ–¹æ¡†æ¶

-   [routable-ios](https%3A%2F%2Fgithub.com%2Fclayallsopp%2Froutable-ios)
-   [JLRoutes](https%3A%2F%2Fgithub.com%2Fjoeldev%2FJLRoutes)
-   [HHRouter](https%3A%2F%2Fgithub.com%2Flightory%2FHHRouter)



## Target - Action

- æŠ½ç¦»ä¸šåŠ¡é€»è¾‘
- é€šè¿‡ä¸­é—´å±‚è¿›è¡Œè°ƒâ½¤
- ä¸­é—´å±‚ä½¿â½¤Â runtimeÂ åå°„Â 
- ä¸­é—´å±‚ä»£ç ä¼˜åŒ–

### Target - Actionç®€å•ç¤ºä¾‹
[ç®€å•ç¤ºä¾‹](https://gitlab.com/marry/matinal)å¼•å…¥

```js
//MTMediator.h
#import <UIKit/UIKit.h>
#import <Foundation/Foundation.h>

NS_ASSUME_NONNULL_BEGIN

@interface MTMediator : NSObject

//target action
+ ( __kindof UIViewController *)detailViewControllerWithUrl:(NSString *)detailUrl;

@end

NS_ASSUME_NONNULL_END

//MTMediator.m
#import "MTMediator.h"

@implementation MTMediator

+ ( __kindof UIViewController *)detailViewControllerWithUrl:(NSString *)detailUrl{
Â  Â  Class detailVC = NSClassFromString(@"MTDetailViewController");
Â  Â  UIViewController *controller = [[detailVC alloc] performSelector:NSSelectorFromString(@"initWithUrlString:") withObject:detailUrl];

    return controller;
}

@end

//è°ƒç”¨ 
//Target - Action
 UIViewController *vc = [MTMediator detailViewControllerWithUrl:item.articleUrl];
 vc.title = @"è¯¦æƒ…å•Š";
 [self.navigationController pushViewController:vc animated:YES];
 
```
> è¯´æ˜ï¼š
> - ç¡¬ç¼–ç æ–¹å¼ï¼ˆç›´æ¥è°ƒç”¨ï¼Œä¸åˆ©äºç»´æŠ¤å’Œæ‰©å±•ï¼‰
> - perform æœ€å¤šèƒ½ä¼ é€’2ä¸ªå‚æ•°ï¼Œå¯ä»¥ä¼ å…¥å­—å…¸é¿å…å‚æ•°è¿‡å¤š \
>   `- (id)performSelector:(SEL)aSelector withObject:(id)object1 withObject:(id)object2; ` 
> - initWithUrlString:æ–¹æ³•å¿…é¡»å®ç° å¦åˆ™æ‰¾ä¸åˆ°selå´©æºƒ
> - ä¸šåŠ¡é€»è¾‘æŸ”åˆåœ¨Mediatorä¸­ï¼Œå¯ä»¥å„ä¸ªæ¨¡å—å†™å„è‡ªçš„MTMediatoræ‰©å±•

### CTMediator
ä¸‰æ–¹æ¡†æ¶å…¶ä¸»è¦çš„ä»£è¡¨æ¡†æ¶æ˜¯[casatwyçš„CTMediator](https%3A%2F%2Fgithub.com%2Fcasatwy%2FCTMediator)


è¿™ä¸ªæ–¹æ¡ˆæ˜¯åŸºäºOCçš„runtimeã€categoryç‰¹æ€§åŠ¨æ€è·å–æ¨¡å—ï¼Œä¾‹å¦‚é€šè¿‡`NSClassFromString`è·å–ç±»å¹¶åˆ›å»ºå®ä¾‹ï¼Œé€šè¿‡`performSelector + NSInvocation`åŠ¨æ€è°ƒç”¨æ–¹æ³•

å…¶å®ç°æ€è·¯æ˜¯ï¼š

-   1ã€åˆ©ç”¨åˆ†ç±»ä¸ºè·¯ç”±æ·»åŠ æ–°æ¥å£ï¼Œåœ¨æ¥å£ä¸­é€šè¿‡å­—ç¬¦ä¸²è·å–å¯¹åº”çš„ç±»
-   2ã€é€šè¿‡runtimeåˆ›å»ºå®ä¾‹ï¼ŒåŠ¨æ€è°ƒç”¨å®ä¾‹çš„æ–¹æ³•

CTMediatorç®€å•ä½¿ç”¨ï¼š
```
//******* 1ã€åˆ†ç±»å®šä¹‰æ–°æ¥å£
extension CTMediator{
    @objc func A_showHome()->UIViewController?{
    
        //åœ¨swiftä¸­ä½¿ç”¨æ—¶ï¼Œéœ€è¦ä¼ å…¥å¯¹åº”é¡¹ç›®çš„targetåç§°ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ°è§†å›¾æ§åˆ¶å™¨
        let params = [
            kCTMediatorParamsKeySwiftTargetModuleName: "CJLBase_Example"
        ]
        //CTMediatoræä¾›çš„performTarget:action:params:shouldCacheTarget:æ–¹æ³• é€šè¿‡ä¼ å…¥nameï¼Œæ‰¾åˆ°å¯¹åº”çš„targerå’Œaction
        if let vc = self.performTarget("A", action: "Extension_HomeViewController", params: params, shouldCacheTarget: false) as? UIViewController{
            return vc
        }
        return nil
    }
}

//******* 2ã€æ¨¡å—æä¾›è€…æä¾›target-actionçš„è°ƒç”¨æ–¹å¼ï¼ˆå¯¹å¤–éœ€è¦åŠ ä¸Špublicå…³é”®å­—ï¼‰
class Target_A: NSObject {
    
    @objc func Action_Extension_HomeViewController(_ params: [String: Any])->UIViewController{
         
        let home = HomeViewController()
        return home
    }

}

//******* 3ã€ä½¿ç”¨
if let vc = CTMediator.sharedInstance().A_showHome() {
            self.navigationController?.pushViewController(vc, animated: true)
        }
```
å…¶æ¨¡å—é—´çš„å¼•ç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cf69a708708485398cd3e3c7eb739f4~tplv-k3u1fbpfcp-zoom-1.image)

**ä¼˜ç‚¹**

-   åˆ©ç”¨ `åˆ†ç±»` å¯ä»¥æ˜ç¡®å£°æ˜æ¥å£ï¼Œè¿›è¡Œç¼–è¯‘æ£€æŸ¥
-   å®ç°æ–¹å¼`è½»é‡`

**ç¼ºç‚¹**

-   éœ€è¦åœ¨`mediator` å’Œ `target`ä¸­é‡æ–°æ·»åŠ æ¯ä¸€ä¸ªæ¥å£ï¼Œæ¨¡å—åŒ–æ—¶ä»£ç è¾ƒä¸ºç¹ç
-   åœ¨ `category` ä¸­ä»ç„¶å¼•å…¥äº†`å­—ç¬¦ä¸²ç¡¬ç¼–ç `ï¼Œå†…éƒ¨ä½¿ç”¨å­—å…¸ä¼ å‚ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿå­˜åœ¨å’Œ URL è·¯ç”±ç›¸åŒçš„é—®é¢˜
-   æ— æ³•ä¿è¯ä½¿ç”¨çš„æ¨¡å—ä¸€å®šå­˜åœ¨ï¼Œtargetåœ¨ä¿®æ”¹åï¼Œä½¿ç”¨è€…åªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½å‘ç°é”™è¯¯
-   å¯èƒ½ä¼šåˆ›å»ºè¿‡å¤šçš„ target ç±»

#### **CTMediatoræºç åˆ†æ**

- é€šè¿‡ä¸Šé¢CTMediatorç®€å•ç¤ºä¾‹çš„åˆ†ç±»æ‰€è°ƒç”¨çš„`performTarget`æ¥åˆ°`CTMediator`ä¸­çš„å…·ä½“å®ç°ï¼Œå³`performTarget:action:params:shouldCacheTarget:`ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¼ å…¥çš„nameï¼Œæ‰¾åˆ°å¯¹åº”çš„`target` å’Œ `action`
```
- (id)performTarget:(NSString *)targetName action:(NSString *)actionName params:(NSDictionary *)params shouldCacheTarget:(BOOL)shouldCacheTarget
{
    if (targetName == nil || actionName == nil) {
        return nil;
    }
    //åœ¨swiftä¸­ä½¿ç”¨æ—¶ï¼Œéœ€è¦ä¼ å…¥å¯¹åº”é¡¹ç›®çš„targetåç§°ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ°è§†å›¾æ§åˆ¶å™¨
    NSString *swiftModuleName = params[kCTMediatorParamsKeySwiftTargetModuleName];
    
    // generate target ç”Ÿæˆtarget
    NSString *targetClassString = nil;
    if (swiftModuleName.length > 0) {
        //swiftä¸­targetæ–‡ä»¶åæ‹¼æ¥
        targetClassString = [NSString stringWithFormat:@"%@.Target_%@", swiftModuleName, targetName];
    } else {
        //OCä¸­targetæ–‡ä»¶åæ‹¼æ¥
        targetClassString = [NSString stringWithFormat:@"Target_%@", targetName];
    }
    //ç¼“å­˜ä¸­æŸ¥æ‰¾target
    NSObject *target = [self safeFetchCachedTarget:targetClassString];
    //ç¼“å­˜ä¸­æ²¡æœ‰target
    if (target == nil) {
        //é€šè¿‡å­—ç¬¦ä¸²è·å–å¯¹åº”çš„ç±»
        Class targetClass = NSClassFromString(targetClassString);
        //åˆ›å»ºå®ä¾‹
        target = [[targetClass alloc] init];
    }

    // generate action ç”Ÿæˆactionæ–¹æ³•åç§°
    NSString *actionString = [NSString stringWithFormat:@"Action_%@:", actionName];
    //é€šè¿‡æ–¹æ³•åå­—ç¬¦ä¸²è·å–å¯¹åº”çš„sel
    SEL action = NSSelectorFromString(actionString);
    
    if (target == nil) {
        // è¿™é‡Œæ˜¯å¤„ç†æ— å“åº”è¯·æ±‚çš„åœ°æ–¹ä¹‹ä¸€ï¼Œè¿™ä¸ªdemoåšå¾—æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥å“åº”çš„targetï¼Œå°±ç›´æ¥returnäº†ã€‚å®é™…å¼€å‘è¿‡ç¨‹ä¸­æ˜¯å¯ä»¥äº‹å…ˆç»™ä¸€ä¸ªå›ºå®šçš„targetä¸“é—¨ç”¨äºåœ¨è¿™ä¸ªæ—¶å€™é¡¶ä¸Šï¼Œç„¶åå¤„ç†è¿™ç§è¯·æ±‚çš„
        [self NoTargetActionResponseWithTargetString:targetClassString selectorString:actionString originParams:params];
        return nil;
    }
    //æ˜¯å¦éœ€è¦ç¼“å­˜
    if (shouldCacheTarget) {
        [self safeSetCachedTarget:target key:targetClassString];
    }
    //æ˜¯å¦å“åº”sel
    if ([target respondsToSelector:action]) {
        //åŠ¨æ€è°ƒç”¨æ–¹æ³•
        return [self safePerformAction:action target:target params:params];
    } else {
        // è¿™é‡Œæ˜¯å¤„ç†æ— å“åº”è¯·æ±‚çš„åœ°æ–¹ï¼Œå¦‚æœæ— å“åº”ï¼Œåˆ™å°è¯•è°ƒç”¨å¯¹åº”targetçš„notFoundæ–¹æ³•ç»Ÿä¸€å¤„ç†
        SEL action = NSSelectorFromString(@"notFound:");
        if ([target respondsToSelector:action]) {
            return [self safePerformAction:action target:target params:params];
        } else {
            // è¿™é‡Œä¹Ÿæ˜¯å¤„ç†æ— å“åº”è¯·æ±‚çš„åœ°æ–¹ï¼Œåœ¨notFoundéƒ½æ²¡æœ‰çš„æ—¶å€™ï¼Œè¿™ä¸ªdemoæ˜¯ç›´æ¥returnäº†ã€‚å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç”¨å‰é¢æåˆ°çš„å›ºå®šçš„targeté¡¶ä¸Šçš„ã€‚
            [self NoTargetActionResponseWithTargetString:targetClassString selectorString:actionString originParams:params];
            @synchronized (self) {
                [self.cachedTarget removeObjectForKey:targetClassString];
            }
            return nil;
        }
    }
}
```
-   è¿›å…¥`safePerformAction:target:params:`å®ç°ï¼Œä¸»è¦æ˜¯é€šè¿‡`invocation`è¿›è¡Œ`å‚æ•°ä¼ é€’+æ¶ˆæ¯è½¬å‘`

```
- (id)safePerformAction:(SEL)action target:(NSObject *)target params:(NSDictionary *)params
{
    //è·å–æ–¹æ³•ç­¾å
    NSMethodSignature* methodSig = [target methodSignatureForSelector:action];
    if(methodSig == nil) {
        return nil;
    }
    //è·å–æ–¹æ³•ç­¾åä¸­çš„è¿”å›ç±»å‹ï¼Œç„¶åæ ¹æ®è¿”å›å€¼å®Œæˆå‚æ•°ä¼ é€’
    const char* retType = [methodSig methodReturnType];
    //voidç±»å‹
    if (strcmp(retType, @encode(void)) == 0) {
        ...
    }
    //...çœç•¥å…¶ä»–ç±»å‹çš„åˆ¤æ–­
}
```

æ›´å¤šå…³äºcasatwyçš„CTMediatorä»‹ç» å¯ä»¥å‚è§[æ­¤ç¯‡æ–‡ç« ](https://www.jianshu.com/p/d5f1a8533d5f)è§£è¯»



## Protocol - Class

- å¢åŠ Â Protocol Wrapperå±‚ ï¼ˆä¸­é—´ä»¶å…ˆæ³¨å†ŒProtocolå’ŒClasså¯¹åº”å…³ç³»ï¼Œå°†`protocol`å’Œå¯¹åº”çš„`ç±»`è¿›è¡Œ`å­—å…¸åŒ¹é…`ï¼‰
- ä¸­é—´ä»¶è¿”å›Â ProtocolÂ å¯¹åº”çš„Â Classï¼Œç„¶å`åŠ¨æ€åˆ›å»ºå®ä¾‹`
- è§£å†³ç¡¬ç¼–ç çš„é—®é¢˜

### Protocol - Classç®€å•ç¤ºä¾‹
[ç®€å•ç¤ºä¾‹](https://gitlab.com/marry/matinal)
```js
//å…·ä½“çš„Protocol
//MTMediator.h --- start
@protocol MTDetailViewControllerProtocol <NSObject>

+ (__kindof UIViewController *)detailViewControllerWithUrl:(NSString *)detailUrl;

@end

@interface MTMediator : NSObject
+ (void)registerProtol:(Protocol *)protocol class:(Class)cls;
+ (Class)classForProtocol:(Protocol *)protocol;
@end
//MTMediator.h --- end

//MTMediator.m --- start
+ (void)registerProtol:(Protocol *)protocol class:(Class)cls{
Â  Â  if (protocol && cls) {
Â  Â  Â  Â  [[[self class] mediatorCache] setObject:cls forKey:NSStringFromProtocol(protocol)];
Â  Â  }
}

+ (Class)classForProtocol:(Protocol *)protocol{
    return [[[self class] mediatorCache] objectForKey:NSStringFromProtocol(protocol)];
}
//MTMediator.m --- end

//è¢«è°ƒç”¨
//MTDetailViewController.h --- start
@protocol MTDetailViewControllerProtocol;

@interface MTDetailViewController : UIViewController<MTDetailViewControllerProtocol>
@end
//MTDetailViewController.h --- end

//MTDetailViewController.m --- start
+ (void)load {
    [MTMediator registerProtol: @protocol(MTDetailViewControllerProtocol) class:[self class]];
}

#pragma mark - MTDetailViewControllerProtocol
+ ( __kindof UIViewController *)detailViewControllerWithUrl:(NSString *)detailUrl{
    return [[MTDetailViewController alloc]initWithUrlString:detailUrl];
}
//MTDetailViewController.m --- end

//è°ƒç”¨
Class cls = [MTMediator classForProtocol: @protocol(MTDetailViewControllerProtocol)];
if ([cls respondsToSelector: @selector(detailViewControllerWithUrl:)]) {
Â  Â  Â  Â  [self.navigationController pushViewController:[cls detailViewControllerWithUrl:item.articleUrl] animated:YES];
}

```
> è¯´æ˜ï¼š
> - è¢«è°ƒç”¨è€…å…ˆåœ¨ä¸­é—´ä»¶æ³¨å†ŒProtocolå’ŒClasså¯¹åº”å…³ç³»ï¼Œå¯¹å¤–åªæš´æ¼Protocol

### **BeeHive**
protocolæ¯”è¾ƒå…¸å‹çš„ä¸‰æ–¹æ¡†æ¶å°±æ˜¯[é˜¿é‡Œçš„BeeHive](https%3A%2F%2Fgithub.com%2Falibaba%2FBeeHive)ã€‚`BeeHive`å€Ÿé‰´äº†Spring Serviceã€Apache DSOçš„æ¶æ„ç†å¿µï¼Œ`é‡‡ç”¨AOP+æ‰©å±•Appç”Ÿå‘½å‘¨æœŸAPI`å½¢å¼ï¼Œå°†`ä¸šåŠ¡åŠŸèƒ½`ã€`åŸºç¡€åŠŸèƒ½`æ¨¡å—ä»¥æ¨¡å—æ–¹å¼ä»¥è§£å†³å¤§å‹åº”ç”¨ä¸­çš„å¤æ‚é—®é¢˜ï¼Œå¹¶è®©`æ¨¡å—ä¹‹é—´ä»¥Serviceå½¢å¼è°ƒç”¨`ï¼Œå°†å¤æ‚é—®é¢˜åˆ‡åˆ†ï¼Œä»¥AOPæ–¹å¼æ¨¡å—åŒ–æœåŠ¡ã€‚


**BeeHive æ ¸å¿ƒæ€æƒ³**

-   1ã€å„ä¸ªæ¨¡å—é—´è°ƒç”¨ä»ç›´æ¥è°ƒç”¨å¯¹åº”æ¨¡å—ï¼Œå˜æˆè°ƒç”¨`Service`çš„å½¢å¼ï¼Œé¿å…äº†ç›´æ¥ä¾èµ–ã€‚
-   2ã€Appç”Ÿå‘½å‘¨æœŸçš„åˆ†å‘ï¼Œå°†è€¦åˆåœ¨`AppDelegate`ä¸­é€»è¾‘æ‹†åˆ†ï¼Œæ¯ä¸ªæ¨¡å—ä»¥å¾®åº”ç”¨çš„å½¢å¼ç‹¬ç«‹å­˜åœ¨ã€‚

ç¤ºä¾‹å¦‚ä¸‹:
```
//******** 1ã€æ³¨å†Œ
[[BeeHive shareInstance] registerService:@protocol(HomeServiceProtocol) service:[BHViewController class]];

//******** 2ã€ä½¿ç”¨
#import "BHService.h"

id< HomeServiceProtocol > homeVc = [[BeeHive shareInstance] createService:@protocol(HomeServiceProtocol)];
```

**ä¼˜ç‚¹**

-   1ã€åˆ©ç”¨æ¥å£è°ƒç”¨ï¼Œå®ç°äº†å‚æ•°ä¼ é€’æ—¶çš„ç±»å‹å®‰å…¨
-   2ã€ç›´æ¥ä½¿ç”¨æ¨¡å—çš„protocolæ¥å£ï¼Œæ— éœ€å†é‡å¤å°è£…

**ç¼ºç‚¹**

-   1ã€ç”¨æ¡†æ¶æ¥åˆ›å»ºæ‰€æœ‰å¯¹è±¡ï¼Œåˆ›å»ºæ–¹å¼ä¸åŒï¼Œå³ä¸æ”¯æŒå¤–éƒ¨ä¼ å…¥å‚æ•°
-   2ã€ç”¨`OC runtime`åˆ›å»ºå¯¹è±¡ï¼Œä¸æ”¯æŒswift
-   3ã€åªåšäº†`protocol` å’Œ `class` çš„åŒ¹é…ï¼Œä¸æ”¯æŒæ›´å¤æ‚çš„åˆ›å»ºæ–¹å¼ å’Œä¾èµ–æ³¨å…¥
-   4ã€æ— æ³•ä¿è¯æ‰€ä½¿ç”¨çš„protocol ä¸€å®šå­˜åœ¨å¯¹åº”çš„æ¨¡å—ï¼Œä¹Ÿæ— æ³•ç›´æ¥åˆ¤æ–­æŸä¸ªprotocolæ˜¯å¦èƒ½ç”¨äºè·å–æ¨¡å—

é™¤äº†`BeeHive`ï¼Œè¿˜æœ‰[Swinject](https%3A%2F%2Fgithub.com%2FSwinject%2FSwinject)

#### BeeHive æ¨¡å—æ³¨å†Œ

åœ¨`BeeHive`ä¸»è¦æ˜¯é€šè¿‡`BHModuleManager`æ¥ç®¡ç†å„ä¸ªæ¨¡å—çš„ã€‚`BHModuleManager`ä¸­åªä¼šç®¡ç†å·²ç»è¢«æ³¨å†Œè¿‡çš„æ¨¡å—ã€‚

BeeHiveæä¾›äº†ä¸‰ç§ä¸åŒçš„æ³¨å†Œå½¢å¼ï¼Œ`annotation`,`é™æ€plist`ï¼Œ`åŠ¨æ€æ³¨å†Œ`ã€‚Moduleã€Serviceä¹‹é—´æ²¡æœ‰å…³è”ï¼Œæ¯ä¸ªä¸šåŠ¡æ¨¡å—å¯ä»¥å•ç‹¬å®ç°Moduleæˆ–è€…Serviceçš„åŠŸèƒ½ã€‚


##### **Annotationæ–¹å¼æ³¨å†Œ**
è¿™ç§æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡`BeeHiveMod`å®è¿›è¡Œ`Annotation`æ ‡è®°
```
//***** ä½¿ç”¨
BeeHiveMod(ShopModule)

//***** BeeHiveModçš„å®å®šä¹‰
#define BeeHiveMod(name) \
class BeeHive; char * k##name##_mod BeeHiveDATA(BeehiveMods) = ""#name"";

//***** BeeHiveDATAçš„å®å®šä¹‰ 
#define BeeHiveDATA(sectname) __attribute((used, section("__DATA,"#sectname" ")))

//*****  å…¨éƒ¨è½¬æ¢å‡ºæ¥åä¸ºä¸‹é¢çš„æ ¼å¼ ä»¥nameæ˜¯ShopModuleä¸ºä¾‹

char * kShopModule_mod __attribute((used, section("__DATA,""BeehiveMods"" "))) = """ShopModule""";
```

è¿™é‡Œé’ˆå¯¹`__attribute`éœ€è¦è¯´æ˜ä»¥ä¸‹å‡ ç‚¹

-   ç¬¬ä¸€ä¸ªå‚æ•°`used`ï¼šç”¨æ¥ä¿®é¥°å‡½æ•°ï¼Œè¢«usedä¿®é¥°ä»¥åï¼Œæ„å‘³ç€å³ä½¿å‡½æ•°æ²¡æœ‰è¢«å¼•ç”¨ï¼Œåœ¨Releaseä¸‹ä¹Ÿä¸ä¼šè¢«ä¼˜åŒ–ã€‚å¦‚æœä¸åŠ è¿™ä¸ªä¿®é¥°ï¼Œé‚£ä¹ˆReleaseç¯å¢ƒé“¾æ¥å™¨ä¸‹ä¼šå»æ‰æ²¡æœ‰è¢«å¼•ç”¨çš„æ®µã€‚
-   é€šè¿‡ä½¿ç”¨`__attribute__((section("name")))`æ¥æŒ‡æ˜å“ªä¸ªæ®µã€‚æ•°æ®åˆ™ç”¨`__attribute__((used))`æ¥æ ‡è®°ï¼Œé˜²æ­¢é“¾æ¥å™¨ä¼šä¼˜åŒ–åˆ é™¤æœªè¢«ä½¿ç”¨çš„æ®µï¼Œç„¶åå°†æ¨¡å—æ³¨å…¥åˆ°`__DATA`ä¸­

æ­¤æ—¶Moduleå·²ç»è¢«å­˜å‚¨åˆ°Mach-Oæ–‡ä»¶çš„ç‰¹æ®Šæ®µä¸­ï¼Œé‚£ä¹ˆå¦‚ä½•å–å‘¢ï¼Ÿ

-   è¿›å…¥`BHReadConfiguration`æ–¹æ³•ï¼Œä¸»è¦æ˜¯é€šè¿‡`Mach-O`æ‰¾åˆ°å­˜å‚¨çš„æ•°æ®æ®µï¼Œå–å‡ºæ”¾å…¥æ•°ç»„ä¸­
    ```
    NSArray<NSString *>* BHReadConfiguration(char *sectionName,const struct mach_header *mhp)
    {

        NSMutableArray *configs = [NSMutableArray array];
        unsigned long size = 0;
    #ifndef __LP64__
        // æ‰¾åˆ°ä¹‹å‰å­˜å‚¨çš„æ•°æ®æ®µ(Moduleæ‰¾BeehiveModsæ®µ å’Œ Serviceæ‰¾BeehiveServicesæ®µ)çš„ä¸€ç‰‡å†…å­˜
        uintptr_t *memory = (uintptr_t*)getsectiondata(mhp, SEG_DATA, sectionName, &size);
    #else
        const struct mach_header_64 *mhp64 = (const struct mach_header_64 *)mhp;
        uintptr_t *memory = (uintptr_t*)getsectiondata(mhp64, SEG_DATA, sectionName, &size);
    #endif

        unsigned long counter = size/sizeof(void*);
        // æŠŠç‰¹æ®Šæ®µé‡Œé¢çš„æ•°æ®éƒ½è½¬æ¢æˆå­—ç¬¦ä¸²å­˜å…¥æ•°ç»„ä¸­
        for(int idx = 0; idx < counter; ++idx){
            char *string = (char*)memory[idx];
            NSString *str = [NSString stringWithUTF8String:string];
            if(!str)continue;

            BHLog(@"config = %@", str);
            if(str) [configs addObject:str];
        }

        return configs; 
    }
    ```
- æ³¨å†Œçš„`dyld_callback`å›è°ƒå¦‚ä¸‹

    ```js
    static void dyld_callback(const struct mach_header *mhp, intptr_t vmaddr_slide)
    {
        NSArray *mods = BHReadConfiguration(BeehiveModSectName, mhp);
        for (NSString *modName in mods) {
            Class cls;
            if (modName) {
                cls = NSClassFromString(modName);

                if (cls) {
                    [[BHModuleManager sharedManager] registerDynamicModule:cls];
                }
            }
        }

        //register services
        NSArray<NSString *> *services = BHReadConfiguration(BeehiveServiceSectName,mhp);
        for (NSString *map in services) {
            NSData *jsonData =  [map dataUsingEncoding:NSUTF8StringEncoding];
            NSError *error = nil;
            id json = [NSJSONSerialization JSONObjectWithData:jsonData options:0 error:&error];
            if (!error) {
                if ([json isKindOfClass:[NSDictionary class]] && [json allKeys].count) {

                    NSString *protocol = [json allKeys][0];
                    NSString *clsName  = [json allValues][0];

                    if (protocol && clsName) {
                        [[BHServiceManager sharedManager] registerService:NSProtocolFromString(protocol) implClass:NSClassFromString(clsName)];
                    }

                }
            }
        }

    }
    __attribute__((constructor))
    void initProphet() {
        //_dyld_register_func_for_add_imageå‡½æ•°æ˜¯ç”¨æ¥æ³¨å†ŒdyldåŠ è½½é•œåƒæ—¶çš„å›è°ƒå‡½æ•°,åœ¨dyldåŠ è½½é•œåƒæ—¶,ä¼šæ‰§è¡Œæ³¨å†Œè¿‡çš„å›è°ƒå‡½æ•°
        _dyld_register_func_for_add_image(dyld_callback);
    }
    ```
    
    
    
    
    
##### **è¯»å–æœ¬åœ°Pilstæ–‡ä»¶**
-   é¦–å…ˆï¼Œéœ€è¦è®¾ç½®å¥½è·¯å¾„

    ```
    [BHContext shareInstance].moduleConfigName = @"BeeHive.bundle/BeeHive";//å¯é€‰ï¼Œé»˜è®¤ä¸ºBeeHive.bundle/BeeHive.plist
    ```

- åˆ›å»ºplistæ–‡ä»¶ï¼Œ`Plist`æ–‡ä»¶çš„æ ¼å¼ä¹Ÿæ˜¯æ•°ç»„ä¸­åŒ…å«å¤šä¸ªå­—å…¸ã€‚å­—å…¸é‡Œé¢æœ‰ä¸¤ä¸ªKeyï¼Œä¸€ä¸ªæ˜¯`@"moduleLevel"`ï¼Œå¦ä¸€ä¸ªæ˜¯`@"moduleClass"`ã€‚æ³¨æ„`æ ¹`çš„æ•°ç»„çš„åå­—å«`@â€œmoduleClassesâ€`ã€‚\
    ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b28be90c5d6e49a6bbd392cc45eb2242~tplv-k3u1fbpfcp-zoom-1.image)

-   è¿›å…¥`loadLocalModules`æ–¹æ³•ï¼Œä¸»è¦æ˜¯ä»`Plist`é‡Œé¢å–å‡ºæ•°ç»„ï¼Œç„¶åæŠŠæ•°ç»„åŠ å…¥åˆ°`BHModuleInfos`æ•°ç»„é‡Œé¢ã€‚
    ```
    //åˆå§‹åŒ–contextæ—¶ï¼ŒåŠ è½½Moduleså’ŒServices
    -(void)setContext:(BHContext *)context
    {
        _context = context;

        static dispatch_once_t onceToken;
        dispatch_once(&onceToken, ^{
            [self loadStaticServices];
            [self loadStaticModules];
        });
    }
    ğŸ‘‡
    //åŠ è½½modules
    - (void)loadStaticModules
    {
        // è¯»å–æœ¬åœ°plistæ–‡ä»¶é‡Œé¢çš„Moduleï¼Œå¹¶æ³¨å†Œåˆ°BHModuleManagerçš„BHModuleInfosæ•°ç»„ä¸­
        [[BHModuleManager sharedManager] loadLocalModules];
        //æ³¨å†Œæ‰€æœ‰modulesï¼Œåœ¨å†…éƒ¨æ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œæ’åº
        [[BHModuleManager sharedManager] registedAllModules];

    }
    ğŸ‘‡
    - (void)loadLocalModules
    {
        //plistæ–‡ä»¶è·¯å¾„
        NSString *plistPath = [[NSBundle mainBundle] pathForResource:[BHContext shareInstance].moduleConfigName ofType:@"plist"];
        //åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (![[NSFileManager defaultManager] fileExistsAtPath:plistPath]) {
            return;
        }
        //è¯»å–æ•´ä¸ªæ–‡ä»¶[@"moduleClasses" : æ•°ç»„]
        NSDictionary *moduleList = [[NSDictionary alloc] initWithContentsOfFile:plistPath];
        //é€šè¿‡moduleClasses keyè¯»å– æ•°ç»„ [[@"moduleClass":"aaa", @"moduleLevel": @"bbb"], [...]]
        NSArray<NSDictionary *> *modulesArray = [moduleList objectForKey:kModuleArrayKey];
        NSMutableDictionary<NSString *, NSNumber *> *moduleInfoByClass = @{}.mutableCopy;
        //éå†æ•°ç»„
        [self.BHModuleInfos enumerateObjectsUsingBlock:^(NSDictionary * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            [moduleInfoByClass setObject:@1 forKey:[obj objectForKey:kModuleInfoNameKey]];
        }];
        [modulesArray enumerateObjectsUsingBlock:^(NSDictionary * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            if (!moduleInfoByClass[[obj objectForKey:kModuleInfoNameKey]]) {
                //å­˜å‚¨åˆ° BHModuleInfos ä¸­
                [self.BHModuleInfos addObject:obj];
            }
        }];
    }
    ```
##### **loadæ–¹æ³•æ³¨å†Œ**

è¯¥æ–¹æ³•`æ³¨å†ŒModule`å°±æ˜¯åœ¨`Load`æ–¹æ³•é‡Œé¢æ³¨å†ŒModuleçš„ç±»
```
+ (void)load
{
    [BeeHive registerDynamicModule:[self class]];
}
```

-   è¿›å…¥`registerDynamicModule`å®ç°
    ```
    + (void)registerDynamicModule:(Class)moduleClass
    {
        [[BHModuleManager sharedManager] registerDynamicModule:moduleClass];
    }
    ğŸ‘‡
    - (void)registerDynamicModule:(Class)moduleClass
    {
        [self registerDynamicModule:moduleClass shouldTriggerInitEvent:NO];
    }
    ğŸ‘‡
    - (void)registerDynamicModule:(Class)moduleClass
           shouldTriggerInitEvent:(BOOL)shouldTriggerInitEvent
    {
        [self addModuleFromObject:moduleClass shouldTriggerInitEvent:shouldTriggerInitEvent];
    }
    ```
- å’Œ**Annotationæ–¹å¼**æ³¨å†Œçš„`dyld_callback`å›è°ƒä¸€æ ·ï¼Œæœ€ç»ˆä¼šèµ°åˆ°`addModuleFromObject:shouldTriggerInitEvent:`æ–¹æ³•ä¸­

  ```js
    - (void)addModuleFromObject:(id)object
         shouldTriggerInitEvent:(BOOL)shouldTriggerInitEvent
    {
        Class class;
        NSString *moduleName = nil;

        if (object) {
            class = object;
            moduleName = NSStringFromClass(class);
        } else {
            return ;
        }

        __block BOOL flag = YES;
        [self.BHModules enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            if ([obj isKindOfClass:class]) {
                flag = NO;
                *stop = YES;
            }
        }];
        if (!flag) {
            return;
        }

        if ([class conformsToProtocol:@protocol(BHModuleProtocol)]) {
            NSMutableDictionary *moduleInfo = [NSMutableDictionary dictionary];

            BOOL responseBasicLevel = [class instancesRespondToSelector:@selector(basicModuleLevel)];

            int levelInt = 1;

            if (responseBasicLevel) {
                levelInt = 0;
            }

            [moduleInfo setObject:@(levelInt) forKey:kModuleInfoLevelKey];
            if (moduleName) {
                [moduleInfo setObject:moduleName forKey:kModuleInfoNameKey];
            }

            [self.BHModuleInfos addObject:moduleInfo];

            id<BHModuleProtocol> moduleInstance = [[class alloc] init];
            [self.BHModules addObject:moduleInstance];
            [moduleInfo setObject:@(YES) forKey:kModuleInfoHasInstantiatedKey];
            [self.BHModules sortUsingComparator:^NSComparisonResult(id<BHModuleProtocol> moduleInstance1, id<BHModuleProtocol> moduleInstance2) {
                NSNumber *module1Level = @(BHModuleNormal);
                NSNumber *module2Level = @(BHModuleNormal);
                if ([moduleInstance1 respondsToSelector:@selector(basicModuleLevel)]) {
                    module1Level = @(BHModuleBasic);
                }
                if ([moduleInstance2 respondsToSelector:@selector(basicModuleLevel)]) {
                    module2Level = @(BHModuleBasic);
                }
                if (module1Level.integerValue != module2Level.integerValue) {
                    return module1Level.integerValue > module2Level.integerValue;
                } else {
                    NSInteger module1Priority = 0;
                    NSInteger module2Priority = 0;
                    if ([moduleInstance1 respondsToSelector:@selector(modulePriority)]) {
                        module1Priority = [moduleInstance1 modulePriority];
                    }
                    if ([moduleInstance2 respondsToSelector:@selector(modulePriority)]) {
                        module2Priority = [moduleInstance2 modulePriority];
                    }
                    return module1Priority < module2Priority;
                }
            }];
            [self registerEventsByModuleInstance:moduleInstance];

            if (shouldTriggerInitEvent) {
                [self handleModuleEvent:BHMSetupEvent forTarget:moduleInstance withSeletorStr:nil andCustomParam:nil];
                [self handleModulesInitEventForTarget:moduleInstance withCustomParam:nil];
                dispatch_async(dispatch_get_main_queue(), ^{
                    [self handleModuleEvent:BHMSplashEvent forTarget:moduleInstance withSeletorStr:nil andCustomParam:nil];
                });
            }
        }
    }
    ```


loadæ–¹æ³•ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`BH_EXPORT_MODULE`å®ä»£æ›¿
```
#define BH_EXPORT_MODULE(isAsync) \
+ (void)load { [BeeHive registerDynamicModule:[self class]]; } \
-(BOOL)async { return [[NSString stringWithUTF8String:#isAsync] boolValue];}
```
`BH_EXPORT_MODULE`å®é‡Œé¢å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨`æ˜¯å¦å¼‚æ­¥åŠ è½½Moduleæ¨¡å—`ï¼Œå¦‚æœæ˜¯`YES`å°±æ˜¯`å¼‚æ­¥åŠ è½½`ï¼Œå¦‚æœæ˜¯`NO`å°±æ˜¯`åŒæ­¥åŠ è½½`ã€‚

#### BeeHive æ¨¡å—äº‹ä»¶

BeeHiveä¼šç»™æ¯ä¸ªæ¨¡å—æä¾›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç”¨äºä¸BeeHiveå®¿ä¸»ç¯å¢ƒè¿›è¡Œå¿…è¦ä¿¡æ¯äº¤äº’ï¼Œæ„ŸçŸ¥æ¨¡å—ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ã€‚


BeeHiveå„ä¸ªæ¨¡å—ä¼šæ”¶åˆ°ä¸€äº›äº‹ä»¶ã€‚åœ¨`BHModuleManager`ä¸­ï¼Œæ‰€æœ‰çš„äº‹ä»¶è¢«å®šä¹‰æˆäº†`BHModuleEventType`æšä¸¾ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­æœ‰2ä¸ªäº‹ä»¶å¾ˆç‰¹æ®Šï¼Œä¸€ä¸ªæ˜¯`BHMInitEvent`ï¼Œä¸€ä¸ªæ˜¯`BHMTearDownEvent`

```
typedef NS_ENUM(NSInteger, BHModuleEventType)
{
    //è®¾ç½®Moduleæ¨¡å—
    BHMSetupEvent = 0,
    //ç”¨äºåˆå§‹åŒ–Moduleæ¨¡å—ï¼Œä¾‹å¦‚ç¯å¢ƒåˆ¤æ–­ï¼Œæ ¹æ®ä¸åŒç¯å¢ƒè¿›è¡Œä¸åŒåˆå§‹åŒ–
    BHMInitEvent,
    //ç”¨äºæ‹†é™¤Moduleæ¨¡å—
    BHMTearDownEvent,
    BHMSplashEvent,
    BHMQuickActionEvent,
    BHMWillResignActiveEvent,
    BHMDidEnterBackgroundEvent,
    BHMWillEnterForegroundEvent,
    BHMDidBecomeActiveEvent,
    BHMWillTerminateEvent,
    BHMUnmountEvent,
    BHMOpenURLEvent,
    BHMDidReceiveMemoryWarningEvent,
    BHMDidFailToRegisterForRemoteNotificationsEvent,
    BHMDidRegisterForRemoteNotificationsEvent,
    BHMDidReceiveRemoteNotificationEvent,
    BHMDidReceiveLocalNotificationEvent,
    BHMWillPresentNotificationEvent,
    BHMDidReceiveNotificationResponseEvent,
    BHMWillContinueUserActivityEvent,
    BHMContinueUserActivityEvent,
    BHMDidFailToContinueUserActivityEvent,
    BHMDidUpdateUserActivityEvent,
    BHMHandleWatchKitExtensionRequestEvent,
    BHMDidCustomEvent = 1000
    
};
```

ä¸»è¦åˆ†ä¸ºä¸‰ç§

-   1ã€`ç³»ç»Ÿäº‹ä»¶`ï¼šä¸»è¦æ˜¯æŒ‡`Applicationç”Ÿå‘½å‘¨æœŸäº‹ä»¶`!
    ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c61f79d198634510a647998dd3f89070~tplv-k3u1fbpfcp-zoom-1.image)
    ä¸€èˆ¬çš„åšæ³•æ˜¯`AppDelegate`æ”¹ä¸º`ç»§æ‰¿è‡ªBHAppDelegate`
    ```
    @interface TestAppDelegate : BHAppDelegate <UIApplicationDelegate>
    ```
    
2ã€`åº”ç”¨äº‹ä»¶`ï¼šå®˜æ–¹ç»™å‡ºçš„æµç¨‹å›¾ï¼Œå…¶ä¸­`modSetup`ã€`modInit`ç­‰ï¼Œå¯ä»¥ç”¨äºç¼–ç å®ç°å„æ’ä»¶æ¨¡å—çš„è®¾ç½®ä¸åˆå§‹åŒ–ã€‚
    ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19e409df8f7c452abb20a11a733808ae~tplv-k3u1fbpfcp-watermark.image?)

-   3ã€`è‡ªå®šä¹‰äº‹ä»¶`

ä»¥ä¸Šæ‰€æœ‰çš„äº‹ä»¶éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨`BHModuleManager`çš„`triggerEvent:`æ¥å¤„ç†ã€‚
```
- (void)triggerEvent:(NSInteger)eventType
{
    [self triggerEvent:eventType withCustomParam:nil];
    
}
ğŸ‘‡
- (void)triggerEvent:(NSInteger)eventType
     withCustomParam:(NSDictionary *)customParam {
    [self handleModuleEvent:eventType forTarget:nil withCustomParam:customParam];
}
ğŸ‘‡
#pragma mark - module protocol
- (void)handleModuleEvent:(NSInteger)eventType
                forTarget:(id<BHModuleProtocol>)target
          withCustomParam:(NSDictionary *)customParam
{
    switch (eventType) {
            //åˆå§‹åŒ–äº‹ä»¶
        case BHMInitEvent:
            //special
            [self handleModulesInitEventForTarget:nil withCustomParam :customParam];
            break;
            //ææ„äº‹ä»¶
        case BHMTearDownEvent:
            //special
            [self handleModulesTearDownEventForTarget:nil withCustomParam:customParam];
            break;
            //å…¶ä»–3ç±»äº‹ä»¶
        default: {
            NSString *selectorStr = [self.BHSelectorByEvent objectForKey:@(eventType)];
            [self handleModuleEvent:eventType forTarget:nil withSeletorStr:selectorStr andCustomParam:customParam];
        }
            break;
    }
    
}
```

ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥å‘ç°ï¼Œé™¤å»`BHMInitEvent`åˆå§‹åŒ–äº‹ä»¶å’Œ`BHMTearDownEvent`æ‹†é™¤Moduleäº‹ä»¶è¿™ä¸¤ä¸ªç‰¹æ®Šäº‹ä»¶ä»¥å¤–ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½æ˜¯è°ƒç”¨çš„`handleModuleEvent:forTarget:withSeletorStr:andCustomParam:`æ–¹æ³•ï¼Œå…¶å†…éƒ¨å®ç°ä¸»è¦æ˜¯éå† `moduleInstances` å®ä¾‹æ•°ç»„ï¼Œè°ƒç”¨`performSelector:withObject:`æ–¹æ³•å®ç°å¯¹åº”æ–¹æ³•è°ƒç”¨

```
- (void)handleModuleEvent:(NSInteger)eventType
                forTarget:(id<BHModuleProtocol>)target
           withSeletorStr:(NSString *)selectorStr
           andCustomParam:(NSDictionary *)customParam
{
    BHContext *context = [BHContext shareInstance].copy;
    context.customParam = customParam;
    context.customEvent = eventType;
    if (!selectorStr.length) {
        selectorStr = [self.BHSelectorByEvent objectForKey:@(eventType)];
    }
    SEL seletor = NSSelectorFromString(selectorStr);
    if (!seletor) {
        selectorStr = [self.BHSelectorByEvent objectForKey:@(eventType)];
        seletor = NSSelectorFromString(selectorStr);
    }
    NSArray<id<BHModuleProtocol>> *moduleInstances;
    if (target) {
        moduleInstances = @[target];
    } else {
        moduleInstances = [self.BHModulesByEvent objectForKey:@(eventType)];
    }
    //éå† moduleInstances å®ä¾‹æ•°ç»„ï¼Œè°ƒç”¨performSelector:withObject:æ–¹æ³•å®ç°å¯¹åº”æ–¹æ³•è°ƒç”¨
    [moduleInstances enumerateObjectsUsingBlock:^(id<BHModuleProtocol> moduleInstance, NSUInteger idx, BOOL * _Nonnull stop) {
        if ([moduleInstance respondsToSelector:seletor]) {
#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Warc-performSelector-leaks"
            //è¿›è¡Œæ–¹æ³•è°ƒç”¨
            [moduleInstance performSelector:seletor withObject:context];
#pragma clang diagnostic pop
            
            [[BHTimeProfiler sharedTimeProfiler] recordEventTime:[NSString stringWithFormat:@"%@ --- %@", [moduleInstance class], NSStringFromSelector(seletor)]];
            
        }
    }];
}
```

> æ³¨æ„:è¿™é‡Œæ‰€æœ‰çš„`Module`å¿…é¡»æ˜¯éµå¾ª`BHModuleProtocol`çš„ï¼Œå¦åˆ™æ— æ³•æ¥æ”¶åˆ°è¿™äº›äº‹ä»¶çš„æ¶ˆæ¯ã€‚

#### BeeHive Protocolæ³¨å†Œ

åœ¨BeeHiveä¸­æ˜¯é€šè¿‡`BHServiceManager`æ¥ç®¡ç†å„ä¸ª`Protocol`çš„ã€‚`BHServiceManager`ä¸­åªä¼šç®¡ç†å·²ç»`è¢«æ³¨å†Œè¿‡çš„Protocol`ã€‚
    
æ³¨å†Œ`Protocol`çš„æ–¹å¼æ€»å…±æœ‰ä¸‰ç§ï¼Œå’Œæ³¨å†Œ`Module`æ˜¯ä¸€æ ·ä¸€ä¸€å¯¹åº”çš„

##### **Annotationæ–¹å¼æ³¨å†Œ**
```
//****** 1ã€é€šè¿‡BeeHiveServiceå®è¿›è¡ŒAnnotationæ ‡è®°
BeeHiveService(HomeServiceProtocol,BHViewController)

//****** 2ã€å®å®šä¹‰
#define BeeHiveService(servicename,impl) \
class BeeHive; char * k##servicename##_service BeeHiveDATA(BeehiveServices) = "{ ""#servicename"" : ""#impl""}";

//****** 3ã€è½¬æ¢åçš„æ ¼å¼ï¼Œä¹Ÿæ˜¯å°†å…¶å­˜å‚¨åˆ°ç‰¹æ®Šçš„æ®µ
char * kHomeServiceProtocol_service __attribute((used, section("__DATA,""BeehiveServices"" "))) = "{ """HomeServiceProtocol""" : """BHViewController"""}";
```

##### **è¯»å–æœ¬åœ°plistæ–‡ä»¶**
-   é¦–å…ˆåŒModuleä¸€æ ·ï¼Œéœ€è¦å…ˆè®¾ç½®å¥½è·¯å¾„
    ```
    [BHContext shareInstance].serviceConfigName = @"BeeHive.bundle/BHService";
    ```
- è®¾ç½®plistæ–‡ä»¶

    ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a3e0b74eedf4b2dbb64d589a02e1f47~tplv-k3u1fbpfcp-watermark.image?)
    
-   åŒæ ·ä¹Ÿæ˜¯åœ¨`setContext`æ—¶æ³¨å†Œ`services`
    ```
    //åŠ è½½services
    -(void)loadStaticServices
    {
        [BHServiceManager sharedManager].enableException = self.enableException;

        [[BHServiceManager sharedManager] registerLocalServices];

    }
    ğŸ‘‡
    - (void)registerLocalServices
    {
        NSString *serviceConfigName = [BHContext shareInstance].serviceConfigName;
        //è·å–plistæ–‡ä»¶è·¯å¾„
        NSString *plistPath = [[NSBundle mainBundle] pathForResource:serviceConfigName ofType:@"plist"];
        if (!plistPath) {
            return;
        }

        NSArray *serviceList = [[NSArray alloc] initWithContentsOfFile:plistPath];

        [self.lock lock];
        //éå†å¹¶å­˜å‚¨åˆ°allServicesDictä¸­
        for (NSDictionary *dict in serviceList) {
            NSString *protocolKey = [dict objectForKey:@"service"];
            NSString *protocolImplClass = [dict objectForKey:@"impl"];
            if (protocolKey.length > 0 && protocolImplClass.length > 0) {
                [self.allServicesDict addEntriesFromDictionary:@{protocolKey:protocolImplClass}];
            }
        }
        [self.lock unlock];
    }
    ``` 
    
##### **loadæ–¹æ³•æ³¨å†Œ**

åœ¨Loadæ–¹æ³•é‡Œé¢æ³¨å†Œ`Protocol`åè®®ï¼Œä¸»è¦æ˜¯è°ƒç”¨`BeeHive`é‡Œé¢çš„`registerService:service:`å®Œæˆ`protocol`çš„æ³¨å†Œ   
```
+ (void)load
{
   [[BeeHive shareInstance] registerService:@protocol(UserTrackServiceProtocol) service:[BHUserTrackViewController class]];
}
ğŸ‘‡
- (void)registerService:(Protocol *)proto service:(Class) serviceClass
{
    [[BHServiceManager sharedManager] registerService:proto implClass:serviceClass];
}
```
åˆ°æ­¤ï¼Œä¸‰ç§æ–¹å¼æ³¨å†Œå°±å®Œæˆäº†

##### **Protocolçš„è·å–**

`Protocol`ä¸`Module`çš„åŒºåˆ«åœ¨äºï¼Œ`Protocol`æ¯”`Module`å¤šäº†ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥`è¿”å›Protocolå®ä¾‹å¯¹è±¡`

```
- (id)createService:(Protocol *)proto;
{
    return [[BHServiceManager sharedManager] createService:proto];
}
ğŸ‘‡
- (id)createService:(Protocol *)service
{
    return [self createService:service withServiceName:nil];
}
ğŸ‘‡
- (id)createService:(Protocol *)service withServiceName:(NSString *)serviceName {
    return [self createService:service withServiceName:serviceName shouldCache:YES];
}
ğŸ‘‡
- (id)createService:(Protocol *)service withServiceName:(NSString *)serviceName shouldCache:(BOOL)shouldCache {
    if (!serviceName.length) {
        serviceName = NSStringFromProtocol(service);
    }
    id implInstance = nil;
    //åˆ¤æ–­protocolæ˜¯å¦å·²ç»æ³¨å†Œè¿‡
    if (![self checkValidService:service]) {
        if (self.enableException) {
            @throw [NSException exceptionWithName:NSInternalInconsistencyException reason:[NSString stringWithFormat:@"%@ protocol does not been registed", NSStringFromProtocol(service)] userInfo:nil];
        }
        
    }
    
    NSString *serviceStr = serviceName;
    //å¦‚æœæœ‰ç¼“å­˜ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è·å–
    if (shouldCache) {
        id protocolImpl = [[BHContext shareInstance] getServiceInstanceFromServiceName:serviceStr];
        if (protocolImpl) {
            return protocolImpl;
        }
    }
    //è·å–ç±»åï¼Œç„¶åå“åº”ä¸‹å±‚çš„æ–¹æ³•
    Class implClass = [self serviceImplClass:service];
    if ([[implClass class] respondsToSelector:@selector(singleton)]) {
        if ([[implClass class] singleton]) {
            if ([[implClass class] respondsToSelector:@selector(shareInstance)])
                //åˆ›å»ºå•ä¾‹å¯¹è±¡
                implInstance = [[implClass class] shareInstance];
            else
                //åˆ›å»ºå®ä¾‹å¯¹è±¡
                implInstance = [[implClass alloc] init];
            if (shouldCache) {
                //ç¼“å­˜
                [[BHContext shareInstance] addServiceWithImplInstance:implInstance serviceName:serviceStr];
                return implInstance;
            } else {
                return implInstance;
            }
        }
    }
    return [[implClass alloc] init];
}
```

`createService`ä¼šå…ˆæ£€æŸ¥Protocolåè®®æ˜¯å¦æ˜¯æ³¨å†Œè¿‡çš„ã€‚ç„¶åæ¥ç€å–å‡ºå­—å…¸é‡Œé¢å¯¹åº”çš„Classï¼Œå¦‚æœå®ç°äº†`shareInstance`æ–¹æ³•ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ª`å•ä¾‹å¯¹è±¡`ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ª`å®ä¾‹å¯¹è±¡`ã€‚å¦‚æœè¿˜å®ç°äº†singletonï¼Œå°±èƒ½è¿›ä¸€æ­¥çš„æŠŠ`implInstance`å’Œ`serviceStr`å¯¹åº”çš„åŠ åˆ°`BHContext`çš„`servicesByName`å­—å…¸é‡Œé¢`ç¼“å­˜`èµ·æ¥ã€‚è¿™æ ·å°±å¯ä»¥éšç€ä¸Šä¸‹æ–‡ä¼ é€’äº†

-   è¿›å…¥`serviceImplClass`å®ç°ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡º protocolå’Œç±»æ˜¯é€šè¿‡`å­—å…¸`ç»‘å®šçš„ï¼Œ`protocol`ä½œä¸º`key`ï¼Œ`serviceImp`ï¼ˆç±»çš„åå­—ï¼‰ä½œä¸º`value`

    ```
    - (Class)serviceImplClass:(Protocol *)service
    {
        //é€šè¿‡å­—å…¸å°† åè®® å’Œ ç±» ç»‘å®šï¼Œå…¶ä¸­åè®®ä½œä¸ºkeyï¼ŒserviceImpï¼ˆç±»çš„åå­—ï¼‰ä½œä¸ºvalue
        NSString *serviceImpl = [[self servicesDict] objectForKey:NSStringFromProtocol(service)];
        if (serviceImpl.length > 0) {
            return NSClassFromString(serviceImpl);
        }
        return nil;
    }
    ```
    
#### Module & Protocol
è¿™é‡Œç®€å•æ€»ç»“ä¸‹ï¼š

-   å¯¹äº`Module`ï¼šæ•°ç»„å­˜å‚¨
-   å¯¹äº`Protocol`ï¼šé€šè¿‡å­—å…¸å°†`protocol`ä¸ç±»è¿›è¡Œç»‘å®šï¼Œ`key`ä¸º`protocol`ï¼Œ`value`ä¸ºÂ `serviceImp`å³ç±»å

    
#### BeeHiveè¾…åŠ©ç±»
-   `BHContext`ç±»ï¼šæ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå…¶å†…éƒ¨æœ‰ä¸¤ä¸ª`NSMutableDictionary`çš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯`modulesByName` å’Œ `servicesByName`ã€‚è¿™ä¸ªç±»ä¸»è¦ç”¨æ¥ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ã€‚ä¾‹å¦‚åœ¨`application:didFinishLaunchingWithOptions:`çš„æ—¶å€™ï¼Œå°±å¯ä»¥åˆå§‹åŒ–å¤§é‡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
    ```
    //ä¿å­˜ä¿¡æ¯
    [BHContext shareInstance].application = application;
    [BHContext shareInstance].launchOptions = launchOptions;
    [BHContext shareInstance].moduleConfigName = @"BeeHive.bundle/BeeHive";//å¯é€‰ï¼Œé»˜è®¤ä¸ºBeeHive.bundle/BeeHive.plist
    [BHContext shareInstance].serviceConfigName = @"BeeHive.bundle/BHService";
    ```
-   `BHConfig`ç±»ï¼šæ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå…¶å†…éƒ¨æœ‰ä¸€ä¸ª`NSMutableDictionary`ç±»å‹çš„`config`å±æ€§ï¼Œè¯¥å±æ€§ç»´æŠ¤äº†ä¸€äº›åŠ¨æ€çš„ç¯å¢ƒå˜é‡ï¼Œä½œä¸º`BHContext`çš„è¡¥å……å­˜åœ¨
-   `BHTimeProfiler`ç±»ï¼šç”¨æ¥è¿›è¡Œè®¡ç®—æ—¶é—´æ€§èƒ½æ–¹é¢çš„Profiler
-   `BHWatchDog`ç±»ï¼šç”¨æ¥å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œç›‘å¬ä¸»çº¿ç¨‹æ˜¯å¦å µå¡ 
    
    
    
## å‚è€ƒé“¾æ¥

- [BeeHive â€”â€” ä¸€ä¸ªä¼˜é›…ä½†è¿˜åœ¨å®Œå–„ä¸­çš„è§£è€¦æ¡†æ¶](https%3A%2F%2Fhalfrost.com%2Fbeehive%2F)
-   [BeeHiveï¼Œä¸€æ¬¡iOSæ¨¡å—åŒ–è§£è€¦å®è·µ](https%3A%2F%2Fwww.zybuluo.com%2Fpockry%2Fnote%2F657651)  

    
    
--- end --- 

    
    
    
    
    
