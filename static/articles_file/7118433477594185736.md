---
theme: channing-cyan
---
- æ•™ç¨‹åœ°å€:Â https://pincman.com
- è§†é¢‘åœ°å€:Â https://www.bilibili.com/video/BV1mT411u76H?spm_id_from=333.999.0.0
- qq: 1849600177
- qq ç¾¤: 455820533

> æ³¨æ„: æ­¤å¤„æ–‡æ¡£åªèµ·é…åˆä½œç”¨ï¼Œä¸ºäº†æ‚¨çš„èº«å¿ƒæ„‰æ‚¦ï¼Œè¯·çœ‹Bç«™è§†é¢‘æ•™ç¨‹ï¼Œä¸è¦ç›´æ¥ç•¥è¿‡è§†é¢‘ç›´æ¥çœ‹è¿™ä¸ªæ–‡æ¡£ï¼Œè¿™æ ·ä½ å°†ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ğŸ˜„

> å¦ï¼Œæœ¬äººåœ¨æ‰¾å·¥ä½œä¸­ï¼Œå¸Œæœ›èƒ½æœ‰è¿œç¨‹å·¥ä½œåŒ¹é…(æ— æ³•å»å¤–åœ°)ï¼Œæœ‰éœ€è¦çš„è€æ¿å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘çš„ä¸ªäººä»‹ç»ï¼šhttps://pincman.com/about

[postman]: https://www.postman.com/ "postman"
[lodash]: https://www.lodashjs.com/	"lodash"
[cross-env]: https://github.com/kentcdodds/cross-env#readme	"cross-env"
[class-transformer]: https://github.com/typestack/class-transformer	"class-transformer"
[class-validator]: https://github.com/typestack/class-validator	"class-validator"
[typeorm]: https://typeorm.io/ "typeorm"
[nestjs-typeorm]: https://docs.nestjs.com/techniques/database "@nestjs/typeorm"
[@nestjs/platform-fastify]: https://docs.nestjs.com/techniques/performance	"@nestjs/platform-fastify"
[nestjs-swagger]: https://docs.nestjs.com/openapi/introduction "nestjs-swagger"
[fastify-swagger]: https://docs.nestjs.com/openapi/introduction	"fastify-swagger"
[express]: https://expressjs.com/	"express"
[fastify]: https://www.fastify.io/	"fastify"

## å­¦ä¹ ç›®æ ‡

- ç®€å•åœ°æ•´åˆ[nestjs](https://nestjs.com/)æ¡†æ¶ä¸[typeorm][]
- å®ç°åŸºæœ¬çš„*CRUD*æ•°æ®æ“ä½œ
- ä½¿ç”¨[class-validator][]éªŒè¯è¯·æ±‚æ•°æ®
- æ›´æ¢æ›´åŠ å¿«é€Ÿçš„[fastify][]é€‚é…å™¨
- ä½¿ç”¨Thunder Clientå¯¹æµ‹è¯•æ¥å£

## å®‰è£…Mysql

> å®é™…ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®ä½¿ç”¨PostgreSQL,å› ä¸ºæ•™ç¨‹ä»¥å­¦ä¹ ä¸ºä¸»,æ‰€ä»¥ç›´æ¥ä½¿ç”¨ç›¸å¯¹æ¥è¯´æ¯”è¾ƒé€šç”¨å’Œç®€å•çš„Mysql

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…Mysql

> å¦‚æœæœ¬æœºä¸æ˜¯ä½¿ç”¨linux(æ¯”å¦‚ä½¿ç”¨wsl2),è¯·åˆ°[mysql](https://dev.mysql.com/downloads/repo/apt/)å®˜ç½‘ç‚¹å‡»downloadæŒ‰é’®ä¸‹è½½å®‰è£…åŒ…ååœ¨chromeæŸ¥çœ‹ä¸‹è½½åœ°å€ï¼Œç„¶ååœ¨å¼€å‘æœºç”¨`wget`ä¸‹è½½

> å¦‚æœæœ¬æœºä½¿ç”¨MacOS,ä½¿ç”¨`brew install mysql`,å¦‚æœæœ¬æœºä½¿ç”¨Archç³»åˆ—,ä½¿ç”¨`sudo pacman -Syy mysql`

```shell
# ä¸‹è½½é•œåƒåŒ…
cd /usr/local/src
sudo wget sudo wget https://repo.mysql.com/mysql-apt-config_0.8.22-1_all.deb
# æ·»åŠ é•œåƒ(å…¶å®ƒé€‰é¡¹ä¸ç”¨ç®¡ï¼Œç›´æ¥OKå°±å¯ä»¥)
sudo apt-get install ./mysql-apt-config_0.8.22-1_all.deb
# å‡çº§åŒ…åˆ—è¡¨
sudo apt-get update
# å¼€å§‹å®‰è£…ï¼Œè¾“å…¥å¯†ç åï¼Œæœ‰ä¸€ä¸ªå¯†ç éªŒè¯æ–¹å¼ï¼Œå› ä¸ºæ˜¯å¼€å‘ç”¨ï¼Œæ‰€ä»¥é€‰æ‹©ç¬¬äºŒä¸ªå¼±éªŒè¯å³å¯
sudo apt-get install mysql-server 
# åˆå§‹åŒ–,åœ¨æ˜¯å¦åŠ è½½éªŒè¯ç»„ä»¶æ—¶é€‰æ‹©No,åœ¨æ˜¯å¦ç¦ç”¨è¿œç¨‹ç™»å½•æ—¶ä¹Ÿé€‰æ‹©No
sudo mysql_secure_installation
# å› ä¸ºæ˜¯è¿œç¨‹SSHè¿æ¥å¼€å‘æ‰€ä»¥éœ€è¦å¼€å¯è¿œç¨‹æ•°æ®åº“é“¾æ¥ï¼Œå¦‚æœæ˜¯æœ¬åœ°æˆ–è€…wsl2åˆ™ä¸éœ€è¦å¼€å¯
mysql -u root -p 
CREATE USER 'root'@'%' IDENTIFIED BY 'å¯†ç ';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

æ¥ç€ä½¿ç”¨Navicatç­‰å®¢æˆ·ç«¯å°±å¯ä»¥è¿æ¥äº†

## é¢„è£…ä¾èµ–

- [lodash][]æ˜¯å¸¸ç”¨çš„å·¥å…·åº“
- [cross-env][]ç”¨äºè·¨å¹³å°è®¾ç½®ç¯å¢ƒå˜é‡
- [class-transformer][]ç”¨äºå¯¹è¯·æ±‚å’Œè¿”å›ç­‰æ•°æ®è¿›è¡Œåºåˆ—åŒ– 
- [class-validator][]ç”¨äºéªŒè¯è¯·æ±‚`dto`ç­‰
- [typeorm][]ä¸€ä¸ªTSç¼–å†™çš„[node.js][]ORM
- [@nestjs/typeorm][]Nestjsçš„TypeOrmæ•´åˆæ¨¡å—
- [@nestjs/platform-fastify][]Fastifyé€‚é…å™¨,ç”¨äºæ›¿ä»£express
- [nestjs-swagger][]ç”Ÿæˆopen apiæ–‡æ¡£,ç›®å‰æˆ‘ä»¬ä½¿ç”¨å…¶`PartialType`å‡½æ•°æ˜¯`UpdateDto`ä¸­çš„å±æ€§å¯é€‰
- [fastify-swagger][]ç”ŸæˆFastifyçš„Open API

```shell
~ pnpm add class-transformer \
  @nestjs/platform-fastify \
  class-validator \
  lodash \
  @nestjs/swagger \
  fastify-swagger \
  mysql2 \
  typeorm \
  @nestjs/typeorm

 ~ pnpm add @types/lodash cross-env @types/node typescript -D
```

## ç”Ÿå‘½å‘¨æœŸ

è¦åˆç†çš„ç¼–å†™åº”ç”¨å¿…é¡»äº‹å…ˆäº†è§£æ¸…æ¥šæ•´ä¸ªç¨‹åºçš„è®¿é—®æµç¨‹,æœ¬æ•™ç¨‹ä¼šè®²è§£å¦‚ä½•ä¸€æ­¥æ­¥æ¼”è¿›æ¯ä¸€æ¬¡è®¿é—®æµ,ä½œä¸ºç¬¬ä¸€æ­¥è¯¾æ—¶,æˆ‘ä»¬çš„è®¿é—®æµéå¸¸ç®€å•,å¯ä»¥å‚è€ƒä¸‹å›¾

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f99f264a978240c49711c709990d96b3~tplv-k3u1fbpfcp-zoom-1.image)

## æ–‡ä»¶ç»“æ„

æˆ‘ä»¬é€šè¿‡æ•´åˆ[typeorm][]æ¥è¿æ¥mysqlå®ç°ä¸€ä¸ªåŸºæœ¬çš„CRUDåº”ç”¨,é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸‹æ–‡ä»¶ç»“æ„

> å»ºè®®åˆå­¦è€…æ‰‹åŠ¨åˆ›å»ºï¼Œæ²¡å¿…è¦ä½¿ç”¨CLIå»åˆ›å»ºï¼Œè¿™æ ·ç›®å½•å’Œæ–‡ä»¶æ›´åŠ æ¸…æ™°

1. åˆ›å»ºæ¨¡å—
2. ç¼–å†™æ¨¡å‹
3. ç¼–å†™Repository(å¦‚æœæœ‰éœ€è¦çš„è¯)
5. ç¼–å†™æ•°æ®éªŒè¯çš„DTO
6. ç¼–å†™æœåŠ¡
7. ç¼–å†™æ§åˆ¶å™¨
8. åœ¨æ¯ä¸ªä»¥ä¸Šä»£ç å„è‡ªçš„ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ª`index.ts`å¹¶å¯¼å‡ºå®ƒä»¬
9. åœ¨å„è‡ªçš„`Module`é‡Œè¿›è¡Œæ³¨å†Œæä¾›è€…,å¯¼å‡ºç­‰
10. åœ¨`AppModule`ä¸­å¯¼å…¥è¿™ä¸¤ä¸ªæ¨¡å—

ç¼–å†™å¥½ä¹‹åçš„ç›®å½•ç»“æ„å¦‚ä¸‹

```shell
.
â”œâ”€â”€ app.module.ts                           # å¼•å¯¼æ¨¡å—           
â”œâ”€â”€ config                                  # é…ç½®æ–‡ä»¶ç›®å½•
â”‚Â Â  â”œâ”€â”€ database.config.ts                  # æ•°æ®åº“é…ç½®
â”‚Â Â  â””â”€â”€ index.ts
â”œâ”€â”€ main.ts                                 # åº”ç”¨å¯åŠ¨å™¨
â”œâ”€â”€ modules
 Â Â  â”œâ”€â”€ content                             # å†…å®¹æ¨¡å—ç›®å½•
 Â Â  â”‚Â Â  â”œâ”€â”€ content.module.ts               # å†…å®¹æ¨¡å—
 Â Â  â”‚Â Â  â”œâ”€â”€ controllers                     # æ§åˆ¶å™¨
 Â Â  â”‚Â Â  â”œâ”€â”€ dtos                            # DTOè®¿é—®æ•°æ®éªŒè¯
 Â Â  â”‚Â Â  â”œâ”€â”€ entities                        # æ•°æ®å®ä½“æ¨¡å‹
    |   â”œâ”€â”€ index.ts              
 Â Â  â”‚Â Â  â”œâ”€â”€ repositories                    # è‡ªå®šä¹‰Repository
 Â Â  â”‚Â Â  â”œâ”€â”€ services                        # æœåŠ¡
  Â  â””â”€â”€  core
        â”œâ”€â”€ constants.ts                    # å¸¸é‡
        â”œâ”€â”€ core.module.ts                  # æ ¸å¿ƒæ¨¡å—
        â”œâ”€â”€ decorators                      # è£…é¥°å™¨
        â””â”€â”€ types.ts                        # å…¬å…±ç±»å‹
```

## åº”ç”¨ç¼–ç 

åœ¨å¼€å§‹ç¼–ç ä¹‹å‰éœ€è¦å…ˆæ›´æ”¹ä¸€ä¸‹`package.json`å’Œ`nestjs-cli.json`ä¸¤ä¸ªæ–‡ä»¶

åœ¨`package.json`ä¸­ä¿®æ”¹ä¸€ä¸‹å¯åŠ¨å‘½ä»¤,ä»¥ä¾¿æ¯æ¬¡å¯åŠ¨å¯ä»¥è‡ªåŠ¨é…ç½®è¿è¡Œç¯å¢ƒå¹¶å…¼å®¹`windows`ç¯å¢ƒ

```json
"prebuild": "cross-env rimraf dist",
"start": "cross-env NODE_ENV=development nest start",
"start:dev": "cross-env NODE_ENV=development nest start --watch",
"start:debug": "cross-env NODE_ENV=development nest start --debug --watch",
"start:prod": "cross-env NODE_ENV=production node dist/main",
```

ä¸ºäº†åœ¨æ¯æ¬¡é‡æ–°ç¼–è¯‘å‰è‡ªåŠ¨åˆ é™¤ä¸Šæ¬¡çš„äº§å‡º,åœ¨`nestjs-cli.json`ä¸­é…ç½®` "deleteOutDir": true`

### `main.ts`

æŠŠé€‚é…å™¨ç”±[express][]æ¢æˆæ›´å¿«çš„[fastify][],å¹¶æŠŠç›‘å¬çš„IPæ”¹æˆ`0.0.0.0`æ–¹ä¾¿å¤–éƒ¨è®¿é—®.ä¸ºäº†åœ¨ä½¿ç”¨[class-validator][]çš„`DTO`ç±»ä¸­ä¹Ÿå¯ä»¥æ³¨å…¥nestjså®¹å™¨çš„ä¾èµ–,éœ€è¦æ·»åŠ `useContainer`

```typescript
// main.ts
import { NestFactory } from '@nestjs/core';
import {
  FastifyAdapter,
  NestFastifyApplication,
} from '@nestjs/platform-fastify';
import { useContainer } from 'class-validator';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter()
  );
  useContainer(app.select(AppModule), { fallbackOnErrors: true });
  await app.listen(3000,'0.0.0.0');
}
bootstrap();
```
### è¿æ¥é…ç½®

åˆ›å»ºä¸€ä¸ª`src/config/database.config.ts`æ–‡ä»¶

```typescript
export const database: () => TypeOrmModuleOptions = () => ({
    // ...
    // æ­¤å¤„entitesè®¾ç½®ä¸ºç©ºå³å¯,æˆ‘ä»¬ç›´æ¥é€šè¿‡åœ¨æ¨¡å—å†…éƒ¨ä½¿ç”¨`forFeature`æ¥æ³¨å†Œæ¨¡å‹
    // åç»­é­”æ”¹æ¡†æ¶çš„æ—¶å€™,æˆ‘ä»¬ä¼šé€šè¿‡è‡ªå®šä¹‰çš„æ¨¡å—åˆ›å»ºå‡½æ•°æ¥é‡ç½®entities,ä»¥ä¾¿ç»™è‡ªå·±ç¼–å†™çš„CLIä½¿ç”¨
    // æ‰€ä»¥è¿™ä¸ªé…ç½®åé¢ä¼šåˆ é™¤
    entities: [], 
    // è‡ªåŠ¨åŠ è½½æ¨¡å—ä¸­æ³¨å†Œçš„entity
    autoLoadEntities: true,
    // å¯ä»¥åœ¨å¼€å‘ç¯å¢ƒä¸‹åŒæ­¥entityçš„æ•°æ®ç»“æ„åˆ°æ•°æ®åº“
    // åé¢æ•™ç¨‹ä¼šä½¿ç”¨è‡ªå®šä¹‰çš„è¿ç§»å‘½ä»¤æ¥ä»£æ›¿,ä»¥ä¾¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨,æ‰€ä»¥ä»¥åè¿™ä¸ªé€‰é¡¹ä¼šæ°¸ä¹…false
    synchronize: process.env.NODE_ENV !== 'production',
});

```

### `CoreModule`

æ ¸å¿ƒæ¨¡å—ç”¨äºæŒ‚è½½ä¸€äº›å…¨å±€ç±»æœåŠ¡,æ¯”å¦‚æ•´åˆ[typeorm][]çš„``TypeormModule`

**æ³¨æ„**: è¿™é‡Œä¸è¦ä½¿ç”¨`@Global()`è£…é¥°å™¨æ¥æ„å»ºå…¨å±€æ¨¡å—ï¼Œå› ä¸ºåé¢åœ¨`CoreModule`ç±»ä¸­æ·»åŠ ä¸€äº›å…¶å®ƒæ–¹æ³•

è¿”å›å€¼ä¸­æ·»åŠ `global: true`æ¥æ³¨å†Œå…¨å±€æ¨¡å—,å¹¶å¯¼å‡º`metadata`.

```typescript
// src/core/core.module.ts
export class CoreModule {
    public static forRoot(options?: TypeOrmModuleOptions) {
        const imports: ModuleMetadata['imports'] = [TypeOrmModule.forRoot(options)];
        return {
            global: true,
            imports,
            module: CoreModule,
        };
    }
}
```

åœ¨`AppModule`å¯¼å…¥è¯¥æ¨¡å—,å¹¶æ³¨å†Œæ•°æ®åº“è¿æ¥

```typescript
// src/app.module.ts
@Module({
    imports: [CoreModule.forRoot(database())],
  ...
})
export class AppModule {}
```

### è‡ªå®šä¹‰å­˜å‚¨ç±»

ç”±äºåŸæ¥ç”¨äºè‡ªå®šä¹‰Repositoryçš„`@EntityRepository`åœ¨[typeorm][typeorm]0.3ç‰ˆæœ¬åå·²ç»ä¸å¯ç”¨,ç‰¹åˆ«ä¸æ–¹ä¾¿,æ‰€ä»¥æ ¹æ®[è¿™é‡Œçš„ç¤ºä¾‹](https://gist.github.com/anchan828/9e569f076e7bc18daf21c652f7c3d012)æ¥è‡ªå®šä¹‰ä¸€ä¸ª`CustomRepository`è£…é¥°å™¨

```typescript
// src/modules/core/constants.ts
// ä¼ å…¥è£…é¥°å™¨çš„metadataæ•°æ®æ ‡è¯†
export const CUSTOM_REPOSITORY_METADATA = 'CUSTOM_REPOSITORY_METADATA';

// src/modules/core/decorators/repository.decorator.ts
// å®šä¹‰è£…é¥°å™¨
import { CUSTOM_REPOSITORY_METADATA } from '../constants';
export const CustomRepository = <T>(entity: ObjectType<T>): ClassDecorator =>
    SetMetadata(CUSTOM_REPOSITORY_METADATA, entity);

// src/modules/core/decorators/index.ts
export * from './repository.decorator';
```

å®šä¹‰é™æ€æ–¹æ³•ç”¨äºæ³¨å†Œè‡ªå®šä¹‰Repository

```typescript
 public static forRepository<T extends Type<any>>(
        repositories: T[],
        dataSourceName?: string,
    ): DynamicModule {
        const providers: Provider[] = [];

        for (const Repo of repositories) {
            const entity = Reflect.getMetadata(CUSTOM_REPOSITORY_METADATA, Repo);

            if (!entity) {
                continue;
            }

            providers.push({
                inject: [getDataSourceToken(dataSourceName)],
                provide: Repo,
                useFactory: (dataSource: DataSource): typeof Repo => {
                    const base = dataSource.getRepository<ObjectType<any>>(entity);
                    return new Repo(base.target, base.manager, base.queryRunner);
                },
            });
        }

        return {
            exports: providers,
            module: CoreModule,
            providers,
        };
    }
```

###  `ContentModule`

å†…å®¹æ¨¡å—ç”¨äºå­˜æ”¾*CRUD*æ“ä½œçš„é€»è¾‘ä»£ç 

```typescript
// src/modules/content/content.module.ts
@Module({})
export class ContentModule {}
```

åœ¨`AppModule`ä¸­æ³¨å†Œ

```typescript
// src/app.module.ts
@Module({
    imports: [CoreModule.forRoot(database()),ContentModule],
  ...
})
export class AppModule {}
```

#### å®ä½“æ¨¡å‹

åˆ›å»ºä¸€ä¸ª`PostEntity`ç”¨äºæ–‡ç« æ•°æ®è¡¨

`PostEntity`ç»§æ‰¿``BaseEntity`,è¿™æ ·åšæ˜¯ä¸ºäº†æˆ‘ä»¬å¯ä»¥è¿›è¡Œ`ActiveRecord`æ“ä½œ,ä¾‹å¦‚`PostEntity.save(post)`,å› ä¸ºçº¯`DataMapper`çš„æ–¹å¼æœ‰æ—¶å€™ä»£ç ä¼šæ˜¾å¾—å•°å—¦,å…·ä½“è¯·æŸ¥çœ‹[æ­¤å¤„](https://typeorm.io/#/active-record-data-mapper)

`@CreateDateColumn`å’Œ` @UpdateDateColumn`æ˜¯è‡ªåŠ¨å­—æ®µ,ä¼šæ ¹æ®åˆ›å»ºå’Œæ›´æ–°æ•°æ®çš„æ—¶é—´è‡ªåŠ¨äº§ç”Ÿ,å†™å…¥åä¸å¿…å…³æ³¨

```typescript
// src/modules/content/entities/post.entity.ts
// 'content_posts'æ˜¯è¡¨åç§°
@Entity('content_posts')
export class PostEntity extends BaseEntity {
...
    @CreateDateColumn({
        comment: 'åˆ›å»ºæ—¶é—´',
    })
    createdAt!: Date;

    @UpdateDateColumn({
        comment: 'æ›´æ–°æ—¶é—´',
    })
    updatedAt!: Date;
}
```

#### å­˜å‚¨ç±»

æœ¬èŠ‚å­˜å‚¨ç±»æ˜¯ä¸€ä¸ªç©ºç±»,åé¢ä¼šæ·»åŠ å„ç§æ“ä½œæ–¹æ³•

>   è¿™é‡Œç”¨åˆ°æˆ‘ä»¬å‰é¢å®šä¹‰çš„è‡ªå®šä¹‰CustomRepositoryè£…é¥°å™¨

```typescript
// src/modules/content/repositories/post.repository.ts
@CustomRepository(PostEntity)
export class PostRepository extends Repository<PostEntity> {}
```

#### æ³¨å†Œæ¨¡å‹å’Œå­˜å‚¨ç±»

åœ¨ç¼–å†™å¥½`entity`å’Œ`repository`ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡`Typeorm.forFeature`è¿™ä¸ªé™æ€æ–¹æ³•è¿›è¡Œæ³¨å†Œ,å¹¶æŠŠå­˜å‚¨ç±»å¯¼å‡ºä¸ºæä¾›è€…ä»¥ä¾¿åœ¨å…¶å®ƒæ¨¡å—æ³¨å…¥

```typescript
// src/modules/content/content.module.ts
@Module({
    imports: [
        TypeOrmModule.forFeature([PostEntity]),
        // æ³¨å†Œè‡ªå®šä¹‰Repository
        CoreModule.forRepository([PostRepository]),
    ],
     exports: [
        // å¯¼å‡ºè‡ªå®šä¹‰Repository,ä»¥ä¾›å…¶å®ƒæ¨¡å—ä½¿ç”¨
        CoreModule.forRepository([PostRepository]),
    ],
})
export class ContentModule {}
```

#### DTOéªŒè¯

`DTO`é…åˆç®¡é“(PIPE)ç”¨äºæ§åˆ¶å™¨çš„æ•°æ®éªŒè¯,éªŒè¯å™¨åˆ™ä½¿ç”¨[class-validator][]

> class-validatoræ˜¯åŸºäºvalidator.jsçš„å°è£…,æ‰€ä»¥ä¸€äº›è§„åˆ™å¯ä»¥é€šè¿‡validator.jsçš„æ–‡æ¡£æŸ¥æ‰¾,åé¢æ•™ç¨‹ä¸­æˆ‘ä»¬ä¼šç¼–å†™å¤§é‡çš„è‡ªå®šä¹‰çš„éªŒè¯è§„åˆ™,è¿™èŠ‚å…ˆå°è¯•åŸºæœ¬çš„ç”¨æ³•

å…¶åŸºæœ¬çš„ä½¿ç”¨æ–¹æ³•å°±æ˜¯ç»™`DTO`ç±»çš„å±æ€§æ·»åŠ ä¸€ä¸ªéªŒè¯è£…é¥°å™¨,å¦‚ä¸‹

> `groups`é€‰é¡¹ç”¨äºé…ç½®éªŒè¯ç»„

```typescript
// src/modules/content/dtos/create-post.dto.ts
@Injectable()
export class CreatePostDto {
    @MaxLength(255, {
        always: true,
        message: 'æ–‡ç« æ ‡é¢˜é•¿åº¦æœ€å¤§ä¸º$constraint1',
    })
    @IsNotEmpty({ groups: ['create'], message: 'æ–‡ç« æ ‡é¢˜å¿…é¡»å¡«å†™' })
    @IsOptional({ groups: ['update'] })
    title!: string;
    ...
}

```

æ›´æ–°éªŒè¯ç±»`UpdatePostDto`ç»§æ‰¿è‡ª`CreatePostDto`,ä¸ºäº†ä½¿`CreatePostDto`ä¸­çš„å±æ€§å˜æˆå¯é€‰,éœ€è¦ä½¿ç”¨[@nestjs/swagger][]åŒ…ä¸­çš„`PartialType`æ–¹æ³•,è¯·æŸ¥é˜…[æ­¤å¤„](https://docs.nestjs.com/openapi/mapped-types)æ–‡æ¡£

```typescript
// src/modules/content/dtos/update-post.dto.ts
@Injectable()
export class UpdatePostDto extends PartialType(CreatePostDto) {
    @IsUUID(undefined, { groups: ['update'], message: 'æ–‡ç« IDæ ¼å¼é”™è¯¯' })
    @IsDefined({ groups: ['update'], message: 'æ–‡ç« IDå¿…é¡»æŒ‡å®š' })
    id!: string;
}

```

#### æœåŠ¡ç±»

æœåŠ¡ä¸€å…±åŒ…æ‹¬5ä¸ªç®€å•çš„æ–¹æ³•,é€šè¿‡è°ƒç”¨`PostRepository`æ¥æ“ä½œæ•°æ®

```typescript
// src/modules/content/services/post.service.ts
@Injectable()
export class PostService {
    // æ­¤å¤„éœ€è¦æ³¨å…¥`PostRepository`çš„ä¾èµ–
    constructor(private postRepository: PostRepository) {}
    // æŸ¥è¯¢æ–‡ç« åˆ—è¡¨
    async findList() 
    // æŸ¥è¯¢ä¸€ç¯‡æ–‡ç« çš„è¯¦ç»†ä¿¡æ¯
    async findOne(id: string)
    // æ·»åŠ æ–‡ç« 
    async create(data: CreatePostDto)
    // æ›´æ–°æ–‡ç« 
    async update(data: UpdatePostDto)
    // åˆ é™¤æ–‡ç« 
    async delete(id: string)
}

```

#### æ§åˆ¶å™¨

æ§åˆ¶å™¨çš„æ–¹æ³•é€šè¿‡`@GET`,`@POST`,`@PUT`,`@PATCH`,`@Delete`ç­‰è£…é¥°å™¨å¯¹å¤–æä¾›æ¥å£,å¹¶ä¸”é€šè¿‡æ³¨å…¥`PostService`æœåŠ¡æ¥æ“ä½œæ•°æ®.åœ¨æ§åˆ¶å™¨çš„æ–¹æ³•ä¸Šä½¿ç”¨æ¡†æ¶è‡ªå¸¦çš„`ValidationPipe`ç®¡é“æ¥éªŒè¯è¯·æ±‚ä¸­çš„`body`æ•°æ®,`ParseUUIDPipe`æ¥éªŒè¯`params`æ•°æ®

```typescript
// æ§åˆ¶å™¨URLçš„å‰ç¼€
@Controller('posts')
export class PostController {
    constructor(protected postService: PostService) {}

    ...
   // å…¶å®ƒæ–¹æ³•è¯·è‡ªè¡ŒæŸ¥çœ‹æºç 
    @Get(':post')
    async show(@Param('post', new ParseUUIDPipe()) post: string) {
        return this.postService.findOne(post);
    }

    @Post()
    async store(
        @Body(
            new ValidationPipe({
                transform: true,
                forbidUnknownValues: true,
                // ä¸åœ¨é”™è¯¯ä¸­æš´éœ²target
                validationError: { target: false },
                groups: ['create'],
            }),
        )
        data: CreatePostDto,
    ) {
        return this.postService.create(data);
    }
}
```

#### æ³¨å†Œæ§åˆ¶å™¨ç­‰

- ä¸ºäº†åé¢``DTO`ä¸­å¯èƒ½ä¼šå¯¼å…¥æœåŠ¡,éœ€è¦æŠŠ`DTO`,åŒæ ·æ³¨å†Œä¸ºæä¾›è€…å¹¶ä¸”æ”¹é€ ä¸€ä¸‹`main.ts`,æŠŠå®¹å™¨åŠ å…¥åˆ°`class-containter`ä¸­
- `PostService`æœåŠ¡å¯èƒ½åç»­ä¼šè¢«`UserModule`ç­‰å…¶å®ƒæ¨¡å—ä½¿ç”¨,æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬ä¹Ÿç›´æ¥å¯¼å‡º

```typescript
// src/modules/content/content.module.ts
@Module({
    imports: [
        TypeOrmModule.forFeature([PostEntity]),
        // æ³¨å†Œè‡ªå®šä¹‰Repository
        CoreModule.forRepository([PostRepository]),
    ],
    providers: [PostService, CreatePostDto, UpdatePostDto],
    controllers: [PostController],
    exports: [
        PostService,
        // å¯¼å‡ºè‡ªå®šä¹‰Repository,ä»¥ä¾›å…¶å®ƒæ¨¡å—ä½¿ç”¨
        CoreModule.forRepository([PostRepository]),
    ],
})
export class ContentModule {}
```

```typescript
// src/main.ts
...
async function bootstrap() {
    const app = await NestFactory.create<NestFastifyApplication>(
        AppModule,
        new FastifyAdapter(),
    );
    useContainer(app.select(AppModule), { fallbackOnErrors: true });
    await app.listen(3000, '0.0.0.0');
}
```

æœ€åå¯åŠ¨åº”ç”¨åœ¨`Thunder Client`ä¸­æµ‹è¯•æ¥å£
